<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app https://*.jsdelivr.net; 
                 connect-src 'self' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.jsdelivr.net;
                 img-src 'self' data: https://vienkiemsat.cantho.gov.vn https://upload.wikimedia.org blob:;">

    <title>Phần Mềm Quản Lý Đơn Khiếu nại - Tố Cáo</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        
        body {
            font-family: 'Segoe UI', 'Times New Roman', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        }

        header {
            width: 100%;
            padding: 20px;
            background-color: #0408c5;
            color: white;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        
        #login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #E6F7FF; /* Xanh dương nhạt */
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            margin: auto;
            position: absolute;
            top: 55%; /* Tăng từ 50% lên 55% */
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #login-container h2 {
            margin-bottom: 20px;
            color: #D32F2F; /* Đỏ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background-color: #5670e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #login-container button:hover {
            background-color: #5670e6;
        }

        #main-container {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            margin-top: 20px;
        }
        
        .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: calc(100% - 60px);
            gap: 20px;
            padding: 0 20px;
        }
        
        .sidebar {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .main-panel {
            flex: 2;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }
        
        .sidebar button, .main-panel button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            background-color: #5670e6;
            transition: background-color 0.3s;
        }

        .sidebar button:hover, .main-panel button:hover {
            background-color: #5670e6;
        }
        
        .form-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-section.full-width {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }
        
        .form-sub-group {
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #f7f7f7;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9f9f9;
            margin-top: 5px;
        }
        
        .form-group input[type="date"], .form-group input[type="text"] {
            margin-bottom: 5px; 
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            margin-top: 5px;
        }
        
        .can-cu-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .can-cu-item > div:nth-child(4) { /* Cột 4: Văn bản */
            display: flex;
            flex-direction: column;
        }
        
        .can-cu-van-ban-custom {
            margin-top: 5px !important;
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        tr:hover {
            background-color: #e8f5e9;
        }
        
        .table-actions button {
            padding: 5px 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .table-actions td {
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

         .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 600px; 
            width: 90%;
            position: relative;
            max-height: 90vh; 
            overflow-y: auto; 
        }

      
        .modal-content.large-modal {
            max-width: 90%; 
            max-width: 1200px; 
        }
        
        
        #accountsModal .modal-content {
            max-width: 700px; 
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        
        .close-btn:hover, .close-btn:focus {
            color: #000;
        }
        
        .btn-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-start; /* CHỈNH LẠI THÀNH FLEX-START ĐỂ NÚT EXPORT Ở BÊN TRÁI */
        }
        
        .btn-container.modal-footer {
            justify-content: flex-end; /* GIỮ NGUYÊN CHO PHẦN FOOTER MODAL */
        }
        
        .delete-btn {
            background-color: #d32f2f !important;
        }
        
        .delete-btn:hover {
            background-color: #b71c1c !important;
        }
        
        .edit-btn {
            background-color: #1976d2 !important;
        }
        
        .edit-btn:hover {
            background-color: #1565c0 !important;
        }
        
        .proposal-print-btn {
            background-color: #388e3c !important; /* Green color for new print button */
            margin-top: 5px; 
        }
        
        .proposal-print-btn:hover {
            background-color: #2e7d32 !important;
        }
        
        .export-btn { /* ĐỔI TỪ export-proposal-btn sang export-btn và CHỈNH SỬA MÀU SẮC */
            background-color: #5670e6 !important;
        }
        
        .export-btn:hover {
            background-color: #435bce !important;
        }
        
      
        #proposal-content {
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            font-size: 14pt; 
            line-height: 1.5;
        }
        
        #top-right-buttons {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        #account-list li {
            list-style: none;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #account-list li button {
             margin-left: 10px;
             padding: 5px 10px;
             font-size: 12px;
             width: auto;
        }
        .reset-btn {
             background-color: #ff9800 !important;
        }
        .reset-btn:hover {
             background-color: #fb8c00 !important;
        }
        
        /* CSS cho các section động mới */
        .dynamic-section h3 {
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 10px;
            border-bottom: 2px solid #5670e6;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>VIỆN KIỂM SÁT NHÂN DÂN THÀNH PHỐ CẦN THƠ</h1>
        <H2>QUẢN LÝ ĐƠN KHIẾU NẠI - TỐ CÁO</H2>
        <div id="top-right-buttons">
            <button id="account-btn" onclick="showAccountsModal()">Quản lý tài khoản</button>
            <button onclick="showChangePassModal()">Đổi mật khẩu</button> 
            <button onclick="logout()">Đăng xuất</button>
        </div>
    </header>

    <div id="login-container">
        <img src="https://vienkiemsat.cantho.gov.vn/files/images/logo-vks.png" 
             alt="Logo Viện Kiểm Sát" style="width: 100px; margin-bottom: 20px;">
        <h2>Đăng Nhập</h2>
        <input type="text" id="username" placeholder="Tên đăng nhập">
        <input type="password" id="password" placeholder="Mật khẩu">
        <button onclick="login()">Đăng Nhập</button>
        <p><a href="#" onclick="handleForgotPassword()">Quên mật khẩu?</a></p>
    </div>
            
    <div id="main-container">
        <div class="main-content">
            <div class="sidebar">
                <h2>Lưu đơn mới</h2>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_nhan">Ngày nhận đơn:</label>
                        <input type="date" id="ngay_nhan">
                    </div>
                    <div class="form-group">
                        <label for="nguon_don">Nguồn đơn:</label>
                        <select id="nguon_don"></select>
                    </div>
                </div>
                <div class="form-section full-width">
                    <div class="form-group">
                        <label for="ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                        <input type="text" id="ho_ten" onblur="checkDuplicateName()">
                    </div>
                    <div class="form-group">
                        <label for="dia_chi">Địa chỉ:</label>
                        <input type="text" id="dia_chi">
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_ghi">Đơn ghi ngày:</label>
                        <input type="date" id="ngay_ghi">
                    </div>
                    <div class="form-group">
                        <label for="phan_loai">Phân loại:</label>
                        <select id="phan_loai" onchange="capNhatThamQuyenMacDinh()">
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                        </select>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="tham_quyen">Thẩm quyền:</label>
                        <select id="tham_quyen" onchange="updateDynamicFields()">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                            <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                            <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="can_bo_phan_cong">Cán bộ phân công:</label>
                        <input type="text" id="can_bo_phan_cong" readonly>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="chuc_danh">Chức danh:</label>
                        <select id="chuc_danh">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                            <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                            <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                            <option value="Kiểm tra viên">Kiểm tra viên</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chuyen_den">Xử lý/Chuyển đến:</label>
                        <select id="chuyen_den"></select>
                    </div>
                </div>
                <div class="form-section">
                     <div class="form-group">
                        <label for="ngay_chuyen_don">Ngày Xử lý đơn:</label>
                        <input type="date" id="ngay_chuyen_don">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Căn cứ:</label>
                    <div id="can_cu_container"></div>
                    <button onclick="addCanCu()">Thêm căn cứ</button>
                </div>
                <div class="form-group full-width">
                    <label for="noi_dung">Nội dung đơn:</label>
                    <textarea id="noi_dung"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="de_xuat">Đề xuất:</label>
                    <textarea id="de_xuat"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="ket_qua">Kết quả (Xử lý chung):</label>
                    <textarea id="ket_qua"></textarea>
                </div>
                
                <div id="giai_quyet_kn_section" class="dynamic-section full-width" style="display: none;">
                    <h3>Giải quyết khiếu nại thuộc thẩm quyền</h3>
                    
                    <div class="form-sub-group">
                        <label>1. Quyết định phân công:</label>
                        <input type="text" placeholder="Số Quyết định" id="gq_phan_cong_so">
                        <input type="date" placeholder="Ngày Quyết định" id="gq_phan_cong_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="gq_phan_cong_noi_dung"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>2. Kế hoạch xác minh:</label>
                        <input type="text" placeholder="Số Kế hoạch" id="gq_ke_hoach_so">
                        <input type="date" placeholder="Ngày Kế hoạch" id="gq_ke_hoach_ngay">
                        <textarea placeholder="Nội dung Kế hoạch" id="gq_ke_hoach_noi_dung"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>3. Đơn vị phối hợp:</label>
                        <input type="text" placeholder="Số Quyết định/Kế hoạch" id="gq_dv_phoi_hop_so">
                        <input type="date" placeholder="Ngày Quyết định/Kế hoạch" id="gq_dv_phoi_hop_ngay">
                        <textarea placeholder="Nội dung Quyết định/Kế hoạch" id="gq_dv_phoi_hop_noi_dung"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                         <label>4. Đề xuất hướng giải quyết:</label>
                         <textarea placeholder="Nội dung Đề xuất chi tiết" id="gq_de_xuat_chi_tiet"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>5. Quyết định giải quyết khiếu nại (Lần 1):</label>
                        <input type="text" placeholder="Số Quyết định" id="gq_qd_giai_quyet_so">
                        <input type="date" placeholder="Ngày Quyết định" id="gq_qd_giai_quyet_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="gq_qd_giai_quyet_noi_dung"></textarea>
                    </div>
                </div>

                <div id="kiem_sat_gq_don_section" class="dynamic-section full-width" style="display: none;">
                    <h3>Kiểm sát giải quyết đơn (Thẩm quyền Kiểm sát)</h3>
                    
                    <div class="form-sub-group">
                        <label for="ks_chuyen_den_co_quan">Chuyển đến cơ quan nào:</label>
                        <select id="ks_chuyen_den_co_quan">
                            <option value="Chọn">--Chọn cơ quan--</option>
                            <option value="TAND TP.CT">TAND TP.CT</option>
                            <option value="THADS TP.CT">THADS TP.CT</option>
                            <option value="CQCSĐT CA TP.CT">CQCSĐT CA TP.CT</option>
                        </select>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>Quyết định giải quyết khiếu nại:</label>
                        <input type="text" placeholder="Số Quyết định" id="ks_quyet_dinh_so">
                        <input type="date" placeholder="Ngày Quyết định" id="ks_quyet_dinh_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="ks_quyet_dinh_noi_dung"></textarea>
                        <input type="text" placeholder="Cơ quan ban hành" id="ks_quyet_dinh_co_quan">
                    </div>
                </div>
                
                <input type="hidden" id="edit-id">
                <button onclick="saveDon()">Lưu đơn</button>
            </div>

            <div class="main-panel">
                <h2>Danh sách theo dõi đơn</h2>
                <div class="btn-container" style="margin-bottom: 20px;">
                    <button onclick="exportList()">Xuất Danh sách đơn</button>
                    <button onclick="showReportModal()">Xuất Báo cáo Thống kê</button>
                    <button onclick="downloadJSON()">Sao lưu JSON</button>
                    <button class="export-btn" onclick="downloadProposalDoc(currentSelectedId)">Xuất Phiếu Đề Xuất</button>
                    <button class="export-btn" onclick="downloadResultExtractionDoc(currentSelectedId)">Xuất Kết Quả xử lý đơn</button>
                </div>
                <div class="search-bar" style="margin-bottom: 20px;">
                    <input type="text" id="search-text" placeholder="Tìm kiếm theo Họ tên/Cơ quan/Tổ chức..." style="padding: 8px; width: 40%; border: 1px solid #ccc; border-radius: 4px;">
                    <input type="date" id="search-date" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <button class="search-btn" onclick="filterTable()">Tìm Kiếm</button>
                    <button class="reset-btn" onclick="resetFilter()">Xóa Bộ Lọc</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ngày nhận đơn</th>
                            <th>Họ tên /CQ/ TC</th>
                            <th>Nội dung đơn</th>
                            <th>Phân loại</th>
                            <th>Thẩm quyền</th>
                            <th>Xử lý đơn</th> 
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="don-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('accountsModal').style.display='none'">&times;</span>
            <h3>Quản lý Tài khoản</h3>
            <h4>Tạo tài khoản mới</h4>
            <div class="form-section">
                <div class="form-group">
                    <label for="new-username">Tên đăng nhập:</label>
                    <input type="text" id="new-username">
                </div>
                <div class="form-group">
                    <label for="new-password">Mật khẩu:</label>
                    <input type="password" id="new-password">
                </div>
                <div class="form-group">
                    <label for="new-role">Vai trò:</label>
                    <select id="new-role">
                        <option value="admin">Quản trị viên (admin)</option>
                        <option value="manager_TP">Lãnh đạo cấp Thành phố</option>
                        <option value="user_TP">Cán bộ cấp Thành phố</option>
                        <option value="manager_KV">Lãnh đạo cấp Khu vực</option>
                        <option value="user_KV">Cán bộ cấp Khu vực</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-unit">Đơn vị:</label>
                    <select id="new-unit"></select>
                </div>
            </div>
            <button onclick="createAccount()">Tạo tài khoản</button>
            <h4>Danh sách tài khoản</h4>
            <ul id="account-list"></ul>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('reportModal').style.display='none'">&times;</span>
            <h3>Cấu hình Xuất Báo cáo Thống kê</h3>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="report-month">Tháng/Năm báo cáo:</label>
                    <input type="month" id="report-month" value="${new Date().toISOString().slice(0, 7)}">
                </div>
                 <div class="form-group">
                    <label for="report-level">Cấp báo cáo:</label>
                    <select id="report-level">
                        <option value="all">Tất cả (Thành phố & Khu vực)</option>
                        <option value="TP">Cấp Thành phố (TT-KT)</option>
                        <option value="KV">Cấp Khu vực (VKSND KV)</option>
                    </select>
                </div>
            </div>

            <p style="margin-top: 20px;">* Báo cáo sẽ tổng hợp dữ liệu đơn theo tiêu chí đã chọn.</p>
            
            <div class="btn-container modal-footer">
                <button onclick="exportReport()">Tạo & Tải Báo cáo</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
            <h3>Sửa đổi đơn</h3>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_nhan">Ngày nhận đơn:</label>
                    <input type="date" id="sua-ngay_nhan">
                </div>
                <div class="form-group">
                    <label for="sua-nguon_don">Nguồn đơn:</label>
                    <select id="sua-nguon_don"></select>
                </div>
            </div>
            <div class="form-section full-width">
                <div class="form-group">
                    <label for="sua-ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                    <input type="text" id="sua-ho_ten" onblur="checkDuplicateName('sua-')">
                </div>
                <div class="form-group">
                    <label for="sua-dia_chi">Địa chỉ:</label>
                    <input type="text" id="sua-dia_chi">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_ghi">Đơn ghi ngày:</label>
                    <input type="date" id="sua-ngay_ghi">
                </div>
                <div class="form-group">
                    <label for="sua-phan_loai">Phân loại:</label>
                    <select id="sua-phan_loai" onchange="capNhatThamQuyenMacDinh('sua-')">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-tham_quyen">Thẩm quyền:</label>
                    <select id="sua-tham_quyen" onchange="updateDynamicFields('sua-')">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                        <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                        <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-can_bo_phan_cong">Cán bộ phân công:</label>
                    <input type="text" id="sua-can_bo_phan_cong">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-chuc_danh">Chức danh:</label>
                    <select id="sua-chuc_danh">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                        <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                        <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                        <option value="Kiểm tra viên">Kiểm tra viên</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-chuyen_den">Chuyển đến (Xử lý ban đầu):</label>
                    <select id="sua-chuyen_den"></select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_chuyen_don">Ngày chuyển đơn (Xử lý ban đầu):</label>
                    <input type="date" id="sua-ngay_chuyen_don">
                </div>
            </div>
             <div class="form-group full-width">
                <label>Căn cứ:</label>
                <div id="sua-can_cu_container"></div>
                <button onclick="addCanCu('sua-')">Thêm căn cứ</button>
            </div>
            <div class="form-group full-width">
                <label for="sua-noi_dung">Nội dung đơn:</label>
                <textarea id="sua-noi_dung"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-de_xuat">Đề xuất:</label>
                <textarea id="sua-de_xuat"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-ket_qua">Kết quả (Xử lý chung):</label>
                <textarea id="sua-ket_qua"></textarea>
            </div>
            
             <div id="sua-giai_quyet_kn_section" class="dynamic-section full-width" style="display: none;">
                <h3>Giải quyết khiếu nại (Thẩm quyền Giải quyết)</h3>
                
                <div class="form-sub-group">
                    <label>1. Quyết định phân công:</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-gq_phan_cong_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-gq_phan_cong_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-gq_phan_cong_noi_dung"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>2. Kế hoạch xác minh:</label>
                    <input type="text" placeholder="Số Kế hoạch" id="sua-gq_ke_hoach_so">
                    <input type="date" placeholder="Ngày Kế hoạch" id="sua-gq_ke_hoach_ngay">
                    <textarea placeholder="Nội dung Kế hoạch" id="sua-gq_ke_hoach_noi_dung"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>3. Đơn vị phối hợp:</label>
                    <input type="text" placeholder="Số Quyết định/Kế hoạch" id="sua-gq_dv_phoi_hop_so">
                    <input type="date" placeholder="Ngày Quyết định/Kế hoạch" id="sua-gq_dv_phoi_hop_ngay">
                    <textarea placeholder="Nội dung Quyết định/Kế hoạch" id="sua-gq_dv_phoi_hop_noi_dung"></textarea>
                </div>
                
                 <div class="form-sub-group">
                     <label>4. Đề xuất hướng giải quyết:</label>
                     <textarea placeholder="Nội dung Đề xuất chi tiết" id="sua-gq_de_xuat_chi_tiet"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>5. Quyết định giải quyết khiếu nại (Lần 1):</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-gq_qd_giai_quyet_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-gq_qd_giai_quyet_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-gq_qd_giai_quyet_noi_dung"></textarea>
                </div>
            </div>

            <div id="sua-kiem_sat_gq_don_section" class="dynamic-section full-width" style="display: none;">
                <h3>Kiểm sát giải quyết đơn (Thẩm quyền Kiểm sát)</h3>
                
                <div class="form-sub-group">
                    <label for="sua-ks_chuyen_den_co_quan">Chuyển đến cơ quan nào:</label>
                    <select id="sua-ks_chuyen_den_co_quan">
                        <option value="Chọn">--Chọn cơ quan--</option>
                        <option value="TAND TP.CT">TAND TP.CT</option>
                        <option value="THADS TP.CT">THADS TP.CT</option>
                        <option value="CQCSĐT CA TP.CT">CQCSĐT CA TP.CT</option>
                    </select>
                </div>
                
                <div class="form-sub-group">
                    <label>Quyết định giải quyết khiếu nại:</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-ks_quyet_dinh_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-ks_quyet_dinh_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-ks_quyet_dinh_noi_dung"></textarea>
                    <input type="text" placeholder="Cơ quan ban hành" id="sua-ks_quyet_dinh_co_quan">
                </div>
            </div>
            
            <input type="hidden" id="edit-id-modal"> 
            <div class="btn-container modal-footer">
                <button onclick="updateDon()">Cập nhật</button>
            </div>
        </div>
    </div>
    
    <div id="changePassModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('changePassModal').style.display='none'">&times;</span>
            <h3>Đổi mật khẩu</h3>
            <div class="form-group">
                <label for="old-password">Mật khẩu cũ:</label>
                <input type="password" id="old-password">
            </div>
            <div class="form-group">
                <label for="new-password-change">Mật khẩu mới:</label>
                <input type="password" id="new-password-change">
            </div>
            <div class="form-group">
                <label for="confirm-password-change">Xác nhận mật khẩu mới:</label>
                <input type="password" id="confirm-password-change">
            </div>
            <div class="btn-container modal-footer">
                <button onclick="changePassword()">Xác nhận</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. FIREBASE CONFIGURATION & INITIALIZATION (PHẢI THAY THẾ) ---
        // THAY THẾ CHỖ NÀY BẰNG CẤU HÌNH CỦA BẠN
        const firebaseConfig = {
            apiKey: "AIzaSyBvhrOBoJc9-gKuTAXDlPknVdxKecgPH_g",
            authDomain: "quanlydonvks-d7ff9.firebaseapp.com",
            databaseURL: "https://quanlydonvks-d7ff9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quanlydonvks-d7ff9",
            storageBucket: "quanlydonvks-d7ff9.firebasestorage.app",
            messagingSenderId: "209768483000",
            appId: "1:209768483000:web:1eb449ad41840e23334c4d"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- GLOBAL DATA & INITIALIZATION ---
        let accounts = {}; // Dữ liệu tài khoản (tải từ Firebase)
        let dons = []; // Dữ liệu đơn (tải từ Firebase dưới dạng mảng để dễ xử lý)
        let currentUser = null;
        let currentSelectedId = null; // Thêm biến theo dõi đơn đang chọn để dùng cho export

        // Dữ liệu danh mục
        const lookupData = {
            'Nguồn đơn': [
                'Bưu điện', 'Tiếp công dân', 'Các cơ quan Đảng, Nhà nước', 'UBND TPCT', 
                'Cục Điều tra, VKSTC', 'V11, VKSTC', 'V12, VKSTC', 'Các Sở, Ban, Ngành', 
                'Thành ủy'
            ],
            'Chuyển đến': [
                'Lưu đơn', 'Trả đơn', 'Thông báo chỉ dẫn', 'THADS TP.CT', 'THADS KV1','THADS KV2','THADS KV3','THADS KV4','THADS KV5','THADS KV6','THADS KV7', 
                'THADS KV8','THADS KV9','THADS KV10','THADS KV11','THADS KV12','THADS KV13','THADS KV14',
                'TAND TP.CT', 'TAND KV1', 'TAND KV2','TAND KV3','TAND KV4','TAND KV5','TAND KV6','TAND KV7',
                'TAND KV8','TAND KV9','TAND KV10','TAND KV11','TAND KV12','TAND KV13','TAND KV14',
                'CQCSĐT TP.CT', 'Công an phường', 
                'VKSND KV1', 'VKSND KV2', 'VKSND KV3', 'VKSND KV4', 'VKSND KV5', 'VKSND KV6', 'VKSND KV7', 
                'VKSND KV8', 'VKSND KV9', 'VKSND KV10', 'VKSND KV11', 'VKSND KV12', 'VKSND KV13', 'VKSND KV14',
                'Phòng 1', 'Phòng 2', 'Phòng 7', 'Phòng 8', 'Phòng 9', 'Phòng 10', 'Phòng 11', 'Phòng 15'
            ],
            'Đơn vị': [
                'TT-KT', 'VKSND KV1', 'VKSND KV2', 'VKSND KV3', 'VKSND KV4', 'VKSND KV5', 'VKSND KV6', 
                'VKSND KV7', 'VKSND KV8', 'VKSND KV9', 'VKSND KV10', 'VKSND KV11', 'VKSND KV12', 'VKSND KV13', 'VKSND KV14'
            ]
        };
        
        // Danh sách cố định cho trường Văn bản trong Căn cứ
        const vanBanOptionsFinal = [
            'Quy chế số: 222/QĐ-VKSTC ngày 22/6/2023 của VKSNDTC',
            'Bộ Luật Tố tụng Hình sự',
            'Bộ Luật Tố tụng dân sự',
            'Bộ luật Tố tụng hành chính',
            'Luật THADS',
            'Tự điền vào văn bản' 
        ];

        // --- AUTHENTICATION FUNCTIONS ---

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            database.ref('accounts').once('value')
                .then(snapshot => {
                    accounts = snapshot.val() || {}; 
                    if (accounts[username] && accounts[username].password === password) {
                        currentUser = {
                            username: username,
                            role: accounts[username].role,
                            unit: accounts[username].unit
                        };
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('main-container').style.display = 'flex';
                        document.getElementById('can_bo_phan_cong').value = currentUser.username;
                        
                        // Hiển thị/ẩn nút quản lý tài khoản
                        if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                            document.getElementById('account-btn').style.display = 'block';
                        } else {
                            document.getElementById('account-btn').style.display = 'none';
                        }
                        
                        updateTable();
                    } else {
                        alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                    }
                })
                .catch(error => {
                    alert('Lỗi khi đăng nhập: ' + error.message);
                });
        }
        
        // ... (Các hàm logout, showChangePassModal, changePassword, handleForgotPassword, initializeDefaultAccounts, showAccountsModal, populateUnitSelect, loadAccounts, createAccount, deleteAccount, resetPassword, capNhatDonViTheoVaiTro giữ nguyên) ...
        
        function logout() {
            currentUser = null;
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('account-btn').style.display = 'none';
            currentSelectedId = null; // Reset ID đơn đang chọn
        }

        function showChangePassModal() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập trước.');
                return;
            }
            document.getElementById('old-password').value = '';
            document.getElementById('new-password-change').value = '';
            document.getElementById('confirm-password-change').value = '';
            document.getElementById('changePassModal').style.display = 'flex';
        }

        function changePassword() {
            const oldPass = document.getElementById('old-password').value;
            const newPass = document.getElementById('new-password-change').value;
            const confirmPass = document.getElementById('confirm-password-change').value;

            if (!currentUser) return alert('Vui lòng đăng nhập trước.');

            database.ref('accounts/' + currentUser.username).once('value').then(snap => {
                const currentAccount = snap.val();
                if (!currentAccount) return alert('Lỗi: Không tìm thấy thông tin tài khoản.');

                if (oldPass === currentAccount.password) {
                    if (newPass === confirmPass) {
                        if (newPass.length < 3) {
                            alert('Mật khẩu mới phải có ít nhất 3 ký tự.');
                            return;
                        }
                        database.ref('accounts/' + currentUser.username + '/password').set(newPass)
                            .then(() => {
                                alert('Mật khẩu đã được thay đổi thành công!');
                                document.getElementById('changePassModal').style.display = 'none';
                                accounts[currentUser.username].password = newPass;
                            }).catch(error => {
                                alert('Lỗi khi đổi mật khẩu: ' + error.message);
                            });
                    } else {
                        alert('Mật khẩu mới không khớp.');
                    }
                } else {
                    alert('Mật khẩu cũ không đúng.');
                }
            }).catch(error => {
                alert('Lỗi khi kiểm tra mật khẩu: ' + error.message);
            });
        }
        
        function handleForgotPassword() {
             const username = prompt('Vui lòng nhập tên đăng nhập của bạn:');
             if (!username) return;

             database.ref('accounts/' + username).once('value')
                 .then(snapshot => {
                     if (snapshot.exists()) {
                         if (confirm('Hệ thống sẽ đặt lại mật khẩu của bạn về "123". Vui lòng đăng nhập và đổi lại mật khẩu.')) {
                             database.ref('accounts/' + username + '/password').set('123')
                                 .then(() => {
                                     alert('Đã đặt lại mật khẩu thành công!');
                                 }).catch(error => {
                                     alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                                 });
                         }
                     } else {
                         alert('Tên đăng nhập không tồn tại.');
                     }
                 })
                 .catch(error => {
                     alert('Lỗi khi kiểm tra tài khoản: ' + error.message);
                 });
         }

        function initializeDefaultAccounts() {
            database.ref('accounts').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    const defaultAccounts = {
                        "adminct": { "password": "123", "role": "admin", "unit": "TT-KT" },
                        "lanhdaotk": { "password": "123", "role": "manager_TP", "unit": "TT-KT" },
                        "canbotk": { "password": "123", "role": "user_TP", "unit": "TT-KT" }
                    };
                    database.ref('accounts').set(defaultAccounts)
                        .then(() => console.log("Tạo tài khoản mặc định thành công."))
                        .catch(error => console.error("Lỗi khi tạo tài khoản mặc định:", error));
                }
                accounts = snapshot.val() || {};
            });
        }
        
        function showAccountsModal() {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'super_admin')) {
                alert('Bạn không có quyền truy cập chức năng này.');
                return;
            }
            populateUnitSelect('new-unit');
            loadAccounts();
            document.getElementById('accountsModal').style.display = 'flex';
        }
        
        function populateUnitSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="Chọn">--Chọn Đơn vị--</option>';
            lookupData['Đơn vị'].forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                select.appendChild(option);
            });
        }

        function loadAccounts() {
            database.ref('accounts').once('value')
                .then(snapshot => {
                    accounts = snapshot.val() || {};
                    const accountList = document.getElementById('account-list');
                    accountList.innerHTML = '';
                    for (const [username, account] of Object.entries(accounts)) {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${username} (${account.unit} - ${account.role})</span>
                            <div>
                                <button class="reset-btn" onclick="resetPassword('${username}')">Reset Mật khẩu</button>
                                <button class="delete-btn" onclick="deleteAccount('${username}')">Xóa</button>
                            </div>
                        `;
                        accountList.appendChild(li);
                    }
                });
        }

        function createAccount() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const role = document.getElementById('new-role').value;
            const unit = document.getElementById('new-unit').value;

            if (!username || !password || unit === 'Chọn') {
                return alert('Vui lòng nhập đủ Tên đăng nhập, Mật khẩu và chọn Đơn vị.');
            }
            if (accounts[username]) {
                return alert('Tên đăng nhập đã tồn tại.');
            }
            if (password.length < 3) {
                 return alert('Mật khẩu phải có ít nhất 3 ký tự.');
            }

            database.ref('accounts/' + username).set({
                password: password,
                role: role,
                unit: unit
            }).then(() => {
                alert('Tạo tài khoản thành công!');
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
                loadAccounts();
            }).catch(error => {
                alert('Lỗi khi tạo tài khoản: ' + error.message);
            });
        }

        function deleteAccount(username) {
            if (!confirm(`Bạn có chắc chắn muốn xóa tài khoản "${username}"?`)) return;

            database.ref('accounts/' + username).remove()
                .then(() => {
                    alert('Xóa tài khoản thành công!');
                    loadAccounts();
                }).catch(error => {
                    alert('Lỗi khi xóa tài khoản: ' + error.message);
                });
        }

        function resetPassword(username) {
            if (!confirm(`Bạn có chắc chắn muốn đặt lại mật khẩu của tài khoản "${username}" về "123"?`)) return;

            database.ref('accounts/' + username + '/password').set('123')
                .then(() => {
                    alert('Đã đặt lại mật khẩu thành công!');
                }).catch(error => {
                    alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                });
        }
        
        function capNhatDonViTheoVaiTro() {
             const role = document.getElementById('new-role').value;
             const unitSelect = document.getElementById('new-unit');
             
             // Thiết lập danh sách đơn vị
             let availableUnits = lookupData['Đơn vị'];
             
             // Xóa và thêm lại options
             unitSelect.innerHTML = '<option value="Chọn">--Chọn Đơn vị--</option>';
             availableUnits.forEach(unit => {
                 const option = document.createElement('option');
                 option.value = unit;
                 option.textContent = unit;
                 unitSelect.appendChild(option);
             });
             
             // Tự động chọn đơn vị mặc định cho Cán bộ TT-KT
             if (role.includes('_TP')) {
                 unitSelect.value = 'TT-KT';
             } else if (role.includes('_KV')) {
                 // Không chọn mặc định, để người dùng chọn
                 unitSelect.value = 'Chọn'; 
             } else if (role === 'admin') {
                  unitSelect.value = 'TT-KT';
             }
        }


        // --- UTILITY FUNCTIONS ---
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function parseDate(dateString) {
             if (!dateString) return null;
             // Định dạng chuẩn: YYYY-MM-DD
             return dateString;
        }

        function initSelectOptions() {
            ['nguon_don', 'chuyen_den', 'sua-nguon_don', 'sua-chuyen_den'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="Chọn">--Chọn--</option>';
                const key = id.includes('nguon_don') ? 'Nguồn đơn' : 'Chuyển đến';
                lookupData[key].forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
            });
             populateUnitSelect('new-unit');
        }
        
        // --- CHỨC NĂNG MỚI: Kiểm tra trùng lặp Họ tên và Tự động điền Địa chỉ (YÊU CẦU 1) ---
        function checkDuplicateName(prefix = '') {
            const hoTenInput = document.getElementById(prefix + 'ho_ten');
            const diaChiInput = document.getElementById(prefix + 'dia_chi');
            const hoTenValue = hoTenInput.value.trim();

            // Bỏ qua check nếu không có giá trị hoặc đang ở form SỬA
            if (!hoTenValue || prefix === 'sua-') return; 

            // Tìm đơn có họ tên trùng
            const existingDon = dons.find(d => 
                d.ho_ten.trim().toLowerCase() === hoTenValue.toLowerCase()
            );

            if (existingDon) {
                if (confirm(`Tìm thấy đơn cũ của "${hoTenValue}" tại địa chỉ "${existingDon.dia_chi}".\n\nBạn có muốn sử dụng lại địa chỉ này (nhấn OK) hay tiếp tục nhập địa chỉ mới (nhấn Hủy)?`)) {
                    diaChiInput.value = existingDon.dia_chi;
                } else {
                    // Người dùng chọn Hủy, vẫn giữ Họ tên nhưng không autofill địa chỉ.
                    // Nếu địa chỉ đang trống, không làm gì cả, để người dùng tự nhập.
                }
            }
        }
        
        // --- CHỨC NĂNG MỚI: Cập nhật hiển thị các trường động theo Thẩm quyền (YÊU CẦU 2 & 3) ---
        function updateDynamicFields(prefix = '') {
            const thamQuyen = document.getElementById(prefix + 'tham_quyen').value;
            const knSection = document.getElementById(prefix + 'giai_quyet_kn_section');
            const ksSection = document.getElementById(prefix + 'kiem_sat_gq_don_section');

            // Ẩn tất cả trước
            knSection.style.display = 'none';
            ksSection.style.display = 'none';

            if (thamQuyen === 'Thuộc thẩm quyền giải quyết') {
                knSection.style.display = 'block';
            } else if (thamQuyen === 'Thuộc thẩm quyền kiểm sát') {
                ksSection.style.display = 'block';
            }
        }
        
        // Cập nhật hiển thị ô input tùy chỉnh (Giữ nguyên)
        function updateVanBanInputVisibility(selectElement) {
             const isCustom = selectElement.value === 'Tự điền vào văn bản';
             const customInput = selectElement.nextElementSibling; 

             if (customInput && customInput.classList.contains('can-cu-van-ban-custom')) {
                 if (isCustom) {
                     customInput.style.display = 'block';
                     customInput.required = true;
                 } else {
                     customInput.style.display = 'none';
                     customInput.required = false;
                     customInput.value = ''; 
                 }
             }
         }

        // Hàm thêm căn cứ mới (Giữ nguyên)
        function addCanCu(prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            const newItem = document.createElement('div');
            newItem.className = 'can-cu-item';
            
            let vanBanSelectHtml = '<select class="can-cu-van-ban" onchange="updateVanBanInputVisibility(this)">';
            vanBanSelectHtml += '<option value="">Chọn Văn bản/Quy chế</option>'; 
            vanBanOptionsFinal.forEach(option => {
                vanBanSelectHtml += `<option value="${option}">${option}</option>`;
            });
            vanBanSelectHtml += '</select>';
            
            let customInputHtml = '<input type="text" placeholder="Tự điền Văn bản/Quy chế..." class="can-cu-van-ban-custom" style="display: none; margin-top: 5px;">';


            newItem.innerHTML = `
                <input type="number" placeholder="Điểm" class="can-cu-diem" value="">
                <input type="number" placeholder="Khoản" class="can-cu-khoan" value="">
                <input type="number" placeholder="Điều" class="can-cu-dieu" value="">
                <div style="display: flex; flex-direction: column;">
                     ${vanBanSelectHtml}
                     ${customInputHtml}
                </div>
                <button onclick="this.parentNode.remove()">Xóa</button>
            `;
            container.appendChild(newItem);
        }
        
        // Hàm lấy dữ liệu căn cứ (Giữ nguyên)
        function getCanCuData(prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            const items = container.querySelectorAll('.can-cu-item');
            const canCuList = [];
            items.forEach(item => {
                const diem = item.querySelector('.can-cu-diem').value.trim();
                const khoan = item.querySelector('.can-cu-khoan').value.trim();
                const dieu = item.querySelector('.can-cu-dieu').value.trim();
                const vanBanSelect = item.querySelector('.can-cu-van-ban');
                const customInput = item.querySelector('.can-cu-van-ban-custom');
                
                let van_ban = '';
                
                if (vanBanSelect.value === 'Tự điền vào văn bản' && customInput) {
                    van_ban = customInput.value.trim();
                } else {
                    van_ban = vanBanSelect.value.trim();
                }
                
                if (diem || khoan || dieu || van_ban) {
                     canCuList.push({ diem, khoan, dieu, van_ban });
                }
            });
            return canCuList;
        }

        // Hàm hiển thị căn cứ khi sửa đơn (Giữ nguyên)
        function populateCanCuFields(canCuList, prefix = '') {
             const container = document.getElementById(prefix + 'can_cu_container');
             container.innerHTML = '';
             
             if (!canCuList || canCuList.length === 0) {
                 addCanCu(prefix);
                 return;
             }
             
             canCuList.forEach(item => {
                 let vanBanValue = item.van_ban || '';
                 let customInputValue = '';
                 
                 let isCustomValue = vanBanValue && !vanBanOptionsFinal.includes(vanBanValue);

                 let selectValue = vanBanValue;
                 if (isCustomValue) {
                     selectValue = 'Tự điền vào văn bản'; 
                     customInputValue = vanBanValue; 
                 } else if (vanBanValue === 'Tự điền vào văn bản') {
                     selectValue = 'Tự điền vào văn bản';
                     customInputValue = ''; 
                 }
                 
                 let vanBanSelectHtml = `<select class="can-cu-van-ban" onchange="updateVanBanInputVisibility(this)">`;
                 vanBanSelectHtml += `<option value="" ${selectValue === '' ? 'selected' : ''}>Chọn Văn bản/Quy chế</option>`;
                 
                 vanBanOptionsFinal.forEach(option => {
                     const selected = (option === selectValue) ? 'selected' : '';
                     vanBanSelectHtml += `<option value="${option}" ${selected}>${option}</option>`;
                 });
                 vanBanSelectHtml += '</select>';
                 
                 let customInputDisplay = (selectValue === 'Tự điền vào văn bản' || isCustomValue) ? 'block' : 'none';
                 let customInputRequired = (selectValue === 'Tự điền vào văn bản' || isCustomValue) ? 'required' : '';
                 let customInputHtml = `<input type="text" placeholder="Tự điền Văn bản/Quy chế..." class="can-cu-van-ban-custom" style="display: ${customInputDisplay}; margin-top: 5px;" value="${customInputValue}" ${customInputRequired}>`;


                 const newItem = document.createElement('div');
                 newItem.className = 'can-cu-item';
                 newItem.innerHTML = `
                     <input type="number" placeholder="Điểm" class="can-cu-diem" value="${item.diem || ''}">
                     <input type="number" placeholder="Khoản" class="can-cu-khoan" value="${item.khoan || ''}">
                     <input type="number" placeholder="Điều" class="can-cu-dieu" value="${item.dieu || ''}">
                     <div style="display: flex; flex-direction: column;">
                          ${vanBanSelectHtml}
                          ${customInputHtml}
                     </div>
                     <button onclick="this.parentNode.remove()">Xóa</button>
                 `;
                 container.appendChild(newItem);
             });
        }
        
        // Cập nhật Thẩm quyền mặc định (Giữ nguyên)
        function capNhatThamQuyenMacDinh(prefix = '') {
            const phanLoai = document.getElementById(prefix + 'phan_loai').value;
            const thamQuyenSelect = document.getElementById(prefix + 'tham_quyen');
            
            if (phanLoai === 'Đề nghị KN, GĐT, TT' || phanLoai === 'Đề nghị kiểm tra QĐGQKN' || phanLoai === 'Tin báo/Tố giác tội phạm trong HĐTP') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền kiểm sát';
            } else if (phanLoai === 'Khiếu nại' || phanLoai === 'Tố cáo' || phanLoai === 'Yêu cầu bồi thường thiệt hại') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền giải quyết';
            } else {
                thamQuyenSelect.value = 'Chọn'; 
            }
            // Cập nhật hiển thị các trường động ngay sau khi Thẩm quyền thay đổi
            updateDynamicFields(prefix);
        }
        
        // --- Hàm lấy dữ liệu Chi tiết Giải quyết KN (YÊU CẦU 2) ---
        function getGiaiQuyetKNData(prefix = '') {
             return {
                 phan_cong: {
                     so: document.getElementById(prefix + 'gq_phan_cong_so').value.trim(),
                     ngay: parseDate(document.getElementById(prefix + 'gq_phan_cong_ngay').value),
                     noi_dung: document.getElementById(prefix + 'gq_phan_cong_noi_dung').value.trim()
                 },
                 ke_hoach: {
                     so: document.getElementById(prefix + 'gq_ke_hoach_so').value.trim(),
                     ngay: parseDate(document.getElementById(prefix + 'gq_ke_hoach_ngay').value),
                     noi_dung: document.getElementById(prefix + 'gq_ke_hoach_noi_dung').value.trim()
                 },
                 dv_phoi_hop: {
                     so: document.getElementById(prefix + 'gq_dv_phoi_hop_so').value.trim(),
                     ngay: parseDate(document.getElementById(prefix + 'gq_dv_phoi_hop_ngay').value),
                     noi_dung: document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung').value.trim()
                 },
                 de_xuat_chi_tiet: document.getElementById(prefix + 'gq_de_xuat_chi_tiet').value.trim(),
                 qd_giai_quyet: {
                     so: document.getElementById(prefix + 'gq_qd_giai_quyet_so').value.trim(),
                     ngay: parseDate(document.getElementById(prefix + 'gq_qd_giai_quyet_ngay').value),
                     noi_dung: document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung').value.trim()
                 }
             };
         }
         
         // --- Hàm lấy dữ liệu Chi tiết Kiểm sát GQ Đơn (YÊU CẦU 3) ---
         function getKiemSatGQDonData(prefix = '') {
             return {
                 chuyen_den_co_quan: document.getElementById(prefix + 'ks_chuyen_den_co_quan').value,
                 quyet_dinh: {
                     so: document.getElementById(prefix + 'ks_quyet_dinh_so').value.trim(),
                     ngay: parseDate(document.getElementById(prefix + 'ks_quyet_dinh_ngay').value),
                     noi_dung: document.getElementById(prefix + 'ks_quyet_dinh_noi_dung').value.trim(),
                     co_quan_ban_hanh: document.getElementById(prefix + 'ks_quyet_dinh_co_quan').value.trim()
                 }
             };
         }
         
         // --- Hàm điền dữ liệu Giải quyết KN vào form Sửa ---
         function populateGiaiQuyetKNFields(data, prefix = '') {
              const d = data || {};
              const pc = d.phan_cong || {};
              const kh = d.ke_hoach || {};
              const dvph = d.dv_phoi_hop || {};
              const qdgq = d.qd_giai_quyet || {};
              
              document.getElementById(prefix + 'gq_phan_cong_so').value = pc.so || '';
              document.getElementById(prefix + 'gq_phan_cong_ngay').value = pc.ngay || '';
              document.getElementById(prefix + 'gq_phan_cong_noi_dung').value = pc.noi_dung || '';

              document.getElementById(prefix + 'gq_ke_hoach_so').value = kh.so || '';
              document.getElementById(prefix + 'gq_ke_hoach_ngay').value = kh.ngay || '';
              document.getElementById(prefix + 'gq_ke_hoach_noi_dung').value = kh.noi_dung || '';
              
              document.getElementById(prefix + 'gq_dv_phoi_hop_so').value = dvph.so || '';
              document.getElementById(prefix + 'gq_dv_phoi_hop_ngay').value = dvph.ngay || '';
              document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung').value = dvph.noi_dung || '';
              
              document.getElementById(prefix + 'gq_de_xuat_chi_tiet').value = d.de_xuat_chi_tiet || '';
              
              document.getElementById(prefix + 'gq_qd_giai_quyet_so').value = qdgq.so || '';
              document.getElementById(prefix + 'gq_qd_giai_quyet_ngay').value = qdgq.ngay || '';
              document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung').value = qdgq.noi_dung || '';
         }
         
         // --- Hàm điền dữ liệu Kiểm sát GQ Đơn vào form Sửa ---
         function populateKiemSatGQDonFields(data, prefix = '') {
             const d = data || {};
             const qd = d.quyet_dinh || {};

             document.getElementById(prefix + 'ks_chuyen_den_co_quan').value = d.chuyen_den_co_quan || 'Chọn';
             
             document.getElementById(prefix + 'ks_quyet_dinh_so').value = qd.so || '';
             document.getElementById(prefix + 'ks_quyet_dinh_ngay').value = qd.ngay || '';
             document.getElementById(prefix + 'ks_quyet_dinh_noi_dung').value = qd.noi_dung || '';
             document.getElementById(prefix + 'ks_quyet_dinh_co_quan').value = qd.co_quan_ban_hanh || '';
         }


        // --- CRUD FUNCTIONS ---

        function saveDon() {
            if (!currentUser) return alert('Vui lòng đăng nhập để lưu đơn.');

            const thamQuyen = document.getElementById('tham_quyen').value;

            const data = {
                ngay_nhan: parseDate(document.getElementById('ngay_nhan').value),
                nguon_don: document.getElementById('nguon_don').value,
                ho_ten: document.getElementById('ho_ten').value.trim(),
                dia_chi: document.getElementById('dia_chi').value.trim(),
                ngay_ghi: parseDate(document.getElementById('ngay_ghi').value),
                phan_loai: document.getElementById('phan_loai').value,
                tham_quyen: thamQuyen,
                can_bo_phan_cong: document.getElementById('can_bo_phan_cong').value.trim(),
                chuc_danh: document.getElementById('chuc_danh').value,
                chuyen_den: document.getElementById('chuyen_den').value,
                ngay_chuyen_don: parseDate(document.getElementById('ngay_chuyen_don').value),
                can_cu: getCanCuData(),
                noi_dung: document.getElementById('noi_dung').value.trim(),
                de_xuat: document.getElementById('de_xuat').value.trim(),
                ket_qua: document.getElementById('ket_qua').value.trim(),
                
                // --- THÊM DỮ LIỆU ĐỘNG THEO THẨM QUYỀN (YÊU CẦU 2 & 3) ---
                giai_quyet_kn: thamQuyen === 'Thuộc thẩm quyền giải quyết' ? getGiaiQuyetKNData() : null,
                kiem_sat_gq_don: thamQuyen === 'Thuộc thẩm quyền kiểm sát' ? getKiemSatGQDonData() : null,

                user_unit: currentUser.unit, 
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };

            // Validation
            if (!data.ngay_nhan || !data.ho_ten || data.tham_quyen === 'Chọn' || data.phan_loai === 'Chọn') {
                return alert('Vui lòng nhập đủ các trường bắt buộc: Ngày nhận đơn, Họ tên, Phân loại, Thẩm quyền.');
            }

            const editId = document.getElementById('edit-id').value;

            if (editId) {
                // Update existing record
                database.ref('dons/' + editId).update(data)
                    .then(() => {
                        alert('Cập nhật đơn thành công!');
                        updateTable();
                        resetForm();
                    })
                    .catch(error => alert('Lỗi khi cập nhật đơn: ' + error.message));
            } else {
                // Save new record
                database.ref('dons').push(data)
                    .then(() => {
                        alert('Lưu đơn thành công!');
                        updateTable();
                        resetForm();
                    })
                    .catch(error => alert('Lỗi khi lưu đơn: ' + error.message));
            }
        }
        
        function resetForm(prefix = '') {
            document.getElementById(prefix + 'ngay_nhan').value = new Date().toISOString().slice(0, 10);
            document.getElementById(prefix + 'nguon_don').value = 'Chọn';
            document.getElementById(prefix + 'ho_ten').value = '';
            document.getElementById(prefix + 'dia_chi').value = '';
            document.getElementById(prefix + 'ngay_ghi').value = '';
            document.getElementById(prefix + 'phan_loai').value = 'Khiếu nại'; 
            document.getElementById(prefix + 'tham_quyen').value = 'Thuộc thẩm quyền giải quyết'; 
            document.getElementById(prefix + 'chuc_danh').value = 'Chọn';
            document.getElementById(prefix + 'chuyen_den').value = 'Chọn';
            document.getElementById(prefix + 'ngay_chuyen_don').value = '';
            document.getElementById(prefix + 'noi_dung').value = '';
            document.getElementById(prefix + 'de_xuat').value = '';
            document.getElementById(prefix + 'ket_qua').value = '';
            document.getElementById(prefix + 'edit-id').value = '';
            
            if (prefix !== 'sua-') {
                 document.getElementById('can_bo_phan_cong').value = currentUser ? currentUser.username : '';
            } else {
                 document.getElementById('sua-can_bo_phan_cong').value = '';
            }
            
            // Reset các trường động (Chỉ cần reset value và gọi updateDynamicFields)
            document.getElementById(prefix + 'ks_chuyen_den_co_quan').value = 'Chọn';
            document.getElementById(prefix + 'ks_quyet_dinh_so').value = '';
            document.getElementById(prefix + 'ks_quyet_dinh_ngay').value = '';
            document.getElementById(prefix + 'ks_quyet_dinh_noi_dung').value = '';
            document.getElementById(prefix + 'ks_quyet_dinh_co_quan').value = '';
            
            document.getElementById(prefix + 'gq_phan_cong_so').value = '';
            document.getElementById(prefix + 'gq_phan_cong_ngay').value = '';
            document.getElementById(prefix + 'gq_phan_cong_noi_dung').value = '';
            document.getElementById(prefix + 'gq_ke_hoach_so').value = '';
            document.getElementById(prefix + 'gq_ke_hoach_ngay').value = '';
            document.getElementById(prefix + 'gq_ke_hoach_noi_dung').value = '';
            document.getElementById(prefix + 'gq_dv_phoi_hop_so').value = '';
            document.getElementById(prefix + 'gq_dv_phoi_hop_ngay').value = '';
            document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung').value = '';
            document.getElementById(prefix + 'gq_de_xuat_chi_tiet').value = '';
            document.getElementById(prefix + 'gq_qd_giai_quyet_so').value = '';
            document.getElementById(prefix + 'gq_qd_giai_quyet_ngay').value = '';
            document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung').value = '';
            
            // Ẩn/hiện lại các mục động theo giá trị mặc định đã set
            updateDynamicFields(prefix);
            
            // Reset căn cứ
            populateCanCuFields([], prefix);
        }

        // Tải dữ liệu đơn và áp dụng logic phân quyền hiển thị (Giữ nguyên)
        function updateTable() {
            if (!currentUser) return;

            let ref = database.ref('dons').orderByChild('timestamp');
            
            ref.once('value', snapshot => {
                const data = snapshot.val() || {};
                
                let allDons = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                
                let filteredDons = allDons.filter(don => {
                    const userRole = currentUser.role;
                    const userUsername = currentUser.username; 
                    const userUnit = currentUser.unit;
                    const donUnit = don.user_unit || 'TT-KT'; 
                    const donCanBoPhanCong = don.can_bo_phan_cong; 

                    if (userRole === 'admin' || userRole === 'super_admin' || userRole === 'manager_TP') {
                        return true; 
                    }
                    
                    if (userRole === 'manager_KV') {
                        return donUnit === userUnit;
                    }
                    
                    if (userRole === 'user_TP' || userRole === 'user_KV') {
                        return donCanBoPhanCong === userUsername;
                    }

                    return false;
                    
                });
                
                // Đảo ngược thứ tự để đơn mới nhất lên đầu
                dons = filteredDons.reverse(); 
                renderTable(dons);
            });
        }

        // Hiển thị bảng (Giữ nguyên)
        function renderTable(filteredDons) {
            const donBody = document.getElementById('don-body');
            donBody.innerHTML = '';
            filteredDons.forEach((don, index) => {
                const row = donBody.insertRow();
                row.onclick = () => selectDon(don.id); 
                row.id = `row-${don.id}`; 
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${formatDate(don.ngay_nhan)}</td>
                    <td>${don.ho_ten}</td>
                    <td>${don.noi_dung.substring(0, 50)}...</td>
                    <td>${don.phan_loai}</td>
                    <td>${don.tham_quyen}</td>
                    <td>${don.chuyen_den} (${formatDate(don.ngay_chuyen_don)})</td>
                    <td class="table-actions">
                        <button class="edit-btn" onclick="showEditModal('${don.id}', event)">Sửa</button>
                        <button class="delete-btn" onclick="deleteDon('${don.id}', event)">Xóa</button>
                    </td>
                `;
            });
            if (currentSelectedId) {
                 const selectedRow = document.getElementById(`row-${currentSelectedId}`);
                 if (selectedRow) selectedRow.style.backgroundColor = '#bbdefb';
            }
        }
        
        // ... (Các hàm selectDon, filterTable, resetFilter giữ nguyên) ...

        function selectDon(id) {
            if (currentSelectedId) {
                const oldRow = document.getElementById(`row-${currentSelectedId}`);
                if (oldRow) oldRow.style.backgroundColor = '';
            }
            
            const newRow = document.getElementById(`row-${id}`);
            if (newRow) newRow.style.backgroundColor = '#bbdefb'; 
            
            currentSelectedId = id;
        }

        function filterTable() {
            const searchText = document.getElementById('search-text').value.toLowerCase();
            const searchDate = document.getElementById('search-date').value;

            const filtered = dons.filter(don => {
                const nameMatch = don.ho_ten.toLowerCase().includes(searchText);
                const dateMatch = !searchDate || don.ngay_nhan === searchDate;
                return nameMatch && dateMatch;
            });

            renderTable(filtered);
        }

        function resetFilter() {
            document.getElementById('search-text').value = '';
            document.getElementById('search-date').value = '';
            renderTable(dons);
        }

        // --- CẬP NHẬT: showEditModal để load dữ liệu động mới ---
        function showEditModal(id, event) {
            event.stopPropagation(); 

            const don = dons.find(d => d.id === id);
            if (!don) return alert('Không tìm thấy đơn!');
            
            if (!checkEditPermission(don)) return alert('Bạn không có quyền sửa đơn này.');
            
            document.getElementById('edit-id-modal').value = id;
            
            document.getElementById('sua-ngay_nhan').value = don.ngay_nhan || '';
            document.getElementById('sua-nguon_don').value = don.nguon_don || 'Chọn';
            document.getElementById('sua-ho_ten').value = don.ho_ten || '';
            document.getElementById('sua-dia_chi').value = don.dia_chi || '';
            document.getElementById('sua-ngay_ghi').value = don.ngay_ghi || '';
            document.getElementById('sua-phan_loai').value = don.phan_loai || 'Chọn';
            
            capNhatThamQuyenMacDinh('sua-');
            document.getElementById('sua-tham_quyen').value = don.tham_quyen || 'Chọn'; 
            
            document.getElementById('sua-can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('sua-chuc_danh').value = don.chuc_danh || 'Chọn';
            document.getElementById('sua-chuyen_den').value = don.chuyen_den || 'Chọn';
            document.getElementById('sua-ngay_chuyen_don').value = don.ngay_chuyen_don || '';
            document.getElementById('sua-noi_dung').value = don.noi_dung || '';
            document.getElementById('sua-de_xuat').value = don.de_xuat || '';
            document.getElementById('sua-ket_qua').value = don.ket_qua || '';
            
            populateCanCuFields(don.can_cu, 'sua-');
            
            // --- LOAD DỮ LIỆU ĐỘNG ---
            updateDynamicFields('sua-'); // Phải gọi trước khi populate
            populateGiaiQuyetKNFields(don.giai_quyet_kn, 'sua-');
            populateKiemSatGQDonFields(don.kiem_sat_gq_don, 'sua-');

            document.getElementById('editModal').style.display = 'flex';
        }
        
        // --- CẬP NHẬT: updateDon để lưu dữ liệu động mới ---
        function updateDon() {
            if (!currentUser) return alert('Vui lòng đăng nhập để cập nhật đơn.');

            const id = document.getElementById('edit-id-modal').value;
            const don = dons.find(d => d.id === id);
            const thamQuyen = document.getElementById('sua-tham_quyen').value;

            if (!id || !don) return alert('Không tìm thấy đơn để cập nhật.');
            if (!checkEditPermission(don)) return alert('Bạn không có quyền sửa đơn này.');

            const updatedData = {
                ngay_nhan: parseDate(document.getElementById('sua-ngay_nhan').value),
                nguon_don: document.getElementById('sua-nguon_don').value,
                ho_ten: document.getElementById('sua-ho_ten').value.trim(),
                dia_chi: document.getElementById('sua-dia_chi').value.trim(),
                ngay_ghi: parseDate(document.getElementById('sua-ngay_ghi').value),
                phan_loai: document.getElementById('sua-phan_loai').value,
                tham_quyen: thamQuyen,
                can_bo_phan_cong: document.getElementById('sua-can_bo_phan_cong').value.trim(),
                chuc_danh: document.getElementById('sua-chuc_danh').value,
                chuyen_den: document.getElementById('sua-chuyen_den').value,
                ngay_chuyen_don: parseDate(document.getElementById('sua-ngay_chuyen_don').value),
                can_cu: getCanCuData('sua-'),
                noi_dung: document.getElementById('sua-noi_dung').value.trim(),
                de_xuat: document.getElementById('sua-de_xuat').value.trim(),
                ket_qua: document.getElementById('sua-ket_qua').value.trim(),
                
                // --- LƯU DỮ LIỆU ĐỘNG CẬP NHẬT ---
                giai_quyet_kn: thamQuyen === 'Thuộc thẩm quyền giải quyết' ? getGiaiQuyetKNData('sua-') : null,
                kiem_sat_gq_don: thamQuyen === 'Thuộc thẩm quyền kiểm sát' ? getKiemSatGQDonData('sua-') : null,
            };
            
            // Validation
            if (!updatedData.ngay_nhan || !updatedData.ho_ten || updatedData.tham_quyen === 'Chọn' || updatedData.phan_loai === 'Chọn') {
                return alert('Vui lòng nhập đủ các trường bắt buộc: Ngày nhận đơn, Họ tên, Phân loại, Thẩm quyền.');
            }

            database.ref('dons/' + id).update(updatedData)
                .then(() => {
                    alert('Cập nhật đơn thành công!');
                    document.getElementById('editModal').style.display = 'none';
                    updateTable();
                })
                .catch(error => alert('Lỗi khi cập nhật đơn: ' + error.message));
        }

        // Xóa đơn (Giữ nguyên)
        function deleteDon(id, event) {
            event.stopPropagation(); 
            
            if (!currentUser) return alert('Vui lòng đăng nhập để xóa đơn.');
            const don = dons.find(d => d.id === id);
            
            if (currentUser.role !== 'admin' && currentUser.role !== 'super_admin' && currentUser.role !== 'manager_TP') {
                return alert('Bạn không có quyền xóa đơn này.');
            }

            if (confirm('Bạn có chắc chắn muốn xóa đơn này?')) {
                database.ref('dons/' + id).remove()
                    .then(() => {
                        alert('Xóa đơn thành công!');
                        updateTable();
                        if (currentSelectedId === id) currentSelectedId = null;
                    })
                    .catch(error => alert('Lỗi khi xóa đơn: ' + error.message));
            }
        }
        
        // Kiểm tra quyền sửa/xóa đơn (Giữ nguyên)
        function checkEditPermission(don) {
             const userRole = currentUser.role;
             const userUnit = currentUser.unit;
             const userUsername = currentUser.username;
             const donUnit = don.user_unit || 'TT-KT'; 
             const donCanBoPhanCong = don.can_bo_phan_cong;

             if (userRole === 'admin' || userRole === 'super_admin' || userRole === 'manager_TP') {
                return true; 
             }
             
             if (donUnit !== userUnit) {
                 return false; 
             }

             if (userRole === 'manager_KV') {
                 return true; 
             }
             
             if (userRole === 'user_TP' || userRole === 'user_KV') {
                return donCanBoPhanCong === userUsername;
             }
             
             return false;
        }


        // --- EXPORT/REPORTING FUNCTIONS ---

        function exportList() {
            // ... (Giữ nguyên logic exportList)
            const tableRows = Array.from(document.getElementById('don-body').rows);
            if (tableRows.length === 0) {
                 return alert("Không có dữ liệu đơn để xuất!");
            }
            
            // Chuẩn bị dữ liệu cho Excel
            const header = [
                "STT", "Ngày nhận đơn", "Họ tên/Cơ quan/Tổ chức", "Địa chỉ", "Đơn ghi ngày", "Phân loại", 
                "Thẩm quyền", "Cán bộ phân công", "Chức danh", "Chuyển đến", "Ngày chuyển đơn", 
                "Căn cứ", "Nội dung đơn", "Đề xuất", "Kết quả", "Đơn vị tạo",
                
                // Thêm các cột Giải quyết KN
                "GQ_PC_Số", "GQ_PC_Ngày", "GQ_PC_Nội dung",
                "GQ_KH_Số", "GQ_KH_Ngày", "GQ_KH_Nội dung",
                "GQ_ĐVPH_Số", "GQ_ĐVPH_Ngày", "GQ_ĐVPH_Nội dung",
                "GQ_Đề xuất chi tiết",
                "GQ_QĐGQ_Số", "GQ_QĐGQ_Ngày", "GQ_QĐGQ_Nội dung",
                
                // Thêm các cột Kiểm sát GQ Đơn
                "KS_Chuyển đến Cơ quan", "KS_QĐ_Số", "KS_QĐ_Ngày", "KS_QĐ_Nội dung", "KS_QĐ_Cơ quan ban hành"
            ];
            const data = [header];
            
            let filteredDons = [];
            
            const visibleIds = tableRows.map(row => row.id.replace('row-', ''));
            filteredDons = dons.filter(don => visibleIds.includes(don.id));


            filteredDons.forEach((don, index) => {
                const canCuText = (don.can_cu || [])
                    .map(c => 
                        `${c.diem ? `Điểm ${c.diem}` : ''} ${c.khoan ? `Khoản ${c.khoan}` : ''} ${c.dieu ? `Điều ${c.dieu}` : ''} ${c.van_ban || ''}`.trim()
                    )
                    .join('; ');
                    
                const gq = don.giai_quyet_kn || {};
                const ks = don.kiem_sat_gq_don || {};
                
                data.push([
                    index + 1,
                    formatDate(don.ngay_nhan),
                    don.ho_ten,
                    don.dia_chi,
                    formatDate(don.ngay_ghi),
                    don.phan_loai,
                    don.tham_quyen,
                    don.can_bo_phan_cong,
                    don.chuc_danh,
                    don.chuyen_den,
                    formatDate(don.ngay_chuyen_don),
                    canCuText,
                    don.noi_dung,
                    don.de_xuat,
                    don.ket_qua,
                    don.user_unit,
                    
                    // Dữ liệu Giải quyết KN
                    gq.phan_cong?.so || '', formatDate(gq.phan_cong?.ngay), gq.phan_cong?.noi_dung || '',
                    gq.ke_hoach?.so || '', formatDate(gq.ke_hoach?.ngay), gq.ke_hoach?.noi_dung || '',
                    gq.dv_phoi_hop?.so || '', formatDate(gq.dv_phoi_hop?.ngay), gq.dv_phoi_hop?.noi_dung || '',
                    gq.de_xuat_chi_tiet || '',
                    gq.qd_giai_quyet?.so || '', formatDate(gq.qd_giai_quyet?.ngay), gq.qd_giai_quyet?.noi_dung || '',
                    
                    // Dữ liệu Kiểm sát GQ Đơn
                    ks.chuyen_den_co_quan || '', ks.quyet_dinh?.so || '', formatDate(ks.quyet_dinh?.ngay), ks.quyet_dinh?.noi_dung || '', ks.quyet_dinh?.co_quan_ban_hanh || ''
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DanhSachDon");

            XLSX.writeFile(wb, "Danh_sach_don_khieu_nai_to_cao.xlsx");
        }
        
        // --- CHỨC NĂNG MỚI: Modal cho Báo cáo thống kê ---
        function showReportModal() {
            document.getElementById('reportModal').style.display = 'flex';
        }

        // --- CẬP NHẬT: Hàm exportReport để hỗ trợ lọc theo Tháng/Năm và Cấp (YÊU CẦU 4) ---
        function exportReport() {
            const reportMonthValue = document.getElementById('report-month').value; // YYYY-MM
            const reportLevel = document.getElementById('report-level').value; // all, TP, KV
            
            if (!reportMonthValue) {
                return alert("Vui lòng chọn Tháng/Năm để xuất báo cáo!");
            }
            
            const [reportYear, reportMonth] = reportMonthValue.split('-');

            let filteredDonsForReport = dons.filter(don => {
                const donDate = don.ngay_nhan; // YYYY-MM-DD
                if (!donDate) return false;

                const donMonth = donDate.substring(5, 7); // MM
                const donYear = donDate.substring(0, 4); // YYYY
                
                // Lọc theo Tháng/Năm
                const monthMatch = (donMonth === reportMonth && donYear === reportYear);

                if (!monthMatch) return false;

                // Lọc theo Cấp
                const donUnit = don.user_unit || 'TT-KT';
                
                if (reportLevel === 'all') return true;
                
                if (reportLevel === 'TP') {
                    // Cấp TP là TT-KT
                    return donUnit === 'TT-KT';
                }
                
                if (reportLevel === 'KV') {
                    // Cấp KV là VKSND KVx (Không phải TT-KT)
                    return donUnit !== 'TT-KT';
                }
                
                return false;
            });
            
            if (filteredDonsForReport.length === 0) {
                 document.getElementById('reportModal').style.display = 'none';
                 return alert(`Không có dữ liệu đơn để xuất báo cáo trong tháng ${reportMonth}/${reportYear} theo cấp ${reportLevel}.`);
            }
            
            const total = filteredDonsForReport.length;
            
            // Thống kê theo Phân loại
            const phan_loai_counts = {};
            filteredDonsForReport.forEach(don => {
                 const pl = don.phan_loai || 'Không phân loại';
                 phan_loai_counts[pl] = (phan_loai_counts[pl] || 0) + 1;
            });

            // Thống kê theo Thẩm quyền
            const tham_quyen_counts = {};
            filteredDonsForReport.forEach(don => {
                 const tq = don.tham_quyen || 'Không thẩm quyền';
                 tham_quyen_counts[tq] = (tham_quyen_counts[tq] || 0) + 1;
            });
            
            // Thống kê theo Kết quả xử lý (Chuyển đến)
            const chuyen_den_counts = {};
            filteredDonsForReport.forEach(don => {
                 const cd = don.chuyen_den || 'Chưa chuyển';
                 chuyen_den_counts[cd] = (chuyen_den_counts[cd] || 0) + 1;
            });

            const reportHeaderTitle = `BÁO CÁO TỔNG HỢP ĐƠN THÁNG ${reportMonth} NĂM ${reportYear}`;
            
            // Chuyển kết quả thống kê thành mảng dữ liệu Excel
            const reportData = [
                 [reportHeaderTitle],
                 ["Cấp báo cáo:", reportLevel === 'all' ? 'Tất cả' : (reportLevel === 'TP' ? 'Thành phố' : 'Khu vực')],
                 ["Tổng số đơn:", total],
                 [],
                 ["PHÂN LOẠI"],
                 ["Loại đơn", "Số lượng", "Tỷ lệ (%)"]
            ];
            
            for (const [key, count] of Object.entries(phan_loai_counts)) {
                reportData.push([key, count, ((count / total) * 100).toFixed(2)]);
            }
            reportData.push([], ["THẨM QUYỀN"], ["Thẩm quyền", "Số lượng", "Tỷ lệ (%)"]);
            for (const [key, count] of Object.entries(tham_quyen_counts)) {
                reportData.push([key, count, ((count / total) * 100).toFixed(2)]);
            }
            reportData.push([], ["KẾT QUẢ XỬ LÝ (Xử lý ban đầu)"], ["Nơi chuyển đến", "Số lượng", "Tỷ lệ (%)"]);
            for (const [key, count] of Object.entries(chuyen_den_counts)) {
                reportData.push([key, count, ((count / total) * 100).toFixed(2)]);
            }

            const ws = XLSX.utils.aoa_to_sheet(reportData);
            ws['!cols'] = [ { wch: 30 }, { wch: 10 }, { wch: 10 } ]; 

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoTongHop");

            XLSX.writeFile(wb, `Bao_cao_tong_hop_${reportMonth}_${reportYear}_${reportLevel}.xlsx`);
            document.getElementById('reportModal').style.display = 'none'; // Đóng modal sau khi xuất
        }
        
        function downloadJSON() {
            if (dons.length === 0) {
                 return alert("Không có dữ liệu đơn để sao lưu!");
            }
            const dataString = JSON.stringify(dons, null, 2);
            const blob = new Blob([dataString], { type: "application/json" });
            saveAs(blob, `DONS_BACKUP_${new Date().toISOString().slice(0, 10)}.json`);
        }
        
        // --- CẬP NHẬT: getDonDetails để thêm dữ liệu động cho Phiếu Đề Xuất (Yêu cầu 2) ---
        function getDonDetails(id) {
             const don = dons.find(d => d.id === id);
             if (!don) return null;
             
             const canCuText = (don.can_cu || [])
                 .filter(c => c.diem || c.khoan || c.dieu || c.van_ban)
                 .map(c => {
                     let parts = [];
                     if (c.diem) parts.push(`điểm ${c.diem}`);
                     if (c.khoan) parts.push(`khoản ${c.khoan}`);
                     if (c.dieu) parts.push(`Điều ${c.dieu}`);
                     
                     let vanBanDisplay = '';
                     if (c.van_ban && c.van_ban !== 'Tự điền vào văn bản') {
                          vanBanDisplay = c.van_ban;
                     } 
                     
                     if (vanBanDisplay) parts.push(`(${vanBanDisplay})`);
                     
                     return parts.join(' ') + '. ';
                 })
                 .join('\n');
                 
             // Lấy thêm Đề xuất chi tiết từ mục Giải quyết KN (nếu có)
             const deXuatChiTiet = don.giai_quyet_kn?.de_xuat_chi_tiet || don.de_xuat;
             
             return {
                 ...don,
                 canCuText: canCuText,
                 ngayNhanFormatted: formatDate(don.ngay_nhan),
                 ngayGhiFormatted: formatDate(don.ngay_ghi),
                 deXuatFinal: deXuatChiTiet // Sử dụng đề xuất chi tiết nếu có
             };
        }

        // --- CẬP NHẬT: downloadProposalDoc để sử dụng Đề xuất chi tiết (Yêu cầu 2) ---
        function downloadProposalDoc(id) {
            if (!id) return alert("Vui lòng chọn một đơn trong danh sách để xuất Phiếu Đề Xuất.");
            
            const don = getDonDetails(id);
            if (!don) return alert('Không tìm thấy dữ liệu đơn.');
            if (!don.deXuatFinal) return alert('Trường "Đề xuất" đang trống. Vui lòng nhập thông tin đề xuất trước khi xuất Phiếu.');

            const today = new Date();
            const year = today.getFullYear();
            
            const canBo = don.can_bo_phan_cong || '...........................................';
            const chucDanh = don.chuc_danh === 'Chọn' ? '...........................................' : don.chuc_danh;
            const ngayGhi = don.ngayGhiFormatted || '..../..../....';
            const nguonDon = don.nguon_don === 'Chọn' ? '...........................................' : don.nguon_don;

            const content = `
                <div style="width: 100%; font-family: 'Times New Roman', serif; font-size: 14pt;">
                    <table style="width: 100%; border: none;">
                        <tr>
                            <td style="width: 50%; text-align: center; border: none; padding: 0;">
                                <p style="margin: 0; font-size: 14pt; font-weight: bold;">VIỆN KIỂM SÁT NHÂN DÂN</p>
                                <p style="margin: 0; font-size: 14pt; font-weight: bold;">THÀNH PHỐ CẦN THƠ</p>
                                <p style="margin: 0; font-size: 14pt; font-weight: bold; border-bottom: 1px solid black; display: inline-block;">THANH TRA - KHIẾU TỐ</p>
                            </td>
                            <td style="width: 50%; text-align: center; border: none; padding: 0;">
                                <p style="margin: 0; font-size: 14pt; font-weight: bold;">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</p>
                                <p style="margin: 0; font-size: 14pt; border-bottom: 1px solid black; display: inline-block; font-weight: bold;">Độc lập - Tự do - Hạnh phúc</p>
                                <p style="margin: 10px 0 0 0; font-style: italic; font-size: 14pt;">Cần Thơ, ngày ${today.getDate()} tháng ${today.getMonth() + 1} năm ${year}</p>
                            </td>
                        </tr>
                    </table>
                    
                    <p style="text-align: right; margin: 20px 0 5px 0; font-size: 12pt;">
                        <span style="border: 1px solid black; padding: 2px 5px;">Mẫu số 07/KT</span><br>
                        <span style="font-size: 12pt;">(Theo QĐ số 28/QĐ-VKSTC ngày 15/02/2023)</span>
                    </p>
                    
                    <h3 style="text-align: center; font-size: 16pt; margin: 10px 0 20px 0;">PHIẾU ĐỀ XUẤT XỬ LÝ ĐƠN</h3>

                    <p style="margin: 0 0 10px 0;">
                        <span style="font-size: 14pt; font-weight: bold;">Kính gửi:</span>
                        <span style="font-size: 14pt;">- Lãnh đạo Viện;</span>
                    </p>
                    <p style="margin: 0 0 20px 0; padding-left: 80px;">
                        <span style="font-size: 14pt;">- Lãnh đạo Thanh tra - Khiếu tố.</span>
                    </p>

                    <p style="margin: 5px 0;">
                        Tôi tên: <span style="font-weight: bold;">${canBo}</span>, chức danh: <span style="font-weight: bold;">${chucDanh}</span>.
                    </p>
                    <p style="margin: 5px 0;">
                        Được phân công nghiên cứu, đề xuất xử lý đối với đơn của
                        <span style="font-weight: bold;">${don.ho_ten}</span>,
                        địa chỉ: <span style="font-weight: bold;">${don.dia_chi}</span>,
                        ghi ngày <span style="font-weight: bold;">${ngayGhi}</span>,
                        Viện kiểm sát nhân dân thành phố Cần Thơ nhận đơn ngày <span style="font-weight: bold;">${don.ngayNhanFormatted}</span>
                        do <span style="font-weight: bold;">${nguonDon}</span> chuyển đến.
                    </p>
                    
                    <p style="margin: 10px 0;">
                        <span style="font-weight: bold;">Nội dung đơn:</span> 
                        <span style="white-space: pre-wrap; display: block; padding-left: 20px;">${don.noi_dung}</span>
                    </p>
                    
                    <p style="margin: 10px 0;">
                        <span style="font-weight: bold;">Theo quy định tại:</span><br>
                        <span style="white-space: pre-wrap; display: block; padding-left: 20px;">${don.canCuText.trim() || '....................................................................................................................................................................................................................................................................................................................................................'}</span>
                    </p>

                    <p style="margin: 20px 0 10px 0;">
                        <span style="font-weight: bold; text-decoration: underline;">Đề xuất:</span> 
                        <span style="white-space: pre-wrap; display: block; padding-left: 20px;">${don.deXuatFinal}</span>
                    </p>
                    
                    <table style="width: 100%; border: none; margin-top: 50px;">
                        <tr>
                            <td style="width: 33%; text-align: center; vertical-align: top; border: none; padding: 0;">
                                <p style="font-weight: bold; margin: 0; font-size: 14pt;">PHÊ DUYỆT CỦA LÃNH ĐẠO VIỆN</p>
                                <p style="font-style: italic; margin: 0; font-size: 12pt;">(Ký, ghi rõ họ tên)</p>
                            </td>
                            <td style="width: 33%; text-align: center; vertical-align: top; border: none; padding: 0;">
                                <p style="font-weight: bold; margin: 0; font-size: 14pt;">LÃNH ĐẠO ĐƠN VỊ ĐỀ XUẤT</p>
                                <p style="font-style: italic; margin: 0; font-size: 12pt;">(Ký, ghi rõ họ tên)</p>
                            </td>
                            <td style="width: 33%; text-align: center; vertical-align: top; border: none; padding: 0;">
                                <p style="font-weight: bold; margin: 0; font-size: 14pt;">NGƯỜI ĐỀ XUẤT</p>
                                <p style="font-style: italic; margin: 0; font-size: 12pt;">(Ký, ghi rõ họ tên)</p>
                                <br><br><br><br>
                                <p style="font-weight: bold; margin: 0; font-size: 14pt;">${canBo}</p>
                            </td>
                        </tr>
                    </table>
                </div>
            `;
            
            const filename = `Phiếu Đề Xuất - ${don.ho_ten}.doc`;
            const htmlContent = `
                <html xmlns:v="urn:schemas-microsoft-com:vml"
                xmlns:o="urn:schemas-microsoft-com:office:office"
                xmlns:w="urn:schemas-microsoft-com:office:word"
                xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
                xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta http-equiv=Content-Type content="text/html; charset=utf-8"></head>
                <body style="tab-interval:36.0pt; font-family: 'Times New Roman';">
                    <div class=WordSection1>
                        ${content}
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob(['\ufeff', htmlContent], {
                type: 'application/msword;charset=utf-8',
            });
            saveAs(blob, filename);
        }
        
        // --- CHỨC NĂNG XUẤT KẾT QUẢ XỬ LÝ ĐƠN (Giữ nguyên) ---
        function downloadResultExtractionDoc(id) {
            if (!id) return alert("Vui lòng chọn một đơn trong danh sách để trích xuất kết quả.");
            
            const don = getDonDetails(id);
            if (!don) return alert('Không tìm thấy dữ liệu đơn.');
            if (!don.ket_qua) return alert('Trường "Kết quả" đang trống. Vui lòng nhập thông tin kết quả xử lý trước khi trích xuất.');

            const today = new Date();
            const year = today.getFullYear();
            const day = today.getDate();
            const month = today.getMonth() + 1;
            
            const ngayXuLy = don.ngay_chuyen_don ? formatDate(don.ngay_chuyen_don) : '..../..../....';
            const canBo = don.can_bo_phan_cong || '...........................................';
            const nguonDon = don.nguon_don === 'Chọn' ? '...........................................' : don.nguon_don;
            
            let canCuDiemKhoanDieu = '';
            let canCuVanBan = '';
            
            (don.can_cu || []).forEach(c => {
                 let parts = [];
                 if (c.diem) parts.push(`điểm ${c.diem}`);
                 if (c.khoan) parts.push(`khoản ${c.khoan}`);
                 if (c.dieu) parts.push(`Điều ${c.dieu}`);
                 
                 if (parts.length > 0) {
                     canCuDiemKhoanDieu += parts.join(' ') + '; ';
                 }
                 
                 if (c.van_ban && c.van_ban !== 'Tự điền vào văn bản') {
                    canCuVanBan += c.van_ban + '; ';
                 }
            });

            canCuDiemKhoanDieu = canCuDiemKhoanDieu.trim().replace(/;$/, '');
            canCuVanBan = canCuVanBan.trim().replace(/;$/, '');


            const canCuTextFormatted = `
                <span style="font-weight: bold;">${canCuDiemKhoanDieu || '...........................................'}</span>. Văn bản: <span style="font-weight: bold;">${canCuVanBan || '...........................................'}</span>
            `.trim();


            const content = `
                <div style="width: 100%; font-family: 'Times New Roman', serif; font-size: 14pt;">
                    <table style="width: 100%; border: none;">
                        <tr>
                            <td style="width: 50%; text-align: center; border: none; padding: 0;">
                                <p style="margin: 0; font-size: 14pt; font-weight: bold;">VIỆN KIỂM SÁT NHÂN DÂN</p>
                                <p style="margin: 0; font-size: 14pt; font-weight: bold;">THÀNH PHỐ CẦN THƠ</p>
                                <p style="margin: 0; font-size: 14pt; font-weight: bold; border-bottom: 1px solid black; display: inline-block;">THANH TRA - KHIẾU TỐ</p>
                            </td>
                            <td style="width: 50%; text-align: center; border: none; padding: 0;">
                                <p style="margin: 0; font-size: 14pt; font-weight: bold;">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</p>
                                <p style="margin: 0; font-size: 14pt; border-bottom: 1px solid black; display: inline-block; font-weight: bold;">Độc lập - Tự do - Hạnh phúc</p>
                            </td>
                        </tr>
                    </table>
                    
                    <h2 style="text-align: center; font-size: 16pt; margin: 30px 0 20px 0; text-transform: uppercase;">TRÍCH XUẤT KẾT QUẢ XỬ LÝ ĐƠN</h2>

                    <p style="margin: 10px 0 5px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block;">Đơn của:</span>
                        <span style="font-weight: bold;">${don.ho_ten}</span>
                    </p>
                    <p style="margin: 5px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block;">Địa chỉ:</span>
                        <span style="font-weight: bold;">${don.dia_chi}</span>
                    </p>
                    <p style="margin: 5px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block;">Đơn ghi ngày:</span>
                        <span style="font-weight: bold;">${don.ngayGhiFormatted || '..../..../....'}</span>
                    </p>
                    <p style="margin: 5px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block;">Viện kiểm sát nhân dân thành phố Cần Thơ nhận đơn ngày:</span>
                        <span style="font-weight: bold;">${don.ngayNhanFormatted}</span>
                    </p>
                    <p style="margin: 5px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block;">Nguồn đơn:</span>
                        <span style="font-weight: bold;">${nguonDon}</span>
                    </p>
                    <p style="margin: 10px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block; vertical-align: top;">Nội dung đơn:</span>
                        <span style="font-weight: bold; display: inline-block; width: calc(100% - 260px); white-space: pre-wrap; vertical-align: top; border-bottom: 1px dashed black; padding-bottom: 5px;">${don.noi_dung}</span>
                    </p>
                    <p style="margin: 10px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block; vertical-align: top;">Căn cứ tại:</span>
                        <span style="display: inline-block; width: calc(100% - 260px); white-space: pre-wrap; vertical-align: top;">${canCuTextFormatted}</span>
                    </p>

                    <p style="margin: 20px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block; vertical-align: top;">Đơn nêu trên đã được xử lý:</span>
                        <span style="font-weight: bold; display: inline-block; width: calc(100% - 260px); white-space: pre-wrap; vertical-align: top; border: 1px solid black; padding: 10px;">${don.ket_qua}</span>
                    </p>
                    <p style="margin: 5px 0;">
                        <span style="font-weight: bold; width: 250px; display: inline-block;">Ngày xử lý:</span>
                        <span style="font-weight: bold;">${ngayXuLy}</span>
                    </p>
                    
                    <table style="width: 100%; border: none; margin-top: 50px;">
                        <tr>
                            <td style="width: 50%; text-align: center; border: none; padding: 0;">
                                <p style="font-style: italic; margin: 0; font-size: 14pt;"></p>
                            </td>
                            <td style="width: 50%; text-align: center; border: none; padding: 0;">
                                <p style="font-style: italic; margin: 0; font-size: 14pt;">Cần Thơ, ngày ${day} tháng ${month} năm ${year}</p>
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 50%; text-align: center; vertical-align: top; border: none; padding: 0;">
                                <p style="font-weight: bold; margin: 0; font-size: 14pt;">LÃNH ĐẠO THANH TRA - KHIẾU TỐ</p>
                                <p style="font-style: italic; margin: 0; font-size: 12pt;">(Ký, ghi rõ họ tên)</p>
                            </td>
                            <td style="width: 50%; text-align: center; vertical-align: top; border: none; padding: 0;">
                                <p style="font-weight: bold; margin: 0; font-size: 14pt;">CÁN BỘ TRÍCH XUẤT</p>
                                <p style="font-style: italic; margin: 0; font-size: 12pt;">(Ký, ghi rõ họ tên)</p>
                                <br><br><br><br>
                                <p style="font-weight: bold; margin: 0; font-size: 14pt;">${canBo}</p>
                            </td>
                        </tr>
                    </table>
                </div>
            `;
            
            const filename = `Trích Xuất Kết Quả - ${don.ho_ten}.doc`;
            const htmlContent = `
                <html xmlns:v="urn:schemas-microsoft-com:vml"
                xmlns:o="urn:schemas-microsoft-com:office:office"
                xmlns:w="urn:schemas-microsoft-com:office:word"
                xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
                xmlns="http://www.w3.org/TR/REC-html40">
                <head><meta http-equiv=Content-Type content="text/html; charset=utf-8"></head>
                <body style="tab-interval:36.0pt; font-family: 'Times New Roman';">
                    <div class=WordSection1>
                        ${content}
                    </div>
                </body>
                </html>
            `;
            
            const blob = new Blob(['\ufeff', htmlContent], {
                type: 'application/msword;charset=utf-8',
            });
            saveAs(blob, filename);
        }
        
        // --- INITIALIZATION ---
        
        function init() {
            initializeDefaultAccounts(); 
            initSelectOptions();
            
            // Đảm bảo các field động được khởi tạo ẩn
            updateDynamicFields('');
            updateDynamicFields('sua-');
            
            // Set giá trị mặc định và gọi updateDynamicFields()
            document.getElementById("ngay_nhan").value = new Date().toISOString().slice(0, 10);
            document.getElementById('phan_loai').value = 'Khiếu nại';
            document.getElementById('tham_quyen').value = 'Thuộc thẩm quyền giải quyết';
            updateDynamicFields('');
            
            document.getElementById('new-role').onchange = capNhatDonViTheoVaiTro;
            capNhatDonViTheoVaiTro();
            populateCanCuFields([], '');
            populateCanCuFields([], 'sua-');
            
            setupEnterKeyListener(); 
            
            const accountBtn = document.getElementById('account-btn');
            if (accountBtn) {
                accountBtn.style.display = 'none'; 
            }
        }
        
        // Thêm tính năng nghe phím Enter cho đăng nhập (Giữ nguyên)
        function setupEnterKeyListener() {
             const usernameInput = document.getElementById('username');
             const passwordInput = document.getElementById('password');
             
             if (usernameInput) {
                 usernameInput.addEventListener('keydown', function(event) {
                     if (event.key === 'Enter') {
                         event.preventDefault(); 
                         login();
                     }
                 });
             }
             if (passwordInput) {
                 passwordInput.addEventListener('keydown', function(event) {
                     if (event.key === 'Enter') {
                         event.preventDefault(); 
                         login();
                     }
                 });
             }
        }
        
        // Gọi hàm khởi tạo khi trang tải xong
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
