<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app https://*.jsdelivr.net; 
                 connect-src 'self' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.jsdelivr.net;
                 img-src 'self' data: https://vienkiemsat.cantho.gov.vn https://upload.wikimedia.org blob:;">

    <title>Hệ thống Quản Lý Đơn Khiếu nại - Tố Cáo</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        
        body {
            font-family: 'Segoe UI', 'Times New Roman', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        }

        header {
            width: 100%;
            padding: 20px;
            background-color: #0408c5;
            color: white;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        
        #login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #E6F7FF; /* Xanh dương nhạt */
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            margin: auto;
            position: absolute;
            top: 55%; /* Tăng từ 50% lên 55% */
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #login-container h2 {
            margin-bottom: 20px;
            color: #D32F2F; /* Đỏ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background-color: #5670e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #login-container button:hover {
            background-color: #5670e6;
        }

        #main-container {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            margin-top: 20px;
        }
        
        .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: calc(100% - 60px);
            gap: 20px;
            padding: 0 20px;
        }
        
        .sidebar {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .main-panel {
            flex: 2;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }
        
        .sidebar button, .main-panel button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            background-color: #5670e6;
            transition: background-color 0.3s;
        }

        .sidebar button:hover, .main-panel button:hover {
            background-color: #5670e6;
        }
        
        .form-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-section.full-width {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }
        
        .form-sub-group {
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #f7f7f7;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9f9f9;
            margin-top: 5px;
        }
        
        .form-group input[type="date"], .form-group input[type="text"] {
            margin-bottom: 5px; 
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            margin-top: 5px;
        }
        
        .can-cu-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .can-cu-item > div:nth-child(4) { /* Cột 4: Văn bản */
            display: flex;
            flex-direction: column;
        }
        
        .can-cu-van-ban-custom {
            margin-top: 5px !important;
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        tr:hover {
            background-color: #e8f5e9;
        }
        
        .table-actions button {
            padding: 5px 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .table-actions td {
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

         .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 600px; 
            width: 90%;
            position: relative;
            max-height: 90vh; 
            overflow-y: auto; 
        }

      
        .modal-content.large-modal {
            max-width: 90%; 
            max-width: 1200px; 
        }
        
        
        #accountsModal .modal-content {
            max-width: 700px; 
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        
        .close-btn:hover, .close-btn:focus {
            color: #000;
        }
        
        .btn-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-start; /* CHỈNH LẠI THÀNH FLEX-START ĐỂ NÚT EXPORT Ở BÊN TRÁI */
        }
        
        .btn-container.modal-footer {
            justify-content: flex-end; /* GIỮ NGUYÊN CHO PHẦN FOOTER MODAL */
        }
        
        .delete-btn {
            background-color: #d32f2f !important;
        }
        
        .delete-btn:hover {
            background-color: #b71c1c !important;
        }
        
        .edit-btn {
            background-color: #1976d2 !important;
        }
        
        .edit-btn:hover {
            background-color: #1565c0 !important;
        }
        
        .proposal-print-btn {
            background-color: #388e3c !important; /* Green color for new print button */
            margin-top: 5px; 
        }
        
        .proposal-print-btn:hover {
            background-color: #2e7d32 !important;
        }
        
        .export-btn { /* ĐỔI TỪ export-proposal-btn sang export-btn và CHỈNH SỬA MÀU SẮC */
            background-color: #5670e6 !important;
        }
        
        .export-btn:hover {
            background-color: #435bce !important;
        }
        
      
        #proposal-content {
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            font-size: 14pt; 
            line-height: 1.5;
        }
        
        #top-right-buttons {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        #account-list li {
            list-style: none;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #account-list li button {
             margin-left: 10px;
             padding: 5px 10px;
             font-size: 12px;
             width: auto;
        }
        .reset-btn {
             background-color: #ff9800 !important;
        }
        .reset-btn:hover {
             background-color: #fb8c00 !important;
        }
        
        /* CSS cho các section động mới */
        .dynamic-section h3 {
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 10px;
            border-bottom: 2px solid #5670e6;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>VIỆN KIỂM SÁT NHÂN DÂN THÀNH PHỐ CẦN THƠ</h1>
        <H2>QUẢN LÝ ĐƠN KHIẾU NẠI - TỐ CÁO</H2>
        <div id="top-right-buttons">
            <button id="account-btn" onclick="showAccountsModal()">Quản lý tài khoản</button>
            <button onclick="showChangePassModal()">Đổi mật khẩu</button> 
            <button onclick="logout()">Đăng xuất</button>
        </div>
    </header>

    <div id="login-container">
        <img src="https://vienkiemsat.cantho.gov.vn/files/images/logo-vks.png" 
             alt="Logo Viện Kiểm Sát" style="width: 100px; margin-bottom: 20px;">
        <h2>Đăng Nhập</h2>
        <input type="text" id="username" placeholder="Tên đăng nhập">
        <input type="password" id="password" placeholder="Mật khẩu">
        <button onclick="login()">Đăng Nhập</button>
        <p><a href="#" onclick="handleForgotPassword()">Quên mật khẩu?</a></p>
    </div>
            
    <div id="main-container">
        <div class="main-content">
            <div class="sidebar">
                <h2>Nhập đơn mới</h2>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_nhan">Ngày nhận đơn:</label>
                        <input type="date" id="ngay_nhan">
                    </div>
                    <div class="form-group">
                        <label for="nguon_don">Nguồn đơn:</label>
                        <select id="nguon_don"></select>
                    </div>
                </div>
                <div class="form-section full-width">
                    <div class="form-group">
                        <label for="ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                        <input type="text" id="ho_ten" onblur="checkDuplicateName()">
                    </div>
                    <div class="form-group">
                        <label for="dia_chi">Địa chỉ:</label>
                        <input type="text" id="dia_chi">
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_ghi">Đơn ghi ngày:</label>
                        <input type="date" id="ngay_ghi">
                    </div>
                    <div class="form-group">
                        <label for="phan_loai">Phân loại:</label>
                        <select id="phan_loai" onchange="capNhatThamQuyenMacDinh()">
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                        </select>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="tham_quyen">Thẩm quyền:</label>
                        <select id="tham_quyen" onchange="updateDynamicFields()">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                            <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                            <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="can_bo_phan_cong">Cán bộ phân công:</label>
                        <input type="text" id="can_bo_phan_cong" readonly>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="chuc_danh">Chức danh:</label>
                        <select id="chuc_danh">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                            <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                            <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                            <option value="Kiểm tra viên">Kiểm tra viên</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chuyen_den">Xử lý/Chuyển đến:</label>
                        <select id="chuyen_den"></select>
                    </div>
                </div>
                <div class="form-section">
                     <div class="form-group">
                        <label for="ngay_chuyen_don">Ngày Xử lý đơn:</label>
                        <input type="date" id="ngay_chuyen_don">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Căn cứ:</label>
                    <div id="can_cu_container"></div>
                    <button onclick="addCanCu()">Thêm căn cứ</button>
                </div>
                <div class="form-group full-width">
                    <label for="noi_dung">Nội dung đơn:</label>
                    <textarea id="noi_dung"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="de_xuat">Đề xuất:</label>
                    <textarea id="de_xuat"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="ket_qua">Kết quả (Xử lý chung):</label>
                    <textarea id="ket_qua"></textarea>
                </div>
                
                <div id="giai_quyet_kn_section" class="dynamic-section full-width" style="display: none;">
                    <h3>Giải quyết khiếu nại thuộc thẩm quyền</h3>
                    
                    <div class="form-sub-group">
                        <label>1. Quyết định phân công:</label>
                        <input type="text" placeholder="Số Quyết định" id="gq_phan_cong_so">
                        <input type="date" placeholder="Ngày Quyết định" id="gq_phan_cong_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="gq_phan_cong_noi_dung"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>2. Kế hoạch xác minh:</label>
                        <input type="text" placeholder="Số Kế hoạch" id="gq_ke_hoach_so">
                        <input type="date" placeholder="Ngày Kế hoạch" id="gq_ke_hoach_ngay">
                        <textarea placeholder="Nội dung Kế hoạch" id="gq_ke_hoach_noi_dung"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>3. Đơn vị phối hợp:</label>
                        <select id="gq_dv_phoi_hop_don_vi" required>
                            <option value="">-- Chọn Đơn vị phối hợp --</option>
                            <option value="Phòng 1">Phòng 1</option>
                            <option value="Phòng 2">Phòng 2</option>
                            <option value="Phòng 7">Phòng 7</option>
                            <option value="Phòng 8">Phòng 8</option>
                            <option value="Phòng 9">Phòng 9</option>
                            <option value="Phòng 10">Phòng 10</option>
                            <option value="Phòng 11">Phòng 11</option>
                            <option value="Phòng 15">Phòng 15</option>
                            <option value="Phòng khác">Phòng khác</option>
                        </select>
                        <textarea placeholder="Nội dung phối hợp" id="gq_dv_phoi_hop_noi_dung"></textarea>
                    </div>
                    <div class="form-sub-group">
                         <label>4. Đề xuất hướng giải quyết:</label>
                         <textarea placeholder="Nội dung Đề xuất chi tiết" id="gq_de_xuat_chi_tiet"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>5. Quyết định giải quyết khiếu nại (Lần 1):</label>
                        <input type="text" placeholder="Số Quyết định" id="gq_qd_giai_quyet_so">
                        <input type="date" placeholder="Ngày Quyết định" id="gq_qd_giai_quyet_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="gq_qd_giai_quyet_noi_dung"></textarea>
                    </div>
                </div>

                <div id="kiem_sat_gq_don_section" class="dynamic-section full-width" style="display: none;">
                    <h3>Kiểm sát giải quyết đơn (Thẩm quyền Kiểm sát)</h3>
                    
                    <div class="form-sub-group">
                        <label for="ks_chuyen_den_co_quan">Chuyển đến cơ quan nào:</label>
                        <select id="ks_chuyen_den_co_quan">
                            <option value="Chọn">--Chọn cơ quan--</option>
                            <option value="TAND TP.CT">TAND TP.CT</option>
                            <option value="THADS TP.CT">THADS TP.CT</option>
                            <option value="CQCSĐT CA TP.CT">CQCSĐT CA TP.CT</option>
                        </select>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>Quyết định giải quyết khiếu nại:</label>
                        <input type="text" placeholder="Số Quyết định" id="ks_quyet_dinh_so">
                        <input type="date" placeholder="Ngày Quyết định" id="ks_quyet_dinh_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="ks_quyet_dinh_noi_dung"></textarea>
                        <input type="text" placeholder="Cơ quan ban hành" id="ks_quyet_dinh_co_quan">
                    </div>
                </div>
                
                <input type="hidden" id="edit-id">
                <button onclick="saveDon()">Kết thúc nhập</button>
            </div>

            <div class="main-panel">
                <h2>Danh sách theo dõi đơn</h2>
                <div class="btn-container" style="margin-bottom: 20px;">
                    <button onclick="exportList()">Xuất Danh sách đơn</button>
                    <button onclick="showReportModal()">Xuất Báo cáo Thống kê</button>
                    <button onclick="downloadJSON()">Sao lưu JSON</button>
                    <button class="export-btn" onclick="downloadProposalDoc(currentSelectedId)">Xuất Phiếu Đề Xuất</button>
                    <button class="export-btn" onclick="downloadResultExtractionDoc(currentSelectedId)">Xuất Kết Quả xử lý đơn</button>
                </div>
                <div class="search-bar" style="margin-bottom: 20px;">
                    <input type="text" id="search-text" placeholder="Tìm kiếm theo Họ tên/Cơ quan/Tổ chức..." style="padding: 8px; width: 40%; border: 1px solid #ccc; border-radius: 4px;">
                    <input type="date" id="search-date" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <button class="search-btn" onclick="filterTable()">Tìm Kiếm</button>
                    <button class="reset-btn" onclick="resetFilter()">Xóa Bộ Lọc</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ngày nhận đơn</th>
                            <th>Họ tên /CQ/ TC</th>
                            <th>Nội dung đơn</th>
                            <th>Phân loại</th>
                            <th>Thẩm quyền</th>
                            <th>Xử lý đơn</th> 
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="don-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('accountsModal').style.display='none'">&times;</span>
            <h3>Quản lý Tài khoản</h3>
            <h4>Tạo tài khoản mới</h4>
            <div class="form-section">
                <div class="form-group">
                    <label for="new-username">Tên đăng nhập:</label>
                    <input type="text" id="new-username">
                </div>
                <div class="form-group">
                    <label for="new-password">Mật khẩu:</label>
                    <input type="password" id="new-password">
                </div>
                <div class="form-group">
                    <label for="new-role">Vai trò:</label>
                    <select id="new-role">
                        <option value="admin">Quản trị viên (admin)</option>
                        <option value="manager_TP">Lãnh đạo cấp Thành phố</option>
                        <option value="user_TP">Cán bộ cấp Thành phố</option>
                        <option value="manager_KV">Lãnh đạo cấp Khu vực</option>
                        <option value="user_KV">Cán bộ cấp Khu vực</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-unit">Đơn vị:</label>
                    <select id="new-unit"></select>
                </div>
            </div>
            <button onclick="createAccount()">Tạo tài khoản</button>
            <h4>Danh sách tài khoản</h4>
            <ul id="account-list"></ul>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('reportModal').style.display='none'">&times;</span>
            <h3>Cấu hình Xuất Báo cáo Thống kê</h3>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="report-month">Tháng/Năm báo cáo:</label>
                    <input type="month" id="report-month" value="${new Date().toISOString().slice(0, 7)}">
                </div>
                 <div class="form-group">
                    <label for="report-level">Cấp báo cáo:</label>
                    <select id="report-level">
                        <option value="all">Tất cả (Thành phố & Khu vực)</option>
                        <option value="TP">Cấp Thành phố (TT-KT)</option>
                        <option value="KV">Cấp Khu vực (VKSND KV)</option>
                    </select>
                </div>
            </div>

            <p style="margin-top: 20px;">* Báo cáo sẽ tổng hợp dữ liệu đơn theo tiêu chí đã chọn.</p>
            
            <div class="btn-container modal-footer">
                <button onclick="exportReport()">Tạo & Tải Báo cáo</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
            <h3>Sửa đổi đơn</h3>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_nhan">Ngày nhận đơn:</label>
                    <input type="date" id="sua-ngay_nhan">
                </div>
                <div class="form-group">
                    <label for="sua-nguon_don">Nguồn đơn:</label>
                    <select id="sua-nguon_don"></select>
                </div>
            </div>
            <div class="form-section full-width">
                <div class="form-group">
                    <label for="sua-ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                    <input type="text" id="sua-ho_ten" onblur="checkDuplicateName('sua-')">
                </div>
                <div class="form-group">
                    <label for="sua-dia_chi">Địa chỉ:</label>
                    <input type="text" id="sua-dia_chi">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_ghi">Đơn ghi ngày:</label>
                    <input type="date" id="sua-ngay_ghi">
                </div>
                <div class="form-group">
                    <label for="sua-phan_loai">Phân loại:</label>
                    <select id="sua-phan_loai" onchange="capNhatThamQuyenMacDinh('sua-')">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-tham_quyen">Thẩm quyền:</label>
                    <select id="sua-tham_quyen" onchange="updateDynamicFields('sua-')">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                        <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                        <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-can_bo_phan_cong">Cán bộ phân công:</label>
                    <input type="text" id="sua-can_bo_phan_cong">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-chuc_danh">Chức danh:</label>
                    <select id="sua-chuc_danh">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                        <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                        <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                        <option value="Kiểm tra viên">Kiểm tra viên</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-chuyen_den">Chuyển đến (Xử lý ban đầu):</label>
                    <select id="sua-chuyen_den"></select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_chuyen_don">Ngày chuyển đơn (Xử lý ban đầu):</label>
                    <input type="date" id="sua-ngay_chuyen_don">
                </div>
            </div>
             <div class="form-group full-width">
                <label>Căn cứ:</label>
                <div id="sua-can_cu_container"></div>
                <button onclick="addCanCu('sua-')">Thêm căn cứ</button>
            </div>
            <div class="form-group full-width">
                <label for="sua-noi_dung">Nội dung đơn:</label>
                <textarea id="sua-noi_dung"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-de_xuat">Đề xuất:</label>
                <textarea id="sua-de_xuat"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-ket_qua">Kết quả (Xử lý chung):</label>
                <textarea id="sua-ket_qua"></textarea>
            </div>
            
             <div id="sua-giai_quyet_kn_section" class="dynamic-section full-width" style="display: none;">
                <h3>Giải quyết khiếu nại (Thẩm quyền Giải quyết)</h3>
                
                <div class="form-sub-group">
                    <label>1. Quyết định phân công:</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-gq_phan_cong_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-gq_phan_cong_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-gq_phan_cong_noi_dung"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>2. Kế hoạch xác minh:</label>
                    <input type="text" placeholder="Số Kế hoạch" id="sua-gq_ke_hoach_so">
                    <input type="date" placeholder="Ngày Kế hoạch" id="sua-gq_ke_hoach_ngay">
                    <textarea placeholder="Nội dung Kế hoạch" id="sua-gq_ke_hoach_noi_dung"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>3. Đơn vị phối hợp:</label>
                    <select id="sua-gq_dv_phoi_hop_don_vi" required>
                         <option value="">-- Chọn Đơn vị phối hợp --</option>
                         <option value="Phòng 1">Phòng 1</option>
                        <option value="Phòng 2">Phòng 2</option>
                         <option value="Phòng 7">Phòng 7</option>
                         <option value="Phòng 8">Phòng 8</option>
                         <option value="Phòng 9">Phòng 9</option>
                         <option value="Phòng 10">Phòng 10</option>
                         <option value="Phòng 11">Phòng 11</option>
                         <option value="Phòng 15">Phòng 15</option>
                          <option value="Phòng khác">Phòng khác</option>
                    </select>
            <textarea placeholder="Nội dung phối hợp" id="sua-gq_dv_phoi_hop_noi_dung"></textarea>
                </div>
                <div class="form-sub-group">
                     <label>4. Đề xuất hướng giải quyết:</label>
                     <textarea placeholder="Nội dung Đề xuất chi tiết" id="sua-gq_de_xuat_chi_tiet"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>5. Quyết định giải quyết khiếu nại (Lần 1):</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-gq_qd_giai_quyet_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-gq_qd_giai_quyet_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-gq_qd_giai_quyet_noi_dung"></textarea>
                </div>
            </div>

            <div id="sua-kiem_sat_gq_don_section" class="dynamic-section full-width" style="display: none;">
                <h3>Kiểm sát giải quyết đơn (Thẩm quyền Kiểm sát)</h3>
                
                <div class="form-sub-group">
                    <label for="sua-ks_chuyen_den_co_quan">Chuyển đến cơ quan nào:</label>
                    <select id="sua-ks_chuyen_den_co_quan">
                        <option value="Chọn">--Chọn cơ quan--</option>
                        <option value="TAND TP.CT">TAND TP.CT</option>
                        <option value="THADS TP.CT">THADS TP.CT</option>
                        <option value="CQCSĐT CA TP.CT">CQCSĐT CA TP.CT</option>
                    </select>
                </div>
                
                <div class="form-sub-group">
                    <label>Quyết định giải quyết khiếu nại:</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-ks_quyet_dinh_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-ks_quyet_dinh_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-ks_quyet_dinh_noi_dung"></textarea>
                    <input type="text" placeholder="Cơ quan ban hành" id="sua-ks_quyet_dinh_co_quan">
                </div>
            </div>
            
            <input type="hidden" id="edit-id-modal"> 
            <div class="btn-container modal-footer">
                <button onclick="updateDon()">Cập nhật</button>
            </div>
        </div>
    </div>
    
    <div id="changePassModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('changePassModal').style.display='none'">&times;</span>
            <h3>Đổi mật khẩu</h3>
            <div class="form-group">
                <label for="old-password">Mật khẩu cũ:</label>
                <input type="password" id="old-password">
            </div>
            <div class="form-group">
                <label for="new-password-change">Mật khẩu mới:</label>
                <input type="password" id="new-password-change">
            </div>
            <div class="form-group">
                <label for="confirm-password-change">Xác nhận mật khẩu mới:</label>
                <input type="password" id="confirm-password-change">
            </div>
            <div class="btn-container modal-footer">
                <button onclick="changePassword()">Xác nhận</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. FIREBASE CONFIGURATION & INITIALIZATION (PHẢI THAY THẾ) ---
        // THAY THẾ CHỖ NÀY BẰNG CẤU HÌNH CỦA BẠN
        const firebaseConfig = {
            apiKey: "AIzaSyBvhrOBoJc9-gKuTAXDlPknVdxKecgPH_g",
            authDomain: "quanlydonvks-d7ff9.firebaseapp.com",
            databaseURL: "https://quanlydonvks-d7ff9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quanlydonvks-d7ff9",
            storageBucket: "quanlydonvks-d7ff9.firebasestorage.app",
            messagingSenderId: "209768483000",
            appId: "1:209768483000:web:1eb449ad41840e23334c4d"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- GLOBAL DATA & INITIALIZATION ---
        let accounts = {}; // Dữ liệu tài khoản (tải từ Firebase)
        let dons = []; // Dữ liệu đơn (tải từ Firebase dưới dạng mảng để dễ xử lý)
        let currentUser = null;
        let currentSelectedId = null; // Thêm biến theo dõi đơn đang chọn để dùng cho export

        // Dữ liệu danh mục
        const lookupData = {
            'Nguồn đơn': [
                'Bưu điện',
                'Tiếp công dân',
                'Các cơ quan Đảng, Nhà nước',
                'UBND TPCT',
                'Cục Điều tra, VKSTC',
                'V11, VKSTC',
                'V12, VKSTC',
                'Các Sở, Ban, Ngành',
                'Thành ủy'
            ],
            'Chuyển đến': [
                'Lưu đơn',
                'Trả đơn',
                'Thông báo chỉ dẫn',
                'THADS TP.CT',
                'THADS KV1','THADS KV2','THADS KV3','THADS KV4','THADS KV5','THADS KV6','THADS KV7',
                'THADS KV8','THADS KV9','THADS KV10','THADS KV11','THADS KV12','THADS KV13','THADS KV14',
                'TAND TP.CT',
                'TAND KV1', 'TAND KV2','TAND KV3','TAND KV4','TAND KV5','TAND KV6','TAND KV7',
                'TAND KV8','TAND KV9','TAND KV10','TAND KV11','TAND KV12','TAND KV13','TAND KV14',
                'CQCSĐT TP.CT',
                'Công an phường',
                'VKSND KV1',
                'VKSND KV2',
                'VKSND KV3',
                'VKSND KV4',
                'VKSND KV5',
                'VKSND KV6',
                'VKSND KV7',
                'VKSND KV8',
                'VKSND KV9',
                'VKSND KV10',
                'VKSND KV11',
                'VKSND KV12',
                'VKSND KV13',
                'VKSND KV14',
                'Phòng 1',
                'Phòng 2',
                'Phòng 7',
                'Phòng 8',
                'Phòng 9',
                'Phòng 10',
                'Phòng 11',
                'Phòng 15'
            ],
            'Đơn vị': [
                'TT-KT',
                'VKSND KV1',
                'VKSND KV2',
                'VKSND KV3',
                'VKSND KV4',
                'VKSND KV5',
                'VKSND KV6',
                'VKSND KV7',
                'VKSND KV8',
                'VKSND KV9',
                'VKSND KV10',
                'VKSND KV11',
                'VKSND KV12',
                'VKSND KV13',
                'VKSND KV14'
            ]
        };
        
        // Danh sách cố định cho trường Văn bản trong Căn cứ
        const vanBanOptionsFinal = [
            'Quy chế số: 222/QĐ-VKSTC ngày 22/6/2023 của VKSNDTC',
            'Bộ Luật Tố tụng Hình sự',
            'Bộ Luật Tố tụng dân sự',
            'Bộ luật Tố tụng hành chính',
            'Luật THADS',
            'Tự điền vào văn bản'
        ];

        // --- AUTHENTICATION FUNCTIONS ---

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            database.ref('accounts').once('value')
                .then(snapshot => {
                    accounts = snapshot.val() || {};
                    if (accounts[username] && accounts[username].password === password) {
                        currentUser = {
                            username: username,
                            role: accounts[username].role,
                            unit: accounts[username].unit
                        };
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('main-container').style.display = 'flex';
                        document.getElementById('can_bo_phan_cong').value = currentUser.username;

                        // Hiển thị/ẩn nút quản lý tài khoản
                        if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                            document.getElementById('account-btn').style.display = 'block';
                        } else {
                            document.getElementById('account-btn').style.display = 'none';
                        }
                        
                        updateTable();
                    } else {
                        alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                    }
                })
                .catch(error => {
                    alert('Lỗi khi đăng nhập: ' + error.message);
                });
        }
        
        // ... (Các hàm logout, showChangePassModal, changePassword, handleForgotPassword, initializeDefaultAccounts, showAccountsModal, populateUnitSelect, loadAccounts, createAccount, deleteAccount, resetPassword, capNhatDonViTheoVaiTro giữ nguyên) ...

        function logout() {
            currentUser = null;
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('account-btn').style.display = 'none';
            currentSelectedId = null; // Reset ID đơn đang chọn
        }

        function showChangePassModal() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập trước.');
                return;
            }
            document.getElementById('old-password').value = '';
            document.getElementById('new-password-change').value = '';
            document.getElementById('confirm-password-change').value = '';
            document.getElementById('changePassModal').style.display = 'flex';
        }

        function changePassword() {
            const oldPass = document.getElementById('old-password').value;
            const newPass = document.getElementById('new-password-change').value;
            const confirmPass = document.getElementById('confirm-password-change').value;

            if (!currentUser) return alert('Vui lòng đăng nhập trước.');

            database.ref('accounts/' + currentUser.username).once('value').then(snap => {
                const currentAccount = snap.val();
                if (!currentAccount) return alert('Lỗi: Không tìm thấy thông tin tài khoản.');

                if (oldPass === currentAccount.password) {
                    if (newPass === confirmPass) {
                         if (newPass.length < 3) {
                             alert('Mật khẩu mới phải có ít nhất 3 ký tự.');
                             return;
                         }
                        database.ref('accounts/' + currentUser.username + '/password').set(newPass)
                            .then(() => {
                                alert('Mật khẩu đã được thay đổi thành công!');
                                document.getElementById('changePassModal').style.display = 'none';
                                accounts[currentUser.username].password = newPass;
                            }).catch(error => {
                                alert('Lỗi khi đổi mật khẩu: ' + error.message);
                            });
                    } else {
                        alert('Mật khẩu mới không khớp.');
                    }
                } else {
                    alert('Mật khẩu cũ không đúng.');
                }
            }).catch(error => {
                alert('Lỗi khi kiểm tra mật khẩu: ' + error.message);
            });
        }
        
        function handleForgotPassword() {
            const username = prompt('Vui lòng nhập tên đăng nhập của bạn:');
            if (!username) return;

            database.ref('accounts/' + username).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        if (confirm('Hệ thống sẽ đặt lại mật khẩu của bạn về "123". Vui lòng đăng nhập và đổi lại mật khẩu.')) {
                            database.ref('accounts/' + username + '/password').set('123')
                                .then(() => {
                                    alert('Đã đặt lại mật khẩu thành công!');
                                }).catch(error => {
                                    alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                                });
                        }
                    } else {
                        alert('Tên đăng nhập không tồn tại.');
                    }
                })
                .catch(error => {
                    alert('Lỗi khi kiểm tra tài khoản: ' + error.message);
                });
        }
        
        function initializeDefaultAccounts() {
             database.ref('accounts').once('value').then(snapshot => {
                 if (!snapshot.exists()) {
                     const defaultAccounts = {
                         "adminct": {
                             "password": "123",
                             "role": "admin",
                             "unit": "TT-KT"
                         },
                         "user1": {
                             "password": "123",
                             "role": "user_TP",
                             "unit": "TT-KT"
                         },
                          "userkv1": {
                              "password": "123",
                              "role": "user_KV",
                              "unit": "VKSND KV1"
                          }
                     };
                     database.ref('accounts').set(defaultAccounts)
                         .then(() => {
                             console.log('Tài khoản mặc định đã được tạo.');
                             accounts = defaultAccounts;
                         })
                         .catch(error => console.error('Lỗi khi tạo tài khoản mặc định:', error));
                 }
                 loadAccounts(); // Tải tài khoản sau khi kiểm tra
             });
        }

        function showAccountsModal() {
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin')) {
                document.getElementById('accountsModal').style.display = 'flex';
                populateUnitSelect('new-unit'); 
            } else {
                alert('Bạn không có quyền truy cập chức năng này.');
            }
        }
        
        function populateUnitSelect(id) {
            const selectElement = document.getElementById(id);
            if (!selectElement) return;
            selectElement.innerHTML = '';
            
            const selectedRole = document.getElementById('new-role') ? document.getElementById('new-role').value : 'admin';
            
            let units = [];
             if (selectedRole === 'admin' || selectedRole === 'super_admin') {
                 units = ['TT-KT'];
             } else if (selectedRole === 'manager_TP' || selectedRole === 'user_TP') {
                 units = ['TT-KT'];
             } else if (selectedRole === 'manager_KV' || selectedRole === 'user_KV') {
                  units = lookupData['Đơn vị'].filter(unit => unit.startsWith('VKSND KV'));
             } else {
                 units = lookupData['Đơn vị'];
             }
            
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                selectElement.appendChild(option);
            });
             if (units.length > 0) {
                 selectElement.value = units[0];
             }

        }
        
        function loadAccounts() {
            database.ref('accounts').on('value', (snapshot) => {
                accounts = snapshot.val() || {};
                const list = document.getElementById('account-list');
                list.innerHTML = '';
                for (let username in accounts) {
                    const account = accounts[username];
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>
                            **${username}** (Vai trò: ${account.role}, Đơn vị: ${account.unit || 'N/A'})
                        </span>
                        <div>
                             <button class="reset-btn" onclick="resetPassword('${username}')">Đặt lại Mật khẩu</button>
                             ${username !== currentUser.username ? `<button class="delete-btn" onclick="deleteAccount('${username}')">Xóa</button>` : ''}
                        </div>
                    `;
                    list.appendChild(li);
                }
            });
        }
        
        function createAccount() {
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const role = document.getElementById('new-role').value;
            const unit = document.getElementById('new-unit').value;

            if (!username || !password || !role || !unit) {
                alert('Vui lòng điền đầy đủ Tên đăng nhập, Mật khẩu, Vai trò và Đơn vị.');
                return;
            }
            if (username in accounts) {
                alert('Tên đăng nhập đã tồn tại.');
                return;
            }
             if (password.length < 3) {
                 alert('Mật khẩu phải có ít nhất 3 ký tự.');
                 return;
             }

            database.ref('accounts/' + username).set({
                password: password,
                role: role,
                unit: unit
            }).then(() => {
                alert('Tạo tài khoản thành công.');
                document.getElementById('new-username').value = '';
                document.getElementById('new-password').value = '';
            }).catch(error => {
                alert('Lỗi khi tạo tài khoản: ' + error.message);
            });
        }

        function deleteAccount(username) {
            if (confirm(`Bạn có chắc chắn muốn xóa tài khoản "${username}" không?`)) {
                database.ref('accounts/' + username).remove()
                    .then(() => {
                        alert(`Đã xóa tài khoản "${username}".`);
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa tài khoản: ' + error.message);
                    });
            }
        }
        
        function resetPassword(username) {
             if (confirm(`Bạn có chắc chắn muốn đặt lại mật khẩu tài khoản "${username}" về "123" không?`)) {
                 database.ref('accounts/' + username + '/password').set('123')
                     .then(() => {
                         alert(`Đã đặt lại mật khẩu tài khoản "${username}" về "123".`);
                     })
                     .catch(error => {
                         alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                     });
             }
        }
        
        function capNhatDonViTheoVaiTro() {
             populateUnitSelect('new-unit');
        }


        // --- DATA LOADING & INITIALIZATION ---

        function populateSelects(prefix = '') {
            const nguonDonSelect = document.getElementById(prefix + 'nguon_don');
            const chuyenDenSelect = document.getElementById(prefix + 'chuyen_den');
            
            if (nguonDonSelect) {
                nguonDonSelect.innerHTML = '<option value="Chọn">--Chọn--</option>';
                lookupData['Nguồn đơn'].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    nguonDonSelect.appendChild(option);
                });
            }
            
            if (chuyenDenSelect) {
                chuyenDenSelect.innerHTML = '<option value="Chọn">--Chọn--</option>';
                lookupData['Chuyển đến'].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    chuyenDenSelect.appendChild(option);
                });
            }
        }

        function loadData() {
            database.ref('dons').on('value', (snapshot) => {
                const data = snapshot.val();
                dons = [];
                for (let id in data) {
                    dons.push({ id: id, ...data[id] });
                }
                updateTable(dons);
            }, (error) => {
                console.error("Lỗi khi tải dữ liệu đơn:", error);
                alert("Lỗi khi tải dữ liệu đơn. Vui lòng kiểm tra kết nối hoặc quyền truy cập.");
            });
        }
        
        // --- TABLE DISPLAY & FILTERING ---

        function updateTable(filteredDons = dons) {
            const tableBody = document.getElementById('don-body');
            tableBody.innerHTML = '';
            
            if (currentUser && currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                // Lọc đơn theo đơn vị của người dùng nếu không phải admin
                filteredDons = filteredDons.filter(don => don.don_vi === currentUser.unit);
            }
            
            // Lọc theo cán bộ phân công nếu là user_TP/user_KV
            if (currentUser && (currentUser.role === 'user_TP' || currentUser.role === 'user_KV')) {
                 filteredDons = filteredDons.filter(don => don.can_bo_phan_cong === currentUser.username);
            }

            filteredDons.forEach((don, index) => {
                const row = tableBody.insertRow();
                row.onclick = () => {
                    currentSelectedId = don.id;
                    highlightSelectedRow(row);
                };
                
                // Cột STT
                row.insertCell().textContent = index + 1; 
                // Ngày nhận đơn
                row.insertCell().textContent = don.ngay_nhan || '';
                // Họ tên /CQ/ TC
                row.insertCell().textContent = don.ho_ten || '';
                // Nội dung đơn (Lấy 100 ký tự đầu)
                row.insertCell().textContent = (don.noi_dung || '').substring(0, 100) + '...';
                // Phân loại
                row.insertCell().textContent = don.phan_loai || '';
                // Thẩm quyền
                row.insertCell().textContent = don.tham_quyen || '';
                // Xử lý đơn (Chuyển đến)
                row.insertCell().textContent = don.chuyen_den || '';

                // Thao tác
                const actionsCell = row.insertCell();
                actionsCell.className = 'table-actions';
                
                const editButton = document.createElement('button');
                editButton.className = 'edit-btn';
                editButton.textContent = 'Sửa';
                editButton.onclick = (event) => {
                    event.stopPropagation(); 
                    editDon(don.id);
                };
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-btn';
                deleteButton.textContent = 'Xóa';
                deleteButton.onclick = (event) => {
                    event.stopPropagation(); 
                    deleteDon(don.id);
                };
                actionsCell.appendChild(deleteButton);
            });
        }
        
        function highlightSelectedRow(row) {
            document.querySelectorAll('#don-body tr').forEach(r => {
                r.style.backgroundColor = ''; 
                r.style.boxShadow = 'none';
                if (r.rowIndex % 2 !== 0) {
                     r.style.backgroundColor = '#f5f5f5';
                } else {
                     r.style.backgroundColor = '#fff';
                }
            });
            row.style.backgroundColor = '#bbdefb'; 
            row.style.boxShadow = '0 0 10px rgba(86, 112, 230, 0.5)';
        }

        function filterTable() {
            const searchText = document.getElementById('search-text').value.toLowerCase();
            const searchDate = document.getElementById('search-date').value;
            
            let filteredDons = dons.filter(don => {
                const matchesText = !searchText || 
                                    (don.ho_ten && don.ho_ten.toLowerCase().includes(searchText)) ||
                                    (don.noi_dung && don.noi_dung.toLowerCase().includes(searchText));
                
                const matchesDate = !searchDate || (don.ngay_nhan === searchDate);
                
                return matchesText && matchesDate;
            });
            
            // Lọc thêm theo quyền hạn
            if (currentUser && currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                filteredDons = filteredDons.filter(don => don.don_vi === currentUser.unit);
            }
            if (currentUser && (currentUser.role === 'user_TP' || currentUser.role === 'user_KV')) {
                 filteredDons = filteredDons.filter(don => don.can_bo_phan_cong === currentUser.username);
            }
            
            updateTable(filteredDons);
        }

        function resetFilter() {
            document.getElementById('search-text').value = '';
            document.getElementById('search-date').value = '';
            updateTable();
        }


        // --- FORM HANDLING: ADD, EDIT, DELETE, SAVE ---

        function capNhatThamQuyenMacDinh(prefix = '') {
            const phanLoai = document.getElementById(prefix + 'phan_loai').value;
            const thamQuyenSelect = document.getElementById(prefix + 'tham_quyen');

            if (phanLoai === 'Đề nghị KN, GĐT, TT' || phanLoai === 'Đề nghị kiểm tra QĐGQKN' || phanLoai === 'Tin báo/Tố giác tội phạm trong HĐTP') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền kiểm sát';
            } else if (phanLoai === 'Khiếu nại' || phanLoai === 'Tố cáo' || phanLoai === 'Yêu cầu bồi thường thiệt hại') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền giải quyết';
            } else {
                // Giữ nguyên giá trị hiện tại hoặc đặt về "Chọn"
            }
            // Gọi lại updateDynamicFields để cập nhật hiển thị form
            updateDynamicFields(prefix);
        }

        function updateDynamicFields(prefix = '') {
            const thamQuyen = document.getElementById(prefix + 'tham_quyen').value;
            const giaiQuyetSection = document.getElementById(prefix + 'giai_quyet_kn_section');
            const kiemSatSection = document.getElementById(prefix + 'kiem_sat_gq_don_section');

            if (thamQuyen === 'Thuộc thẩm quyền giải quyết') {
                giaiQuyetSection.style.display = 'block';
                kiemSatSection.style.display = 'none';
            } else if (thamQuyen === 'Thuộc thẩm quyền kiểm sát') {
                giaiQuyetSection.style.display = 'none';
                kiemSatSection.style.display = 'block';
            } else { // Không thuộc thẩm quyền hoặc Chọn
                giaiQuyetSection.style.display = 'none';
                kiemSatSection.style.display = 'none';
            }
        }
        
        function addCanCu(prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            const newItem = document.createElement('div');
            newItem.className = 'can-cu-item';
            
            let vanBanSelectHtml = '<select class="can-cu-van-ban" onchange="updateVanBanInputVisibility(this)">';
            vanBanSelectHtml += '<option value="">Chọn Văn bản/Quy chế</option>'; 
            vanBanOptionsFinal.forEach(option => {
                vanBanSelectHtml += `<option value="${option}">${option}</option>`;
            });
            vanBanSelectHtml += '</select>';
            
            let customInputHtml = '<input type="text" placeholder="Tự điền Văn bản/Quy chế..." class="can-cu-van-ban-custom" style="display: none; margin-top: 5px;">';


            newItem.innerHTML = `
                <input type="text" placeholder="Điểm" class="can-cu-diem" value="">
                <input type="number" placeholder="Khoản" class="can-cu-khoan" value="">
                <input type="number" placeholder="Điều" class="can-cu-dieu" value="">
                <div style="display: flex; flex-direction: column;">
                     ${vanBanSelectHtml}
                     ${customInputHtml}
                </div>
                <button onclick="this.parentNode.remove()">Xóa</button>
            `;
            container.appendChild(newItem);
        }
        
        // Hàm lấy dữ liệu căn cứ (Giữ nguyên)
        function getCanCuData(prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            const items = container.querySelectorAll('.can-cu-item');
            const canCuList = [];
            items.forEach(item => {
                const diem = item.querySelector('.can-cu-diem').value.trim();
                const khoan = item.querySelector('.can-cu-khoan').value.trim();
                const dieu = item.querySelector('.can-cu-dieu').value.trim();
                const vanBanSelect = item.querySelector('.can-cu-van-ban');
                const customInput = item.querySelector('.can-cu-van-ban-custom');
                
                let van_ban = '';
                
                if (vanBanSelect.value === 'Tự điền vào văn bản' && customInput) {
                    van_ban = customInput.value.trim();
                } else {
                    van_ban = vanBanSelect.value.trim();
                }
                
                if (diem || khoan || dieu || van_ban) {
                     canCuList.push({ diem, khoan, dieu, van_ban });
                }
            });
            return canCuList;
        }

        // Hàm hiển thị căn cứ khi sửa đơn (Giữ nguyên)
        function populateCanCuFields(canCuList, prefix = '') {
             const container = document.getElementById(prefix + 'can_cu_container');
             container.innerHTML = '';
             
             if (!canCuList || canCuList.length === 0) {
                 addCanCu(prefix);
                 return;
             }
             
             canCuList.forEach(item => {
                 let vanBanValue = item.van_ban || '';
                 let customInputValue = '';
                 
                 let isCustomValue = vanBanValue && !vanBanOptionsFinal.includes(vanBanValue);

                 let selectValue = vanBanValue;
                 if (isCustomValue) {
                     selectValue = 'Tự điền vào văn bản'; 
                     customInputValue = vanBanValue; 
                 } else if (vanBanValue === 'Tự điền vào văn bản') {
                     selectValue = 'Tự điền vào văn bản';
                     customInputValue = ''; 
                 }
                 
                 let vanBanSelectHtml = `<select class="can-cu-van-ban" onchange="updateVanBanInputVisibility(this)">`;
                 vanBanSelectHtml += `<option value="" ${selectValue === '' ? 'selected' : ''}>Chọn Văn bản/Quy chế</option>`;
                 
                 vanBanOptionsFinal.forEach(option => {
                     const selected = (option === selectValue) ? 'selected' : '';
                     vanBanSelectHtml += `<option value="${option}" ${selected}>${option}</option>`;
                 });
                 vanBanSelectHtml += '</select>';
                 
                 let customInputDisplay = (selectValue === 'Tự điền vào văn bản' || isCustomValue) ? 'block' : 'none';
                 let customInputRequired = (selectValue === 'Tự điền vào văn bản' || isCustomValue) ? 'required' : '';
                 let customInputHtml = `<input type="text" placeholder="Tự điền Văn bản/Quy chế..." class="can-cu-van-ban-custom" style="display: ${customInputDisplay}; margin-top: 5px;" value="${customInputValue}" ${customInputRequired}>`;


                 const newItem = document.createElement('div');
                 newItem.className = 'can-cu-item';
                 newItem.innerHTML = `
                     <input type="text" placeholder="Điểm" class="can-cu-diem" value="${item.diem || ''}">
                     <input type="number" placeholder="Khoản" class="can-cu-khoan" value="${item.khoan || ''}">
                     <input type="number" placeholder="Điều" class="can-cu-dieu" value="${item.dieu || ''}">
                     <div style="display: flex; flex-direction: column;">
                          ${vanBanSelectHtml}
                          ${customInputHtml}
                     </div>
                     <button onclick="this.parentNode.remove()">Xóa</button>
                 `;
                 container.appendChild(newItem);
             });
        }
        
        function getGiaiQuyetKNData(prefix = '') {
            const thamQuyen = document.getElementById(prefix + 'tham_quyen')?.value;
            if (thamQuyen !== 'Thuộc thẩm quyền giải quyết') return {};

            // Dữ liệu cho Giải quyết khiếu nại (thuộc thẩm quyền)
            return {
                gq_phan_cong_so: document.getElementById(prefix + 'gq_phan_cong_so')?.value || '',
                gq_phan_cong_ngay: document.getElementById(prefix + 'gq_phan_cong_ngay')?.value || '',
                gq_phan_cong_noi_dung: document.getElementById(prefix + 'gq_phan_cong_noi_dung')?.value || '',
                
                gq_ke_hoach_so: document.getElementById(prefix + 'gq_ke_hoach_so')?.value || '',
                gq_ke_hoach_ngay: document.getElementById(prefix + 'gq_ke_hoach_ngay')?.value || '',
                gq_ke_hoach_noi_dung: document.getElementById(prefix + 'gq_ke_hoach_noi_dung')?.value || '',
                
                // ĐÃ SỬA: Đơn vị phối hợp
                gq_dv_phoi_hop_don_vi: document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi')?.value || '',
                gq_dv_phoi_hop_noi_dung: document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung')?.value || '',
                
                gq_de_xuat_chi_tiet: document.getElementById(prefix + 'gq_de_xuat_chi_tiet')?.value || '',
                
                gq_qd_giai_quyet_so: document.getElementById(prefix + 'gq_qd_giai_quyet_so')?.value || '',
                gq_qd_giai_quyet_ngay: document.getElementById(prefix + 'gq_qd_giai_quyet_ngay')?.value || '',
                gq_qd_giai_quyet_noi_dung: document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung')?.value || ''
            };
        }
        
        function populateGiaiQuyetKNFields(data, prefix = '') {
            if (!data) return;
            
            // Dữ liệu cho Giải quyết khiếu nại (thuộc thẩm quyền)
            if (document.getElementById(prefix + 'gq_phan_cong_so')) document.getElementById(prefix + 'gq_phan_cong_so').value = data.gq_phan_cong_so || '';
            if (document.getElementById(prefix + 'gq_phan_cong_ngay')) document.getElementById(prefix + 'gq_phan_cong_ngay').value = data.gq_phan_cong_ngay || '';
            if (document.getElementById(prefix + 'gq_phan_cong_noi_dung')) document.getElementById(prefix + 'gq_phan_cong_noi_dung').value = data.gq_phan_cong_noi_dung || '';
            
            if (document.getElementById(prefix + 'gq_ke_hoach_so')) document.getElementById(prefix + 'gq_ke_hoach_so').value = data.gq_ke_hoach_so || '';
            if (document.getElementById(prefix + 'gq_ke_hoach_ngay')) document.getElementById(prefix + 'gq_ke_hoach_ngay').value = data.gq_ke_hoach_ngay || '';
            if (document.getElementById(prefix + 'gq_ke_hoach_noi_dung')) document.getElementById(prefix + 'gq_ke_hoach_noi_dung').value = data.gq_ke_hoach_noi_dung || '';

            // ĐÃ SỬA: Đơn vị phối hợp
            if (document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi')) document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi').value = data.gq_dv_phoi_hop_don_vi || '';
            if (document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung')) document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung').value = data.gq_dv_phoi_hop_noi_dung || '';
            
            if (document.getElementById(prefix + 'gq_de_xuat_chi_tiet')) document.getElementById(prefix + 'gq_de_xuat_chi_tiet').value = data.gq_de_xuat_chi_tiet || '';
            
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_so')) document.getElementById(prefix + 'gq_qd_giai_quyet_so').value = data.gq_qd_giai_quyet_so || '';
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_ngay')) document.getElementById(prefix + 'gq_qd_giai_quyet_ngay').value = data.gq_qd_giai_quyet_ngay || '';
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung')) document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung').value = data.gq_qd_giai_quyet_noi_dung || '';
        }
        
        function getKiemSatGQDonData(prefix = '') {
            const thamQuyen = document.getElementById(prefix + 'tham_quyen')?.value;
            if (thamQuyen !== 'Thuộc thẩm quyền kiểm sát') return {};
            
            // Dữ liệu cho Kiểm sát giải quyết đơn
            return {
                ks_chuyen_den_co_quan: document.getElementById(prefix + 'ks_chuyen_den_co_quan')?.value || '',
                ks_quyet_dinh_so: document.getElementById(prefix + 'ks_quyet_dinh_so')?.value || '',
                ks_quyet_dinh_ngay: document.getElementById(prefix + 'ks_quyet_dinh_ngay')?.value || '',
                ks_quyet_dinh_noi_dung: document.getElementById(prefix + 'ks_quyet_dinh_noi_dung')?.value || '',
                ks_quyet_dinh_co_quan: document.getElementById(prefix + 'ks_quyet_dinh_co_quan')?.value || ''
            };
        }
        
        function populateKiemSatGQDonFields(data, prefix = '') {
            if (!data) return;
            
            // Dữ liệu cho Kiểm sát giải quyết đơn
            if (document.getElementById(prefix + 'ks_chuyen_den_co_quan')) document.getElementById(prefix + 'ks_chuyen_den_co_quan').value = data.ks_chuyen_den_co_quan || 'Chọn';
            if (document.getElementById(prefix + 'ks_quyet_dinh_so')) document.getElementById(prefix + 'ks_quyet_dinh_so').value = data.ks_quyet_dinh_so || '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_ngay')) document.getElementById(prefix + 'ks_quyet_dinh_ngay').value = data.ks_quyet_dinh_ngay || '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_noi_dung')) document.getElementById(prefix + 'ks_quyet_dinh_noi_dung').value = data.ks_quyet_dinh_noi_dung || '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_co_quan')) document.getElementById(prefix + 'ks_quyet_dinh_co_quan').value = data.ks_quyet_dinh_co_quan || '';
        }

        function saveDon() {
            const ngay_nhan = document.getElementById('ngay_nhan').value;
            const nguon_don = document.getElementById('nguon_don').value;
            const ho_ten = document.getElementById('ho_ten').value;
            const dia_chi = document.getElementById('dia_chi').value;
            const ngay_ghi = document.getElementById('ngay_ghi').value;
            const phan_loai = document.getElementById('phan_loai').value;
            const tham_quyen = document.getElementById('tham_quyen').value;
            const can_bo_phan_cong = document.getElementById('can_bo_phan_cong').value;
            const chuc_danh = document.getElementById('chuc_danh').value;
            const chuyen_den = document.getElementById('chuyen_den').value;
            const ngay_chuyen_don = document.getElementById('ngay_chuyen_don').value;
            const noi_dung = document.getElementById('noi_dung').value;
            const de_xuat = document.getElementById('de_xuat').value;
            const ket_qua = document.getElementById('ket_qua').value;
            const can_cu = getCanCuData();
            const don_vi = currentUser ? currentUser.unit : 'N/A';
            
            // Dữ liệu cho phần giải quyết/kiểm sát
            const giai_quyet_kn_data = getGiaiQuyetKNData();
            const kiem_sat_gq_don_data = getKiemSatGQDonData();

            if (!ngay_nhan || !ho_ten || !phan_loai || !tham_quyen) {
                alert('Vui lòng điền các trường bắt buộc: Ngày nhận đơn, Họ tên, Phân loại, Thẩm quyền.');
                return;
            }

            const newDon = {
                ngay_nhan,
                nguon_don,
                ho_ten,
                dia_chi,
                ngay_ghi,
                phan_loai,
                tham_quyen,
                can_bo_phan_cong,
                chuc_danh,
                chuyen_den,
                ngay_chuyen_don,
                noi_dung,
                de_xuat,
                ket_qua,
                don_vi,
                can_cu,
                ...giai_quyet_kn_data,
                ...kiem_sat_gq_don_data,
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            };
            
            // Check for edit mode
            const editId = document.getElementById('edit-id').value;
            if (editId) {
                database.ref('dons/' + editId).update(newDon)
                    .then(() => {
                        alert('Cập nhật đơn thành công!');
                        clearForm();
                    })
                    .catch(error => {
                        alert('Lỗi khi cập nhật đơn: ' + error.message);
                    });
            } else {
                database.ref('dons').push(newDon)
                    .then(() => {
                        alert('Lưu đơn mới thành công!');
                        clearForm();
                    })
                    .catch(error => {
                        alert('Lỗi khi lưu đơn: ' + error.message);
                    });
            }
        }
        
        function clearForm(prefix = '') {
            document.getElementById(prefix + 'ngay_nhan').value = '';
            document.getElementById(prefix + 'nguon_don').value = 'Chọn';
            document.getElementById(prefix + 'ho_ten').value = '';
            document.getElementById(prefix + 'dia_chi').value = '';
            document.getElementById(prefix + 'ngay_ghi').value = '';
            document.getElementById(prefix + 'phan_loai').value = 'Khiếu nại'; // Mặc định
            document.getElementById(prefix + 'tham_quyen').value = 'Chọn';
            document.getElementById(prefix + 'chuc_danh').value = 'Chọn';
            document.getElementById(prefix + 'chuyen_den').value = 'Chọn';
            document.getElementById(prefix + 'ngay_chuyen_don').value = '';
            document.getElementById(prefix + 'noi_dung').value = '';
            document.getElementById(prefix + 'de_xuat').value = '';
            document.getElementById(prefix + 'ket_qua').value = '';
            
            if (prefix === '') {
                 document.getElementById('edit-id').value = '';
                 document.getElementById('can_bo_phan_cong').value = currentUser ? currentUser.username : '';
            } else {
                // Clear can_bo_phan_cong for sua- form if needed, but usually it's pre-filled
                // document.getElementById('sua-can_bo_phan_cong').value = '';
            }
            
            // Clear dynamic sections
            document.getElementById(prefix + 'giai_quyet_kn_section').style.display = 'none';
            document.getElementById(prefix + 'kiem_sat_gq_don_section').style.display = 'none';

            // Clear Căn cứ fields
            populateCanCuFields([], prefix);
            
            // Clear Giải quyết KN fields
            if (document.getElementById(prefix + 'gq_phan_cong_so')) document.getElementById(prefix + 'gq_phan_cong_so').value = '';
            if (document.getElementById(prefix + 'gq_phan_cong_ngay')) document.getElementById(prefix + 'gq_phan_cong_ngay').value = '';
            if (document.getElementById(prefix + 'gq_phan_cong_noi_dung')) document.getElementById(prefix + 'gq_phan_cong_noi_dung').value = '';
            
            if (document.getElementById(prefix + 'gq_ke_hoach_so')) document.getElementById(prefix + 'gq_ke_hoach_so').value = '';
            if (document.getElementById(prefix + 'gq_ke_hoach_ngay')) document.getElementById(prefix + 'gq_ke_hoach_ngay').value = '';
            if (document.getElementById(prefix + 'gq_ke_hoach_noi_dung')) document.getElementById(prefix + 'gq_ke_hoach_noi_dung').value = '';

            // ĐÃ SỬA: Đơn vị phối hợp
            if (document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi')) document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi').value = '';
            if (document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung')) document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung').value = '';

            if (document.getElementById(prefix + 'gq_de_xuat_chi_tiet')) document.getElementById(prefix + 'gq_de_xuat_chi_tiet').value = '';
            
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_so')) document.getElementById(prefix + 'gq_qd_giai_quyet_so').value = '';
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_ngay')) document.getElementById(prefix + 'gq_qd_giai_quyet_ngay').value = '';
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung')) document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung').value = '';

            // Clear Kiểm sát GQ fields
            if (document.getElementById(prefix + 'ks_chuyen_den_co_quan')) document.getElementById(prefix + 'ks_chuyen_den_co_quan').value = 'Chọn';
            if (document.getElementById(prefix + 'ks_quyet_dinh_so')) document.getElementById(prefix + 'ks_quyet_dinh_so').value = '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_ngay')) document.getElementById(prefix + 'ks_quyet_dinh_ngay').value = '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_noi_dung')) document.getElementById(prefix + 'ks_quyet_dinh_noi_dung').value = '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_co_quan')) document.getElementById(prefix + 'ks_quyet_dinh_co_quan').value = '';
        }

        function editDon(id) {
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert('Không tìm thấy đơn để sửa.');
                return;
            }

            // Gán ID cho modal
            document.getElementById('edit-id-modal').value = id; 

            // Điền dữ liệu cơ bản
            document.getElementById('sua-ngay_nhan').value = don.ngay_nhan || '';
            document.getElementById('sua-nguon_don').value = don.nguon_don || 'Chọn';
            document.getElementById('sua-ho_ten').value = don.ho_ten || '';
            document.getElementById('sua-dia_chi').value = don.dia_chi || '';
            document.getElementById('sua-ngay_ghi').value = don.ngay_ghi || '';
            document.getElementById('sua-phan_loai').value = don.phan_loai || 'Khiếu nại'; 
            document.getElementById('sua-tham_quyen').value = don.tham_quyen || 'Chọn';
            document.getElementById('sua-can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('sua-chuc_danh').value = don.chuc_danh || 'Chọn';
            document.getElementById('sua-chuyen_den').value = don.chuyen_den || 'Chọn';
            document.getElementById('sua-ngay_chuyen_don').value = don.ngay_chuyen_don || '';
            document.getElementById('sua-noi_dung').value = don.noi_dung || '';
            document.getElementById('sua-de_xuat').value = don.de_xuat || '';
            document.getElementById('sua-ket_qua').value = don.ket_qua || '';
            
            // Căn cứ
            populateCanCuFields(don.can_cu, 'sua-'); 

            // Cập nhật hiển thị form động
            updateDynamicFields('sua-');
            
            // Điền dữ liệu cho phần giải quyết/kiểm sát
            if (don.tham_quyen === 'Thuộc thẩm quyền giải quyết') {
                populateGiaiQuyetKNFields(don, 'sua-');
                // Đảm bảo các trường kiểm sát bị xóa khi mở form
                populateKiemSatGQDonFields({}, 'sua-'); 
            } else if (don.tham_quyen === 'Thuộc thẩm quyền kiểm sát') {
                populateKiemSatGQDonFields(don, 'sua-');
                // Đảm bảo các trường giải quyết bị xóa khi mở form
                 populateGiaiQuyetKNFields({}, 'sua-');
            } else {
                 populateGiaiQuyetKNFields({}, 'sua-');
                 populateKiemSatGQDonFields({}, 'sua-');
            }


            document.getElementById('editModal').style.display = 'flex';
        }

        function updateDon() {
            const id = document.getElementById('edit-id-modal').value;
            if (!id) {
                alert('Lỗi: Không tìm thấy ID đơn để cập nhật.');
                return;
            }
            
            // Lấy dữ liệu từ form sửa đổi
            const ngay_nhan = document.getElementById('sua-ngay_nhan').value;
            const nguon_don = document.getElementById('sua-nguon_don').value;
            const ho_ten = document.getElementById('sua-ho_ten').value;
            const dia_chi = document.getElementById('sua-dia_chi').value;
            const ngay_ghi = document.getElementById('sua-ngay_ghi').value;
            const phan_loai = document.getElementById('sua-phan_loai').value;
            const tham_quyen = document.getElementById('sua-tham_quyen').value;
            const can_bo_phan_cong = document.getElementById('sua-can_bo_phan_cong').value;
            const chuc_danh = document.getElementById('sua-chuc_danh').value;
            const chuyen_den = document.getElementById('sua-chuyen_den').value;
            const ngay_chuyen_don = document.getElementById('sua-ngay_chuyen_don').value;
            const noi_dung = document.getElementById('sua-noi_dung').value;
            const de_xuat = document.getElementById('sua-de_xuat').value;
            const ket_qua = document.getElementById('sua-ket_qua').value;
            const can_cu = getCanCuData('sua-');
            
            // Đơn vị (không thay đổi)
            const oldDon = dons.find(d => d.id === id);
            const don_vi = oldDon ? oldDon.don_vi : (currentUser ? currentUser.unit : 'N/A');

            // Dữ liệu cho phần giải quyết/kiểm sát
            const giai_quyet_kn_data = getGiaiQuyetKNData('sua-');
            const kiem_sat_gq_don_data = getKiemSatGQDonData('sua-');

            if (!ngay_nhan || !ho_ten || !phan_loai || !tham_quyen) {
                alert('Vui lòng điền các trường bắt buộc: Ngày nhận đơn, Họ tên, Phân loại, Thẩm quyền.');
                return;
            }

            const updatedDon = {
                ngay_nhan,
                nguon_don,
                ho_ten,
                dia_chi,
                ngay_ghi,
                phan_loai,
                tham_quyen,
                can_bo_phan_cong,
                chuc_danh,
                chuyen_den,
                ngay_chuyen_don,
                noi_dung,
                de_xuat,
                ket_qua,
                don_vi,
                can_cu,
                ...giai_quyet_kn_data,
                ...kiem_sat_gq_don_data,
                timestamp: oldDon ? oldDon.timestamp : firebase.database.ServerValue.TIMESTAMP 
            };
            
            database.ref('dons/' + id).update(updatedDon)
                .then(() => {
                    alert('Cập nhật đơn thành công!');
                    document.getElementById('editModal').style.display = 'none';
                    clearForm('sua-'); 
                })
                .catch(error => {
                    alert('Lỗi khi cập nhật đơn: ' + error.message);
                });
        }

        function deleteDon(id) {
            if (confirm('Bạn có chắc chắn muốn xóa đơn này vĩnh viễn không?')) {
                database.ref('dons/' + id).remove()
                    .then(() => {
                        alert('Đã xóa đơn thành công!');
                        currentSelectedId = null; // Reset ID đơn đang chọn
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa đơn: ' + error.message);
                    });
            }
        }
        
        // --- REPORT & EXPORT FUNCTIONS ---
        
        function showReportModal() {
             document.getElementById('reportModal').style.display = 'flex';
        }
        
        function exportReport() {
            const reportMonth = document.getElementById('report-month').value;
            const reportLevel = document.getElementById('report-level').value;
            
            if (!reportMonth) {
                alert('Vui lòng chọn Tháng/Năm báo cáo.');
                return;
            }
            
            const [year, month] = reportMonth.split('-').map(Number);
            
            let filteredDons = dons.filter(don => {
                const donDate = don.ngay_nhan ? new Date(don.ngay_nhan) : null;
                if (!donDate) return false;
                
                // Lọc theo tháng/năm
                const matchesMonth = donDate.getFullYear() === year && (donDate.getMonth() + 1) === month;
                
                // Lọc theo cấp báo cáo (Phần này cần chỉnh sửa lại logic cho phù hợp)
                let matchesLevel = true;
                if (reportLevel === 'TP') {
                    matchesLevel = don.don_vi === 'TT-KT';
                } else if (reportLevel === 'KV') {
                    matchesLevel = don.don_vi.startsWith('VKSND KV');
                }
                
                return matchesMonth && matchesLevel;
            });
            
            if (filteredDons.length === 0) {
                 alert(`Không có dữ liệu đơn để báo cáo trong tháng ${month}/${year} theo cấp ${reportLevel}.`);
                 return;
            }
            
            // Xử lý báo cáo thống kê:
            // Tạo một mảng dữ liệu với các cột cụ thể cho báo cáo thống kê
            const reportData = [
                ["STT", "Ngày nhận", "Họ tên/Cơ quan", "Địa chỉ", "Phân loại", "Thẩm quyền", "Xử lý/Chuyển đến", "Cán bộ", "Đơn vị"]
            ];
            
            filteredDons.forEach((don, index) => {
                reportData.push([
                    index + 1,
                    don.ngay_nhan || '',
                    don.ho_ten || '',
                    don.dia_chi || '',
                    don.phan_loai || '',
                    don.tham_quyen || '',
                    don.chuyen_den || '',
                    don.can_bo_phan_cong || '',
                    don.don_vi || ''
                ]);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(reportData);
            
            // Tạo tiêu đề
            const title = `BÁO CÁO THỐNG KÊ ĐƠN KHIẾU NẠI - TỐ CÁO THÁNG ${month}/${year} - CẤP: ${reportLevel}`;
            XLSX.utils.sheet_add_aoa(ws, [[title]], { origin: "A1" });
            
            // Định dạng: Merge cells cho tiêu đề
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: reportData[0].length - 1 } }];
            
            // Thêm sheet vào workbook
            XLSX.utils.book_append_sheet(wb, ws, "Báo cáo thống kê");

            // Xuất file
            XLSX.writeFile(wb, `BaoCaoThongKe_${year}${month}_${reportLevel}.xlsx`);
            
             document.getElementById('reportModal').style.display = 'none';
        }

        function exportList() {
             let exportDons = dons;
             
             // Lọc theo quyền hạn
             if (currentUser && currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                 exportDons = exportDons.filter(don => don.don_vi === currentUser.unit);
             }
             if (currentUser && (currentUser.role === 'user_TP' || currentUser.role === 'user_KV')) {
                 exportDons = exportDons.filter(don => don.can_bo_phan_cong === currentUser.username);
             }
             
             if (exportDons.length === 0) {
                 alert('Không có dữ liệu đơn để xuất.');
                 return;
             }
             
             const data = [
                 ["ID", "Ngày nhận", "Nguồn đơn", "Họ tên/Cơ quan", "Địa chỉ", "Ngày ghi", "Phân loại", "Thẩm quyền", "Cán bộ PC", "Chức danh", "Xử lý/Chuyển đến", "Ngày chuyển", "Nội dung", "Đề xuất", "Kết quả chung", "Đơn vị", 
                  // Thêm các cột động của Giải quyết KN
                  "GQ_PC_Số", "GQ_PC_Ngày", "GQ_PC_Nội dung",
                  "GQ_KH_Số", "GQ_KH_Ngày", "GQ_KH_Nội dung",
                  "GQ_PH_Đơn vị", "GQ_PH_Nội dung", // ĐÃ SỬA
                  "GQ_ĐX_Chi tiết",
                  "GQ_QĐGQ_Số", "GQ_QĐGQ_Ngày", "GQ_QĐGQ_Nội dung",
                  // Thêm các cột động của Kiểm sát GQ
                  "KS_Chuyển đến CQ",
                  "KS_QĐGQ_Số", "KS_QĐGQ_Ngày", "KS_QĐGQ_Nội dung", "KS_QĐGQ_Cơ quan"
                 ]
             ];

             exportDons.forEach(don => {
                 data.push([
                     don.id,
                     don.ngay_nhan || '',
                     don.nguon_don || '',
                     don.ho_ten || '',
                     don.dia_chi || '',
                     don.ngay_ghi || '',
                     don.phan_loai || '',
                     don.tham_quyen || '',
                     don.can_bo_phan_cong || '',
                     don.chuc_danh || '',
                     don.chuyen_den || '',
                     don.ngay_chuyen_don || '',
                     don.noi_dung || '',
                     don.de_xuat || '',
                     don.ket_qua || '',
                     don.don_vi || '',
                     // Dữ liệu Giải quyết KN
                     don.gq_phan_cong_so || '',
                     don.gq_phan_cong_ngay || '',
                     don.gq_phan_cong_noi_dung || '',
                     don.gq_ke_hoach_so || '',
                     don.gq_ke_hoach_ngay || '',
                     don.gq_ke_hoach_noi_dung || '',
                     don.gq_dv_phoi_hop_don_vi || '', // ĐÃ SỬA
                     don.gq_dv_phoi_hop_noi_dung || '', // ĐÃ SỬA
                     don.gq_de_xuat_chi_tiet || '',
                     don.gq_qd_giai_quyet_so || '',
                     don.gq_qd_giai_quyet_ngay || '',
                     don.gq_qd_giai_quyet_noi_dung || '',
                     // Dữ liệu Kiểm sát GQ
                     don.ks_chuyen_den_co_quan || '',
                     don.ks_quyet_dinh_so || '',
                     don.ks_quyet_dinh_ngay || '',
                     don.ks_quyet_dinh_noi_dung || '',
                     don.ks_quyet_dinh_co_quan || ''
                 ]);
             });

             const ws = XLSX.utils.aoa_to_sheet(data);
             const wb = XLSX.utils.book_new();
             XLSX.utils.book_append_sheet(wb, ws, "DanhSachDon");

             XLSX.writeFile(wb, "DanhSachDon_VKS.xlsx");
        }
        
        function downloadJSON() {
            const jsonString = JSON.stringify(dons, null, 2); 
            const blob = new Blob([jsonString], { type: "application/json" });
            saveAs(blob, "backup_dons.json");
        }
        
        // --- WORD DOC EXPORT UTILITIES (Phiếu đề xuất) ---
        
        function downloadProposalDoc(id) {
            if (!id) {
                alert("Vui lòng chọn một đơn trong danh sách để xuất Phiếu Đề Xuất.");
                return;
            }
            
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert("Không tìm thấy dữ liệu đơn.");
                return;
            }
            
            // Hàm xử lý tạo nội dung docx
            const docContent = createProposalDocumentContent(don);
            
            // Tải về
            saveAs(docContent, `Phiếu Đề Xuất_${don.ho_ten || 'Don_KhieuNai'}_${don.ngay_nhan}.doc`);
        }
        
        function createProposalDocumentContent(don) {
    const today = new Date();
    const day = today.getDate().toString().padStart(2, '0');
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const year = today.getFullYear();

    // Xây dựng nội dung căn cứ (từ mảng can_cu)
    let canCuHtml = '';
    if (don.can_cu && Array.isArray(don.can_cu)) {
        don.can_cu.forEach((item, index) => {
            canCuHtml += `
                <p>Theo quy định tại điểm ${item.diem || '...'} Khoản ${item.khoan || '...'} Điều ${item.dieu || '...'} ${item.van_ban || '...'}</p>
            `;
        });
    }

    // Xử lý chi tiết giải quyết (nếu có)
    let giaiQuyetKN_Details = '';
    if (don.tham_quyen === 'Thuộc thẩm quyền giải quyết') {
        giaiQuyetKN_Details = `
            <p><b>Quyết định giải quyết (Lần 1):</b> Số ${don.gq_qd_giai_quyet_so || '...'} ngày ${don.gq_qd_giai_quyet_ngay ? new Date(don.gq_qd_giai_quyet_ngay).toLocaleDateString('vi-VN') : '...'}.</p>
            <p><b>Nội dung Quyết định:</b></p>
            <p style="text-indent: 30pt; white-space: pre-wrap;">${don.gq_qd_giai_quyet_noi_dung || '...'}</p>
        `;
    } else if (don.tham_quyen === 'Thuộc thẩm quyền kiểm sát') {
        giaiQuyetKN_Details = `
            <p><b>Cơ quan chuyển đến:</b> ${don.ks_chuyen_den_co_quan || '...'}</p>
            <p><b>Quyết định giải quyết KN của Cơ quan đó:</b> Số ${don.ks_quyet_dinh_so || '...'} ngày ${don.ks_quyet_dinh_ngay ? new Date(don.ks_quyet_dinh_ngay).toLocaleDateString('vi-VN') : '...'}. Cơ quan ban hành: ${don.ks_quyet_dinh_co_quan || '...'}.</p>
            <p><b>Nội dung Quyết định:</b></p>
            <p style="text-indent: 30pt; white-space: pre-wrap;">${don.ks_quyet_dinh_noi_dung || '...'}</p>
        `;
    } else if (don.tham_quyen === 'Không thuộc thẩm quyền') {
        giaiQuyetKN_Details = `
            <p><b>Đã Xử lý/Chuyển đến:</b> ${don.chuyen_den || '...'} (Ngày: ${don.ngay_chuyen_don ? new Date(don.ngay_chuyen_don).toLocaleDateString('vi-VN') : '...'})</p>
        `;
    }

    const content = `
        <html xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="utf-8">
            <title>Phiếu đề xuất xử lý đơn</title>
            <style>
                body { font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.5; margin: 1in; }
                p { margin: 0 0 10pt 0; text-align: justify; }
                h3, h4 { text-align: center; font-weight: bold; margin: 10pt 0; }
                table { border-collapse: collapse; }
                td { padding: 5pt; }
            </style>
        </head>
        <body>
            <table style="border: none; width: 90%;">
                <tr style="border: "width: 50%; text-align: center; border: none;">
                    <p style="text-align: right;">Mẫu số 07/KT<br>Theo QĐ số 28/QĐ-VKSTC<br>ngày 15 tháng 02 năm 2023</p>
                </tr>    
            </table>
            <table style="border: none; width: 100%;">
                <tr>
                    <td style="width: 50%; text-align: center; border: none;">
                        <b>VIỆN KIỂM SÁT NHÂN DÂN<br>THÀNH PHỐ CẦN THƠ<br>THANH TRA - KHIẾU TỐ</b>
                    </td>
                    <td style="width: 50%; text-align: center; border: none;">
                        <b>CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</b><br>
                        <b>Độc lập - Tự do - Hạnh phúc</b>
                    </td>
                </tr>
            </table>
            <table style="border: none; width: 100%;">
                <tr style="border: none;">
                    <td colspan="2" style="text-align: center; border: none;">
                        <i>Cần Thơ, ngày ${day} tháng ${month} năm ${year}</i>
                    </td>
                </tr>
            </table>
            
            <h3>PHIẾU ĐỀ XUẤT XỬ LÝ ĐƠN</h3>            
            <p>Kính gửi:<br>- Lãnh đạo Viện;<br>- Lãnh đạo Thanh tra - Khiếu tố.</p>
            
            <p>Tôi tên: ${don.can_bo_phan_cong || '...'}, chức danh: ${don.chuc_danh || '...'};<br>
            Được phân công nghiên cứu, đề xuất xử lý đối với đơn của ${don.ho_ten || '...'}, địa chỉ: ${don.dia_chi || '...'}, ghi ngày ${don.ngay_ghi ? new Date(don.ngay_ghi).toLocaleDateString('vi-VN') : '...'} (Viện kiểm sát nhân dân thành phố Cần Thơ nhận đơn ngày ${don.ngay_nhan ? new Date(don.ngay_nhan).toLocaleDateString('vi-VN') : '...'} do Bưu điện chuyển đến).</p>
            
            <p>Nội dung đơn: ${don.noi_dung || '...'}</p>
            
            ${canCuHtml}
            
            <p>Đơn nêu trên ....</p>
            <p>Tôi xin đề xuất: ${don.de_xuat || '...'}</p>
            
            <table style="width: 100%; border: none; margin-top: 30pt;">
                <tr style="border: none;">
                    <td style="width: 50%; text-align: center; border: none;">
                        <b>Phê duyệt của Lãnh đạo Viện</b><br>
                        <b>VIỆN TRƯỞNG</b><br><br><br><br>
                        Nguyễn Thanh Liêm
                    </td>
                    <td style="width: 50%; text-align: center; border: none;">
                        <b>Ngày ${day} tháng ${month} năm ${year}</b><br>
                        <b>Lãnh đạo đơn vị đề xuất</b><br>
                        <b>PHÓ CHÁNH THANH TRA</b><br><br><br><br>
                        Người đề xuất<br>
                        ${don.can_bo_phan_cong || '...'}
                    </td>
                </tr>
            </table>
        </body>
        </html>
    `;

    const html = content;
    const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
    return blob;
}

        // --- WORD DOC EXPORT UTILITIES (Kết quả xử lý đơn) ---
        
        function downloadResultExtractionDoc(id) {
            if (!id) {
                alert("Vui lòng chọn một đơn trong danh sách để xuất Kết quả xử lý đơn.");
                return;
            }
            
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert("Không tìm thấy dữ liệu đơn.");
                return;
            }
            
            const docContent = createResultExtractionDocumentContent(don);
            saveAs(docContent, `KetQuaXuLy_${don.ho_ten || 'Don_KhieuNai'}_${don.ngay_nhan}.doc`);
        }

        function createResultExtractionDocumentContent(don) {
    const today = new Date();
    const day = today.getDate().toString().padStart(2, '0');
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const year = today.getFullYear();

    // Xây dựng nội dung căn cứ
    let canCuHtml = '';
    if (don.can_cu && Array.isArray(don.can_cu)) {
        don.can_cu.forEach((item, index) => {
            canCuHtml += `
                <p>Căn cứ tại điểm ${item.diem || '...'} khoản ${item.khoan || '...'} Điều ${item.dieu || '...'} Văn bản: ${item.van_ban || '...'}</p>
            `;
        });
    }

    const content = `
        <html xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="utf-8">
            <title>Trích xuất kết quả xử lý đơn</title>
            <style>
                body { font-family: 'Times New Roman', serif; font-size: 14pt; line-height: 1.5; margin: 1in; }
                p { margin: 0 0 10pt 0; text-align: justify; }
                h3, h4 { text-align: center; font-weight: bold; margin: 10pt 0; }
            </style>
        </head>
        <body>
            <h3>TRÍCH XUẤT KẾT QUẢ XỬ LÝ ĐƠN</h3>
            
            <p>Đơn của: ${don.ho_ten || '...'}</p>
            <p>Địa chỉ: ${don.dia_chi || '...'}</p>
            <p>Đơn ghi ngày: ${don.ngay_ghi ? new Date(don.ngay_ghi).toLocaleDateString('vi-VN') : '...'}</p>
            <p>Viện kiểm sát nhân dân thành phố Cần Thơ nhận đơn ngày: ${don.ngay_nhan ? new Date(don.ngay_nhan).toLocaleDateString('vi-VN') : '...'}</p>
            <p>Nguồn đơn: ${don.nguon_don || '...'}</p>
            <p>Nội dung đơn: ${don.noi_dung || '...'}</p>
            
            ${canCuHtml}
            
            <p>Đơn nêu trên đã được xử lý: ${don.ket_qua || '...'}</p>
            <p>Ngày xử lý: ${don.ngay_xu_ly ? new Date(don.ngay_xu_ly).toLocaleDateString('vi-VN') : '...'}</p>
            
            <p style="text-align: right;">Cần Thơ, ngày ${day} tháng ${month} năm ${year}</p>
            <p style="text-align: right;"><b>CÁN BỘ TRÍCH XUẤT</b></p>
        </body>
        </html>
    `;

    const html = content;
    const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
    return blob;
}

        // --- CHECK DUPLICATE NAME ---
        function checkDuplicateName(prefix = '') {
            const currentName = document.getElementById(prefix + 'ho_ten').value.trim();
            const currentId = document.getElementById(prefix === 'sua-' ? 'edit-id-modal' : 'edit-id').value; // Chỉ kiểm tra khi là đơn mới hoặc tên khác
            if (!currentName) return;

            const duplicate = dons.some(don => 
                don.ho_ten.trim().toLowerCase() === currentName.toLowerCase() && 
                don.id !== currentId
            );

            if (duplicate) {
                if (confirm(`Có vẻ như "${currentName}" đã có đơn trong hệ thống. Bạn có muốn xem danh sách các đơn trùng lặp không?`)) {
                    document.getElementById('search-text').value = currentName;
                    filterTable();
                     // Chuyển sang main panel
                     document.querySelector('.main-panel').scrollIntoView({ behavior: 'smooth' });
                }
            }
        }

        // --- INIT FUNCTION ---
        function init() {
            initializeDefaultAccounts(); // Đảm bảo có tài khoản mặc định
            loadData(); // Tải dữ liệu đơn
            populateSelects(); // Điền dữ liệu cho các select trong form nhập mới
            populateSelects('sua-'); // Điền dữ liệu cho các select trong form sửa
            
            // Cập nhật sự kiện cho new-role khi tạo tài khoản
            const newRoleSelect = document.getElementById('new-role');
            if (newRoleSelect) {
                newRoleSelect.onchange = capNhatDonViTheoVaiTro;
                capNhatDonViTheoVaiTro();
            }

            // Khởi tạo các trường căn cứ trống
            populateCanCuFields([], '');
            populateCanCuFields([], 'sua-');
            
            // Thiết lập lắng nghe phím Enter cho đăng nhập
            setupEnterKeyListener(); 
            
            // Ẩn nút quản lý tài khoản mặc định
            const accountBtn = document.getElementById('account-btn');
            if (accountBtn) {
                accountBtn.style.display = 'none'; 
            }
        }
        
        // Thêm tính năng nghe phím Enter cho đăng nhập (Giữ nguyên)
        function setupEnterKeyListener() {
             const usernameInput = document.getElementById('username');
             const passwordInput = document.getElementById('password');
             
             if (usernameInput) {
                 usernameInput.addEventListener('keydown', function(event) {
                     if (event.key === 'Enter') {
                         event.preventDefault(); 
                         login();
                     }
                 });
             }
             if (passwordInput) {
                 passwordInput.addEventListener('keydown', function(event) {
                     if (event.key === 'Enter') {
                         event.preventDefault(); 
                         login();
                     }
                 });
             }
        }
        
        // Gọi hàm khởi tạo khi trang tải xong
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
