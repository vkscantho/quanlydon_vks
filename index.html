<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app https://*.jsdelivr.net; 
                 connect-src 'self' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.jsdelivr.net;
                 img-src 'self' data: https://vienkiemsat.cantho.gov.vn https://upload.wikimedia.org blob:;">

    <title>Hệ thống Quản Lý Đơn Khiếu nại - Tố Cáo</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    < src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        
        body {
            font-family: 'Segoe UI', 'Times New Roman', sans-serif;
            margin: 0;
            padding: 0;
            height: 10vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        }
/* Điều chỉnh thanh tiêu đề chính */
        header {
            width: 100%;
            padding: 0px;
            background-color: #0408c5;
            color: rgb(248, 245, 54);
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
/*Điều chỉnh ô đăng nhập*/    
        #login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #E6F7FF; /* Xanh dương nhạt */
            padding: 25px;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            margin: auto;
            position: absolute;
            top: 58%; /* Điều chỉnh lên xuống ô đăng nhập */
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #login-container h2 {
            margin-bottom: 20px;
            color: #D32F2F; /* Đỏ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background-color: #5670e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #login-container button:hover {
            background-color: #5670e6;
        }

        #main-container {
            display: none;
            flex-direction: column; /* Thay đổi từ row thành column để chứa menu */
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            margin-top: 20px;
        }
        
        /* CSS cho Menu Chính */
        #main-menu {
            width: 100%;
            background-color: #f7f7f7;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
        }

        #main-menu button {
            flex: 1;
            padding: 15px 10px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #fa0505;
            background-color: #edeea7;
            transition: background-color 0.3s, color 0.3s, border-bottom 0.3s;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            white-space: nowrap;
        }
        
        #main-menu button:hover {
            background-color: #e0e0e0;
        }
        
        #main-menu button.active {
            background-color: #5670e6;
            color: white;
            border-bottom: 3px solid #0408c5;
        }

        /* CSS cho các Section Nội dung (bao gồm cả section cũ) */
        .section-content {
            display: none; /* Mặc định ẩn tất cả các section nội dung */
            width: 100%;
            height: calc(100% - 60px); /* Giữ nguyên chiều cao cho nội dung chính */
            gap: 20px;
            padding: 0 20px;
        }

        #thuly-section, #kiemsat-section, #vanban-section, #giaiquyet-section {
            display: flex; /* Dùng flex cho các section */
            flex-direction: row;
        }

        /* Giao diện cũ .main-content được chuyển thành #thuly-section */
        /* .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: calc(100% - 60px);
            gap: 20px;
            padding: 0 20px;
        } */
        
        .sidebar {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .main-panel {
            flex: 2;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }
     /* Điều chỉnh kích thước các nút */   
        .sidebar button, .main-panel button {
            padding: 5px 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            background-color: #5670e6;
            transition: background-color 0.3s;
        }

        .sidebar button:hover, .main-panel button:hover {
            background-color: #5670e6;
        }
        
        .form-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-section.full-width {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }
        
        .form-sub-group {
            padding: 10px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #f7f7f7;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9f9f9;
            margin-top: 5px;
        }
        
        .form-group input[type="date"], .form-group input[type="text"] {
            margin-bottom: 5px; 
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            margin-top: 5px;
        }
        
        .can-cu-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 5px;
        }
        
        .can-cu-item > div:nth-child(4) { /* Cột 4: Văn bản */
            display: flex;
            flex-direction: column;
        }
        
        .can-cu-van-ban-custom {
            margin-top: 5px !important;
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        th {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        tr:hover {
            background-color: #e8f5e9;
        }
        
        .table-actions button {
            padding: 5px 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .table-actions td {
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

         .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 600px; 
            width: 90%;
            position: relative;
            max-height: 90vh; 
            overflow-y: auto; 
        }

      
        .modal-content.large-modal {
            max-width: 90%; 
            max-width: 1200px; 
        }
        
        
        #accountsModal .modal-content {
            max-width: 700px; 
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        
        .close-btn:hover, .close-btn:focus {
            color: #000;
        }
        
        .btn-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-start; /* CHỈNH LẠI THÀNH FLEX-START ĐỂ NÚT EXPORT Ở BÊN TRÁI */
        }
        
        .btn-container.modal-footer {
            justify-content: flex-end; /* GIỮ NGUYÊN CHO PHẦN FOOTER MODAL */
        }
        
        .delete-btn {
            background-color: #d32f2f !important;
        }
        
        .delete-btn:hover {
            background-color: #b71c1c !important;
        }
        
        .edit-btn {
            background-color: #1976d2 !important;
        }
        
        .edit-btn:hover {
            background-color: #1565c0 !important;
        }
        
        .proposal-print-btn {
            background-color: #388e3c !important; /* Green color for new print button */
            margin-top: 5px; 
        }
        
        .proposal-print-btn:hover {
            background-color: #2e7d32 !important;
        }
        
        .export-btn { /* ĐỔI TỪ export-proposal-btn sang export-btn và CHỈNH SỬA MÀU SẮC */
            background-color: #5670e6 !important;
        }
        
        .export-btn:hover {
            background-color: #435bce !important;
        }
        
      
        #proposal-content {
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            font-size: 14pt; 
            line-height: 1.5;
        }
        
        #top-right-buttons {
            position: absolute;
            top: 5px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        #account-list li {
            list-style: none;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #account-list li button {
             margin-left: 10px;
             padding: 5px 10px;
             font-size: 12px;
             width: auto;
        }
        .reset-btn {
             background-color: #ff9800 !important;
        }
        .reset-btn:hover {
             background-color: #fb8c00 !important;
        }
        
        /* CSS cho các section động mới */
        .dynamic-section h3 {
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 10px;
            border-bottom: 2px solid #5670e6;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>VIỆN KIỂM SÁT NHÂN DÂN THÀNH PHỐ CẦN THƠ</h1>
        <H2>QUẢN LÝ CÔNG TÁC KHIẾU TỐ - KIỂM SÁT HOẠT ĐỘNG TƯ PHÁP</H2>
    </header>
    <div id="login-container">
        <img src="https://vienkiemsat.cantho.gov.vn/files/images/logo-vks.png" 
             alt="Logo Viện Kiểm Sát" style="width: 120px; margin-bottom: 30px;">
        <h2>ĐĂNG NHẬP</h2>
        <input type="text" id="username" placeholder="Tên đăng nhập">
        <input type="password" id="password" placeholder="Mật khẩu">
        <button onclick="login()">Đăng Nhập</button>
        <p><a href="#" onclick="handleForgotPassword()">Quên mật khẩu?</a></p>
     <div class="footer-login">
          Cần Thơ ®2025
        </div>
    </div>
            
    <div id="main-container">
        <nav id="main-menu">
            <button id="menu-btn-thuly" class="active" onclick="showSection('thuly')">Thụ lý đơn</button>
            <button id="menu-btn-giaiquyet" onclick="showSection('giaiquyet')">Đơn thuộc thẩm quyền giải quyết</button>
            <button id="menu-btn-kiemsat" onclick="showSection('kiemsat')">Kiểm sát hoạt động tư pháp</button>
            <button id="menu-btn-vanban" onclick="showSection('vanban')">Văn bản ban hành</button>
            <button onclick="showReportModal()">Số liệu</button>
            <button onclick="downloadJSON()">Sao lưu JSON</button>
            <button onclick="document.getElementById('import-excel').click()">Nhập từ Excel</button>
            <input type="file" id="import-excel" style="display:none" onchange="handleImport(event)">
        </nav>
        
        <div id="thuly-section" class="section-content" style="display: flex;">
            <div class="sidebar">
                <div id="top-right-buttons">
                     <button id="account-btn" onclick="showAccountsModal()">Quản lý tài khoản</button>
                    <button onclick="showChangePassModal()">Đổi mật khẩu</button> 
                    <button onclick="logout()">Đăng xuất</button>
                </div>  
                <h2>Nhập đơn mới</h2>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_nhan">Ngày nhận đơn:</label>
                        <input type="date" id="ngay_nhan">
                    </div>
                    <div class="form-group">
                        <label for="nguon_don">Nguồn đơn:</label>
                        <select id="nguon_don"></select>
                    </div>
                </div>
                <div class="form-section full-width">
                    <div class="form-group">
                        <label for="ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                        <input type="text" id="ho_ten" onblur="checkDuplicateName()">
                    </div>
                    <div class="form-group">
                        <label for="dia_chi">Địa chỉ:</label>
                        <input type="text" id="dia_chi">
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_ghi">Đơn ghi ngày:</label>
                        <input type="date" id="ngay_ghi">
                    </div>
                    <div class="form-group">
                        <label for="phan_loai">Phân loại:</label>
                        <select id="phan_loai" onchange="capNhatThamQuyenMacDinh()">
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                        </select>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="tham_quyen">Thẩm quyền:</label>
                        <select id="tham_quyen" onchange="updateDynamicFields()">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                            <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                            <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="can_bo_phan_cong">Cán bộ phân công:</label>
                        <input type="text" id="can_bo_phan_cong" readonly>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="chuc_danh">Chức danh:</label>
                        <select id="chuc_danh">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                            <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                            <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                            <option value="Kiểm tra viên">Kiểm tra viên</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chuyen_den">Xử lý/Chuyển đến:</label>
                        <select id="chuyen_den"></select>
                    </div>
                </div>
                <div class="form-section">
                     <div class="form-group">
                        <label for="ngay_chuyen_don">Ngày Xử lý đơn:</label>
                        <input type="date" id="ngay_chuyen_don">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Căn cứ:</label>
                    <div id="can_cu_container"></div>
                    <button onclick="addCanCu()">Thêm căn cứ</button>
                </div>
                <div class="form-group full-width">
                    <label for="noi_dung">Nội dung đơn:</label>
                    <textarea id="noi_dung"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="de_xuat">Đề xuất:</label>
                    <textarea id="de_xuat"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="ket_qua">Kết quả (Xử lý chung):</label>
                    <textarea id="ket_qua"></textarea>
                </div>
                
                <div id="giai_quyet_kn_section" class="dynamic-section full-width" style="display: none;">
                    <h3>Giải quyết khiếu nại thuộc thẩm quyền</h3>
                    
                    <div class="form-sub-group">
                        <label>1. Quyết định phân công:</label>
                        <input type="text" placeholder="Số Quyết định" id="gq_phan_cong_so">
                        <input type="date" placeholder="Ngày Quyết định" id="gq_phan_cong_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="gq_phan_cong_noi_dung"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>2. Kế hoạch xác minh:</label>
                        <input type="text" placeholder="Số Kế hoạch" id="gq_ke_hoach_so">
                        <input type="date" placeholder="Ngày Kế hoạch" id="gq_ke_hoach_ngay">
                        <textarea placeholder="Nội dung Kế hoạch" id="gq_ke_hoach_noi_dung"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>3. Đơn vị phối hợp:</label>
                        <select id="gq_dv_phoi_hop_don_vi" required>
                            <option value="">-- Chọn Đơn vị phối hợp --</option>
                            <option value="Phòng 1">Phòng 1</option>
                            <option value="Phòng 2">Phòng 2</option>
                            <option value="Phòng 7">Phòng 7</option>
                            <option value="Phòng 8">Phòng 8</option>
                            <option value="Phòng 9">Phòng 9</option>
                            <option value="Phòng 10">Phòng 10</option>
                            <option value="Phòng 11">Phòng 11</option>
                            <option value="Phòng 15">Phòng 15</option>
                            <option value="Phòng khác">Phòng khác</option>
                        </select>
                        <textarea placeholder="Nội dung phối hợp" id="gq_dv_phoi_hop_noi_dung"></textarea>
                    </div>
                    <div class="form-sub-group">
                         <label>4. Đề xuất hướng giải quyết:</label>
                         <textarea placeholder="Nội dung Đề xuất chi tiết" id="gq_de_xuat_chi_tiet"></textarea>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>5. Quyết định giải quyết khiếu nại (Lần 1):</label>
                        <input type="text" placeholder="Số Quyết định" id="gq_qd_giai_quyet_so">
                        <input type="date" placeholder="Ngày Quyết định" id="gq_qd_giai_quyet_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="gq_qd_giai_quyet_noi_dung"></textarea>
                    </div>
                </div>

                <div id="kiem_sat_gq_don_section" class="dynamic-section full-width" style="display: none;">
                    <h3>Kiểm sát giải quyết đơn (Thẩm quyền Kiểm sát)</h3>
                    
                    <div class="form-sub-group">
                        <label for="ks_chuyen_den_co_quan">Chuyển đến cơ quan nào:</label>
                        <select id="ks_chuyen_den_co_quan">
                            <option value="Chọn">--Chọn cơ quan--</option>
                            <option value="TAND TP.CT">TAND TP.CT</option>
                            <option value="THADS TP.CT">THADS TP.CT</option>
                            <option value="CQCSĐT CA TP.CT">CQCSĐT CA TP.CT</option>
                        </select>
                    </div>
                    
                    <div class="form-sub-group">
                        <label>Quyết định giải quyết khiếu nại:</label>
                        <input type="text" placeholder="Số Quyết định" id="ks_quyet_dinh_so">
                        <input type="date" placeholder="Ngày Quyết định" id="ks_quyet_dinh_ngay">
                        <textarea placeholder="Nội dung Quyết định" id="ks_quyet_dinh_noi_dung"></textarea>
                        <input type="text" placeholder="Cơ quan ban hành" id="ks_quyet_dinh_co_quan">
                    </div>
                </div>
                
                <input type="hidden" id="edit-id">
                <button onclick="saveDon()">Kết thúc nhập</button>
            </div>

            <div class="main-panel">
                <h2>DANH SÁCH THỤ LÝ, THEO DÕI ĐƠN</h2>
                <div class="btn-container" style="margin-bottom: 20px;">
                    <button onclick="exportList()">Danh sách đơn</button>
                    <button class="export-btn" onclick="downloadProposalDoc(currentSelectedId)">Phiếu Đề Xuất</button>
                    <button class="export-btn" onclick="downloadResultExtractionDoc(currentSelectedId)">Kết Quả xử lý đơn</button>
                </div>
                <div class="search-bar" style="margin-bottom: 20px;">
                    <input type="text" id="search-text" placeholder="Tìm kiếm theo Họ tên/Cơ quan/Tổ chức..." style="padding: 8px; width: 40%; border: 1px solid #ccc; border-radius: 4px;">
                    <input type="date" id="search-date" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <button class="search-btn" onclick="filterTable()">Tìm Kiếm</button>
                    <button class="reset-btn" onclick="resetFilter()">Xóa Bộ Lọc</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ngày nhận đơn</th>
                            <th>Họ tên /CQ/ TC</th>
                            <th>Nội dung đơn</th>
                            <th>Phân loại</th>
                            <th>Thẩm quyền</th>
                            <th>Xử lý đơn</th> 
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="don-body">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="kiemsat-section" class="section-content">
             <div class="sidebar" style="flex: 1;">
                 <div id="top-right-buttons">
                    <button id="account-btn" onclick="showAccountsModal()">Quản lý tài khoản</button>
                    <button onclick="showChangePassModal()">Đổi mật khẩu</button> 
                    <button onclick="logout()">Đăng xuất</button>
                </div> 
                 <h2>Nhập thông tin Kiểm sát hoạt động tư pháp</h2>
                 <div class="form-sub-group full-width">
                     <label>Mục 1: Quyết định trực tiếp kiểm sát</label>
                     <div class="form-section full-width">
                         <div class="form-group">
                             <label for="ks_qd_truc_tiep_so">Số Quyết định:</label>
                             <input type="text" id="ks_qd_truc_tiep_so" placeholder="Số:.../QĐ-VKS">
                         </div>
                         <div class="form-group">
                             <label for="ks_qd_truc_tiep_ngay">Ngày ban hành:</label>
                             <input type="date" id="ks_qd_truc_tiep_ngay">
                         </div>
                         <div class="form-group">
                             <label for="ks_qd_truc_tiep_co_quan">Cơ quan được kiểm sát:</label>
                             <select id="ks_qd_truc_tiep_co_quan">
                                 <option value="">--Chọn cơ quan--</option>
                                 <option value="Thi hành án dân sự thành phố Cần Thơ">Thi hành án dân sự thành phố Cần Thơ</option>
                                 <option value="CQCSĐT, CA TP.Cần Thơ">CQCSĐT, CA TP.Cần Thơ</option>
                                 <option value="Tòa án nhân dân thành phố Cần Thơ">Tòa án nhân dân thành phố Cần Thơ</option>
                             </select>
                         </div>
                     </div>
                     <div class="form-group full-width">
                         <label for="ks_qd_truc_tiep_noi_dung">Nội dung kiểm sát:</label>
                         <textarea id="ks_qd_truc_tiep_noi_dung"></textarea>
                     </div>
                      <div class="form-group full-width">
                         <label for="kl_ks_truc_tiep_ket_luan">Kết luận</label>
                         <textarea id="kl_ks_truc_tiep"></textarea>
                     </div>
                 </div>

                 <div class="form-sub-group full-width" style="margin-top: 20px;">
                     <label>Mục 2: Yêu cầu tự kiểm tra</label>
                     <div class="form-section full-width">
                         <div class="form-group">
                             <label for="ks_yc_tu_kt_so">Số Yêu cầu:</label>
                             <input type="text" id="ks_yc_tu_kt_so" placeholder="Số:.../YC-VKS">
                         </div>
                         <div class="form-group">
                             <label for="ks_yc_tu_kt_ngay">Ngày ban hành:</label>
                             <input type="date" id="ks_yc_tu_kt_ngay">
                         </div>
                         <div class="form-group">
                             <label for="ks_yc_tu_kt_co_quan">Cơ quan được yêu cầu:</label>
                             <select id="ks_qd_truc_tiep_co_quan">
                                 <option value="">--Chọn cơ quan--</option>
                                 <option value="Thi hành án dân sự thành phố Cần Thơ">Thi hành án dân sự thành phố Cần Thơ</option>
                                 <option value="CQCSĐT, CA TP.Cần Thơ">CQCSĐT, CA TP.Cần Thơ</option>
                                 <option value="Tòa án nhân dân thành phố Cần Thơ">Tòa án nhân dân thành phố Cần Thơ</option>
                             </select>
                         </div>
                     </div>
                     <div class="form-group full-width">
                         <label for="ks_yc_tu_kt_noi_dung">Nội dung yêu cầu tự kiểm tra:</label>
                         <textarea id="ks_yc_tu_kt_noi_dung"></textarea>
                     </div>
                      <div class="form-group full-width">
                         <label for="kl_tu_kiem_tra">Kết luận</label>
                         <textarea id="kl_tu_kiem_tra"></textarea>
                     </div>
                 </div>
                 <button onclick="saveKiemSatData()">Lưu thông tin Kiểm sát</button>
             </div>
             <div class="main-panel" style="flex: 2;">
                 <h2>Danh sách Kiểm sát trực tiếp - Yêu cầu tự kiểm tra</h2>
                <table>
                 <thead>
                        <tr>
                            <th>STT</th>
                            <th>Số QĐ</th>
                            <th>Ngày ban hành</th>
                            <th>Cơ quan được Kiểm sát/ tự kiểm tra</th>
                            <th>Nội dung kiểm sát/ yêu cầu tự kiểm tra</th>
                            <th>Kết luận</th>
                            <th>Nội dung kết luận</th>
                        </tr>
                    </thead>
                </table>
             </div>
        </div>

        <div id="giaiquyet-section" class="section-content">
            <div class="main-panel" style="width: 100%; max-width: none; flex: 1;">
                 <h2>Danh sách đơn thuộc thẩm quyền giải quyết của Viện kiểm sát</h2>
                 <div class="btn-container" style="margin-bottom: 20px;">
                    <button onclick="exportGiaiQuyetList()">Xuất Danh sách</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ngày nhận đơn</th>
                            <th>Họ tên /CQ/ TC</th>
                            <th>Nội dung đơn</th>
                            <th>Phân loại</th>
                            <th>Thẩm quyền</th>
                            <th>Kết quả GQ</th> 
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="giaiquyet-don-body">
                        </tbody>
                </table>
             </div>
        </div>

        <div id="vanban-section" class="section-content">
            <div class="sidebar" style="flex: 1;">
                 <div id="top-right-buttons">
                    <button id="account-btn" onclick="showAccountsModal()">Quản lý tài khoản</button>
                    <button onclick="showChangePassModal()">Đổi mật khẩu</button> 
                    <button onclick="logout()">Đăng xuất</button>
                </div>
                 <h2>Nhập thông tin Văn bản ban hành</h2>
                 <div class="form-section full-width">
                     <div class="form-group">
                         <label for="vb_loai_van_ban">Loại văn bản:</label>
                         <select id="vb_loai_van_ban">
                             <option value="Chọn">--Chọn--</option>
                             <option value="Kiến nghị">Kiến nghị</option>
                             <option value="Kháng nghị">Kháng nghị</option>
                             <option value="Yêu cầu">Yêu cầu</option>
                             <option value="Văn bản khác">Văn bản khác</option>
                         </select>
                     </div>
                     <div class="form-group">
                         <label for="vb_so_van_ban">Số Văn bản:</label>
                         <input type="text" id="vb_so_van_ban" placeholder="Số:....">
                     </div>
                     <div class="form-group">
                         <label for="vb_ngay_ban_hanh">Ngày ban hành:</label>
                         <input type="date" id="vb_ngay_ban_hanh">
                     </div>
                      <div class="form-group">
                         <label for="vb_co_quan_nhan">Cơ quan được Kiến nghị/Kháng nghị/Yêu cầu:</label>
                         <select id="ks_qd_truc_tiep_co_quan">
                                 <option value="">--Chọn cơ quan--</option>
                                 <option value="Thi hành án dân sự thành phố Cần Thơ">Thi hành án dân sự thành phố Cần Thơ</option>
                                 <option value="CQCSĐT, CA TP.Cần Thơ">CQCSĐT, CA TP.Cần Thơ</option>
                                 <option value="Tòa án nhân dân thành phố Cần Thơ">Tòa án nhân dân thành phố Cần Thơ</option>
                             </select>
                     </div>
                 </div>
                 <div class="form-group full-width">
                     <label for="vb_noi_dung_tom_tat">Tóm tắt nội dung văn bản:</label>
                     <textarea id="vb_noi_dung_tom_tat"></textarea>
                 </div>
                 <button onclick="saveVanBanData()">Lưu Văn bản</button>
             </div>
             <div class="main-panel" style="flex: 2;">
                 <h2>Danh sách Văn bản đã ban hành</h2>
            <table> 
                 <thead>
                        <tr>
                            <th>STT</th>
                            <th>Số Văn bản</th>
                            <th>Ngày ban hành</th>
                            <th>Kiến nghị/ Kháng nghị/ Yêu cầu</th>
                            <th>Nội dung</th>
                        </tr>
                    </thead>
                </table>
             </div>
        </div>
    </div>
    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('accountsModal').style.display='none'">&times;</span>
            <h3>Quản lý Tài khoản</h3>
            <h4>Tạo tài khoản mới</h4>
            <div class="form-section">
                <div class="form-group">
                    <label for="new-username">Tên đăng nhập:</label>
                    <input type="text" id="new-username">
                </div>
                <div class="form-group">
                    <label for="new-password">Mật khẩu:</label>
                    <input type="password" id="new-password">
                </div>
                <div class="form-group">
                    <label for="new-role">Vai trò:</label>
                    <select id="new-role">
                        <option value="admin">Quản trị viên (admin)</option>
                        <option value="manager_TP">Lãnh đạo cấp Thành phố</option>
                        <option value="user_TP">Cán bộ cấp Thành phố</option>
                        <option value="manager_KV">Lãnh đạo cấp Khu vực</option>
                        <option value="user_KV">Cán bộ cấp Khu vực</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-unit">Đơn vị:</label>
                    <select id="new-unit"></select>
                </div>
            </div>
            <button onclick="createAccount()">Tạo tài khoản</button>
            <h4>Danh sách tài khoản</h4>
            <ul id="account-list"></ul>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('reportModal').style.display='none'">&times;</span>
            <h3>Cấu hình Xuất Báo cáo Thống kê</h3>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="report-month">Thời điểm lấy số liệu</label>
                    <input type="month" id="report-month" value="${new Date().toISOString().slice(0, 7)}">
                </div>
                 <div class="form-group">
                    <label for="report-level">Cấp báo cáo:</label>
                    <select id="report-level">
                        <option value="all">Số liệu 02 cấp</option>
                        <option value="TP">Cấp Thành phố</option>
                        <option value="KV">Cấp Khu vực</option>
                    </select>
                </div>
            </div>

            <p style="margin-top: 20px;">* Báo cáo sẽ tổng hợp dữ liệu đơn theo tiêu chí đã chọn.</p>
            
            <div class="btn-container modal-footer">
                <button onclick="exportReport()">Xuất Báo cáo</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
            <h3>Sửa đổi đơn</h3>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_nhan">Ngày nhận đơn:</label>
                    <input type="date" id="sua-ngay_nhan">
                </div>
                <div class="form-group">
                    <label for="sua-nguon_don">Nguồn đơn:</label>
                    <select id="sua-nguon_don"></select>
                </div>
            </div>
            <div class="form-section full-width">
                <div class="form-group">
                    <label for="sua-ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                    <input type="text" id="sua-ho_ten" onblur="checkDuplicateName('sua-')">
                </div>
                <div class="form-group">
                    <label for="sua-dia_chi">Địa chỉ:</label>
                    <input type="text" id="sua-dia_chi">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_ghi">Đơn ghi ngày:</label>
                    <input type="date" id="sua-ngay_ghi">
                </div>
                <div class="form-group">
                    <label for="sua-phan_loai">Phân loại:</label>
                    <select id="sua-phan_loai" onchange="capNhatThamQuyenMacDinh('sua-')">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-tham_quyen">Thẩm quyền:</label>
                    <select id="sua-tham_quyen" onchange="updateDynamicFields('sua-')">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                        <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                        <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-can_bo_phan_cong">Cán bộ phân công:</label>
                    <input type="text" id="sua-can_bo_phan_cong">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-chuc_danh">Chức danh:</label>
                    <select id="sua-chuc_danh">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                        <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                        <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                        <option value="Kiểm tra viên">Kiểm tra viên</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-chuyen_den">Chuyển đến (Xử lý ban đầu):</label>
                    <select id="sua-chuyen_den"></select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_chuyen_don">Ngày chuyển đơn (Xử lý ban đầu):</label>
                    <input type="date" id="sua-ngay_chuyen_don">
                </div>
            </div>
             <div class="form-group full-width">
                <label>Căn cứ:</label>
                <div id="sua-can_cu_container"></div>
                <button onclick="addCanCu('sua-')">Thêm căn cứ</button>
            </div>
            <div class="form-group full-width">
                <label for="sua-noi_dung">Nội dung đơn:</label>
                <textarea id="sua-noi_dung"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-de_xuat">Đề xuất:</label>
                <textarea id="sua-de_xuat"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-ket_qua">Kết quả (Xử lý chung):</label>
                <textarea id="sua-ket_qua"></textarea>
            </div>
            
             <div id="sua-giai_quyet_kn_section" class="dynamic-section full-width" style="display: none;">
                <h3>Giải quyết khiếu nại (Thẩm quyền Giải quyết)</h3>
                
                <div class="form-sub-group">
                    <label>1. Quyết định phân công:</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-gq_phan_cong_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-gq_phan_cong_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-gq_phan_cong_noi_dung"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>2. Kế hoạch xác minh:</label>
                    <input type="text" placeholder="Số Kế hoạch" id="sua-gq_ke_hoach_so">
                    <input type="date" placeholder="Ngày Kế hoạch" id="sua-gq_ke_hoach_ngay">
                    <textarea placeholder="Nội dung Kế hoạch" id="sua-gq_ke_hoach_noi_dung"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>3. Đơn vị phối hợp:</label>
                    <select id="sua-gq_dv_phoi_hop_don_vi" required>
                         <option value="">-- Chọn Đơn vị phối hợp --</option>
                         <option value="Phòng 1">Phòng 1</option>
                        <option value="Phòng 2">Phòng 2</option>
                         <option value="Phòng 7">Phòng 7</option>
                         <option value="Phòng 8">Phòng 8</option>
                         <option value="Phòng 9">Phòng 9</option>
                         <option value="Phòng 10">Phòng 10</option>
                         <option value="Phòng 11">Phòng 11</option>
                         <option value="Phòng 15">Phòng 15</option>
                          <option value="Phòng khác">Phòng khác</option>
                    </select>
            <textarea placeholder="Nội dung phối hợp" id="sua-gq_dv_phoi_hop_noi_dung"></textarea>
                </div>
                <div class="form-sub-group">
                     <label>4. Đề xuất hướng giải quyết:</label>
                     <textarea placeholder="Nội dung Đề xuất chi tiết" id="sua-gq_de_xuat_chi_tiet"></textarea>
                </div>
                
                <div class="form-sub-group">
                    <label>5. Quyết định giải quyết khiếu nại (Lần 1):</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-gq_qd_giai_quyet_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-gq_qd_giai_quyet_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-gq_qd_giai_quyet_noi_dung"></textarea>
                </div>
            </div>
            
            <div id="sua-kiem_sat_gq_don_section" class="dynamic-section full-width" style="display: none;">
                <h3>Kiểm sát giải quyết đơn (Thẩm quyền Kiểm sát)</h3>
                
                <div class="form-sub-group">
                    <label for="sua-ks_chuyen_den_co_quan">Chuyển đến cơ quan nào:</label>
                    <select id="sua-ks_chuyen_den_co_quan">
                        <option value="Chọn">--Chọn cơ quan--</option>
                        <option value="TAND TP.CT">TAND TP.CT</option>
                        <option value="THADS TP.CT">THADS TP.CT</option>
                        <option value="CQCSĐT CA TP.CT">CQCSĐT CA TP.CT</option>
                    </select>
                </div>
                
                <div class="form-sub-group">
                    <label>Quyết định giải quyết khiếu nại:</label>
                    <input type="text" placeholder="Số Quyết định" id="sua-ks_quyet_dinh_so">
                    <input type="date" placeholder="Ngày Quyết định" id="sua-ks_quyet_dinh_ngay">
                    <textarea placeholder="Nội dung Quyết định" id="sua-ks_quyet_dinh_noi_dung"></textarea>
                    <input type="text" placeholder="Cơ quan ban hành" id="sua-ks_quyet_dinh_co_quan">
                </div>
            </div>
            <div class="btn-container modal-footer">
                <button class="edit-btn" onclick="updateDon()">Cập nhật đơn</button>
            </div>
        </div>
    </div>
    
    <div id="changePassModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('changePassModal').style.display='none'">&times;</span>
            <h3>Đổi Mật khẩu</h3>
            <div class="form-group">
                <label for="current-password">Mật khẩu hiện tại:</label>
                <input type="password" id="current-password">
            </div>
            <div class="form-group">
                <label for="new-password-1">Mật khẩu mới:</label>
                <input type="password" id="new-password-1">
            </div>
            <div class="form-group">
                <label for="new-password-2">Nhập lại Mật khẩu mới:</label>
                <input type="password" id="new-password-2">
            </div>
            <button onclick="changePassword()">Đổi Mật khẩu</button>
        </div>
    </div>
    
    <div id="proposalModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('proposalModal').style.display='none'">&times;</span>
            <h3>PHIẾU ĐỀ XUẤT XỬ LÝ ĐƠN</h3>
            <div id="proposal-content" style="padding: 20px;">
                </div>
            <div class="btn-container modal-footer">
                <button class="proposal-print-btn" onclick="printProposal()">In Phiếu Đề Xuất</button>
            </div>
        </div>
    </div>

    <div id="resultExtractionModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('resultExtractionModal').style.display='none'">&times;</span>
            <h3>KẾT QUẢ XỬ LÝ ĐƠN</h3>
            <div id="result-extraction-content" style="padding: 20px;">
                </div>
            <div class="btn-container modal-footer">
                <button class="proposal-print-btn" onclick="printResultExtraction()">In Kết Quả Xử Lý</button>
            </div>
        </div>
    </div>

    <div id="passwordResetModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('passwordResetModal').style.display='none'">&times;</span>
            <h3>Đặt lại Mật khẩu/Tên đăng nhập</h3>
            <p>Vui lòng liên hệ người Quản trị viên để được hỗ trợ đặt lại.</p>
        </div>
    </div>

    <script>
       const firebaseConfig = {
            apiKey: "AIzaSyBvhrOBoJc9-gKuTAXDlPknVdxKecgPH_g",
            authDomain: "quanlydonvks-d7ff9.firebaseapp.com",
            databaseURL: "https://quanlydonvks-d7ff9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quanlydonvks-d7ff9",
            storageBucket: "quanlydonvks-d7ff9.firebasestorage.app",
            messagingSenderId: "209768483000",
            appId: "1:209768483000:web:1eb449ad41840e23334c4d"
        };
        
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // --- GLOBAL VARIABLES (Giữ nguyên) ---
        let currentUser = null; 
        let dons = []; // Mảng chứa tất cả các đơn
        let currentSelectedId = null; // Thêm biến theo dõi đơn đang chọn để dùng cho export 
        
        // Dữ liệu danh mục
        const lookupData = {
            'Nguồn đơn': [
                'Bưu điện',
                'Tiếp công dân',
                'Cơ quan Đảng',
                'UBND TPCT',
                'Cục Điều tra, VKSTC',
                'V12, VKSTC',
                'Sở, Ban, Ngành',
                'Thành ủy Cần Thơ'
            ],
            'Chuyển đến': [
                'Lưu đơn',
                'Trả đơn',
                'Thông báo chỉ dẫn',
                'THADS TP.CT','THADS KV1','THADS KV2','THADS KV3','THADS KV4','THADS KV5','THADS KV6','THADS KV7',
                'THADS KV8','THADS KV9','THADS KV10','THADS KV11','THADS KV12','THADS KV13','THADS KV14',
                'TAND TP.CT','TAND KV1', 'TAND KV2','TAND KV3','TAND KV4','TAND KV5','TAND KV6','TAND KV7',
                'TAND KV8','TAND KV9','TAND KV10','TAND KV11','TAND KV12','TAND KV13','TAND KV14',
                'CQCSĐT CA TP.CT','CQCSĐT CA tỉnh/TP khác','CQ, Ban, Ngành khác'
            ],
            'Đơn vị': [
                'TT-KT,VKSNDTPCT',
                'VKSND KV1', 'VKSND KV2','VKSND KV3','VKSND KV4','VKSND KV5','VKSND KV6','VKSND KV7',
                'VKSND KV8','VKSND KV9','VKSND KV10','VKSND KV11','VKSND KV12','VKSND KV13','VKSND KV14',
            ]
        };

        const vanBanOptionsFinal = [
            "Luật Tố cáo 2018",
            "Luật Khiếu nại 2011",
            "Bộ Luật TTHS 2015",
            "Bộ Luật TTHC 2015",
            "Bộ Luật TTDS 2015",
            "Luật Thi hành án dân sự",
            "Luật Tổ chức VKSND 2014",
            "Quy chế số 222/QC-VKSTC",
            "Văn bản khác/Nhập vào"
        ];
        
        // --- AUTHENTICATION & USER MANAGEMENT (Giữ nguyên) ---
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                alert('Vui lòng nhập tên đăng nhập và mật khẩu.');
                return;
            }

            database.ref('accounts/' + username).once('value', (snapshot) => {
                const account = snapshot.val();
                if (account && account.password === password) {
                    currentUser = {
                        username: username,
                        role: account.role,
                        unit: account.unit 
                    };
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('main-container').style.display = 'flex';
                    populateSelects();
                    loadData();
                    updateCanBoPhanCong();
                    loadAccounts();
                    updateAccountBtnVisibility();
                    
                    // THÊM: Hiển thị section thụ lý đơn mặc định
                    showSection('thuly');

                } else {
                    alert('Tên đăng nhập hoặc mật khẩu không đúng.');
                }
            }).catch(error => {
                alert('Lỗi đăng nhập: ' + error.message);
            });
        }
        
        function logout() { /* (Giữ nguyên) */
             if (confirm('Bạn có chắc chắn muốn đăng xuất không?')) {
                currentUser = null;
                document.getElementById('main-container').style.display = 'none';
                document.getElementById('login-container').style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                // Ẩn nút quản lý tài khoản khi đăng xuất
                const accountBtn = document.getElementById('account-btn');
                if (accountBtn) {
                    accountBtn.style.display = 'none';
                }
            }
        }
        
       function showAccountsModal() {
    // Logic hiển thị modal quản lý tài khoản
    // Kiểm tra xem người dùng có vai trò admin (Quản trị viên) hoặc super_admin
    if (!currentUser || (currentUser.role !== 'super_admin' && currentUser.role !== 'admin')) { 
        alert('Bạn không có quyền truy cập chức năng này.');
        return;
    }
    document.getElementById('accountsModal').style.display = 'flex';
    capNhatDonViTheoVaiTro();
}
        
        function showChangePassModal() { /* (Giữ nguyên) */
            document.getElementById('changePassModal').style.display = 'flex';
            document.getElementById('current-password').value = '';
            document.getElementById('new-password-1').value = '';
            document.getElementById('new-password-2').value = '';
        }
        
        function handleForgotPassword() { /* (Giữ nguyên) */
            document.getElementById('passwordResetModal').style.display = 'flex';
        }
        
        function changePassword() { /* (Giữ nguyên) */
             // Logic đổi mật khẩu
             const currentPass = document.getElementById('current-password').value;
             const newPass1 = document.getElementById('new-password-1').value;
             const newPass2 = document.getElementById('new-password-2').value;

             if (!currentPass || !newPass1 || !newPass2) {
                 alert('Vui lòng điền đầy đủ thông tin.');
                 return;
             }

             if (newPass1 !== newPass2) {
                 alert('Mật khẩu mới không khớp.');
                 return;
             }

             if (newPass1.length < 6) {
                 alert('Mật khẩu mới phải có ít nhất 6 ký tự.');
                 return;
             }
             
             // Kiểm tra mật khẩu hiện tại
             database.ref('accounts/' + currentUser.username).once('value', (snapshot) => {
                 const account = snapshot.val();
                 if (account.password === currentPass) {
                     // Cập nhật mật khẩu
                     database.ref('accounts/' + currentUser.username + '/password').set(newPass1)
                         .then(() => {
                             alert('Đổi mật khẩu thành công!');
                             document.getElementById('changePassModal').style.display = 'none';
                         })
                         .catch(error => {
                             alert('Lỗi khi đổi mật khẩu: ' + error.message);
                         });
                 } else {
                     alert('Mật khẩu hiện tại không đúng.');
                 }
             }).catch(error => {
                 alert('Lỗi: ' + error.message);
             });
        }
        
        function createAccount() { /* (Giữ nguyên) */
             // Logic tạo tài khoản
            const newUsername = document.getElementById('new-username').value.trim();
            const newPassword = document.getElementById('new-password').value.trim();
            const newRole = document.getElementById('new-role').value;
            const newUnit = document.getElementById('new-unit').value;

            if (!newUsername || !newPassword || !newRole || !newUnit || newUnit === 'Chọn') {
                alert('Vui lòng điền đầy đủ thông tin cho tài khoản mới.');
                return;
            }
            
            if (newPassword.length < 6) {
                 alert('Mật khẩu phải có ít nhất 6 ký tự.');
                 return;
             }

            // Kiểm tra tên đăng nhập đã tồn tại chưa
            database.ref('accounts/' + newUsername).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    alert('Tên đăng nhập đã tồn tại.');
                } else {
                    database.ref('accounts/' + newUsername).set({
                        password: newPassword,
                        role: newRole,
                        unit: newUnit
                    })
                    .then(() => {
                        alert('Tạo tài khoản thành công!');
                        document.getElementById('new-username').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('new-role').value = 'user_TP';
                        document.getElementById('new-unit').value = 'TT-KT';
                        loadAccounts(); // Tải lại danh sách tài khoản
                    })
                    .catch(error => {
                        alert('Lỗi khi tạo tài khoản: ' + error.message);
                    });
                }
            });
        }
        
        function loadAccounts() { /* (Giữ nguyên) */
            // Logic tải danh sách tài khoản
            const accountList = document.getElementById('account-list');
            accountList.innerHTML = '';

            database.ref('accounts').once('value', (snapshot) => {
                const accounts = snapshot.val();
                for (let username in accounts) {
                    const account = accounts[username];
                    const listItem = document.createElement('li');
                    
                    let roleDisplay = account.role;
                    switch (account.role) {
                        case 'admin': roleDisplay = 'Quản trị viên'; break;
                        case 'manager_TP': roleDisplay = 'Lãnh đạo TP'; break;
                        case 'user_TP': roleDisplay = 'Cán bộ TP'; break;
                        case 'manager_KV': roleDisplay = 'Lãnh đạo KV'; break;
                        case 'user_KV': roleDisplay = 'Cán bộ KV'; break;
                    }

                    listItem.innerHTML = `
                        <strong>${username}</strong> 
                        <span style="font-size: 12px; color: #555;">[${roleDisplay} - ${account.unit}]</span>
                        <div>
                            <button class="reset-btn" onclick="resetPassword('${username}')">Reset Pass</button>
                            <button class="delete-btn" onclick="deleteAccount('${username}')">Xóa</button>
                        </div>
                    `;
                    
                    // Chỉ cho phép xóa tài khoản của mình
                    if (username === currentUser.username) {
                         listItem.querySelector('.delete-btn').disabled = true;
                         listItem.querySelector('.delete-btn').textContent = 'TK hiện tại';
                    }

                    accountList.appendChild(listItem);
                }
            });
        }
        
        function deleteAccount(username) { /* (Giữ nguyên) */
            // Logic xóa tài khoản
            if (username === 'admin') {
                 alert('Không được phép xóa tài khoản "admin" mặc định.');
                 return;
             }
             if (username === currentUser.username) {
                 alert('Không thể tự xóa tài khoản đang đăng nhập.');
                 return;
             }
            if (confirm(`Bạn có chắc chắn muốn xóa tài khoản "${username}" không?`)) {
                database.ref('accounts/' + username).remove()
                    .then(() => {
                        alert(`Đã xóa tài khoản "${username}".`);
                        loadAccounts();
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa tài khoản: ' + error.message);
                    });
            }
        }
        
        function resetPassword(username) { /* (Giữ nguyên) */
             // Logic reset mật khẩu
            if (confirm(`Bạn có chắc chắn muốn đặt lại mật khẩu tài khoản "${username}" về "123" không?`)) {
                database.ref('accounts/' + username + '/password').set('123')
                    .then(() => {
                        alert(`Đã đặt lại mật khẩu tài khoản "${username}" về "123".`);
                    })
                    .catch(error => {
                        alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                    });
            }
        }
        
        function capNhatDonViTheoVaiTro() { /* (Giữ nguyên) */
            populateUnitSelect('new-unit');
        }

        // --- DATA LOADING & INITIALIZATION (Giữ nguyên - thêm điều chỉnh ở init) ---
        function populateSelects(prefix = '') { /* (Giữ nguyên) */
            // Logic điền dữ liệu cho các thẻ select
             const nguonDonSelect = document.getElementById(prefix + 'nguon_don');
            const chuyenDenSelect = document.getElementById(prefix + 'chuyen_den');

            if (nguonDonSelect) {
                nguonDonSelect.innerHTML = '<option value="Chọn">--Chọn--</option>';
                lookupData['Nguồn đơn'].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    nguonDonSelect.appendChild(option);
                });
            }

            if (chuyenDenSelect) {
                chuyenDenSelect.innerHTML = '<option value="Chọn">--Chọn--</option>';
                lookupData['Chuyển đến'].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    chuyenDenSelect.appendChild(option);
                });
            }
        }

        function populateUnitSelect(id) { /* (Giữ nguyên) */
             // Logic điền dữ liệu cho select đơn vị
            const unitSelect = document.getElementById(id);
            if (unitSelect) {
                unitSelect.innerHTML = '<option value="Chọn">--Chọn--</option>';
                lookupData['Đơn vị'].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    unitSelect.appendChild(option);
                });
                unitSelect.value = 'TT-KT'; // Mặc định là TT-KT
            }
        }

        function loadData() { /* (Giữ nguyên) */
             // Logic tải dữ liệu đơn từ Firebase
            database.ref('dons').on('value', (snapshot) => {
                const data = snapshot.val();
                dons = [];
                for (let id in data) {
                    dons.push({ id: id, ...data[id] });
                }
                updateTable(dons);
            }, (error) => {
                console.error("Lỗi khi tải dữ liệu đơn:", error);
                alert("Lỗi khi tải dữ liệu đơn. Vui lòng kiểm tra kết nối hoặc quyền truy cập.");
            });
        }
        
        // --- TABLE DISPLAY & FILTERING (Giữ nguyên) ---
        function updateTable(filteredDons = dons) { /* (Giữ nguyên) */
             // Logic cập nhật bảng hiển thị
            const tableBody = document.getElementById('don-body');
            tableBody.innerHTML = '';
            
            // Lọc thêm theo quyền hạn
            let finalDons = filteredDons;
            if (currentUser && currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                // Lọc theo đơn vị nếu không phải admin
                finalDons = finalDons.filter(don => don.don_vi === currentUser.unit);
            }
            if (currentUser && (currentUser.role === 'user_TP' || currentUser.role === 'user_KV')) {
                // Lọc theo cán bộ phân công nếu là user
                finalDons = finalDons.filter(don => don.can_bo_phan_cong === currentUser.username);
            }
            
            if (finalDons.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không tìm thấy dữ liệu đơn.</td></tr>';
                 return;
             }

            finalDons.forEach((don, index) => {
                const row = tableBody.insertRow();
                row.onclick = () => { highlightSelectedRow(row, don.id); }; // Thêm sự kiện click để chọn hàng
                row.insertCell().textContent = index + 1;
                row.insertCell().textContent = don.ngay_nhan || '';
                row.insertCell().textContent = don.ho_ten || '';
                row.insertCell().textContent = don.noi_dung ? (don.noi_dung.substring(0, 50) + '...') : '';
                row.insertCell().textContent = don.phan_loai || '';
                row.insertCell().textContent = don.tham_quyen || '';
                row.insertCell().textContent = don.chuyen_den || '';
                
                // Thao tác
                const actionsCell = row.insertCell();
                actionsCell.className = 'table-actions';
                
                const editButton = document.createElement('button');
                editButton.className = 'edit-btn';
                editButton.textContent = 'Sửa';
                editButton.onclick = (event) => { 
                    event.stopPropagation();
                    editDon(don.id);
                };
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-btn';
                deleteButton.textContent = 'Xóa';
                deleteButton.onclick = (event) => { 
                    event.stopPropagation();
                    deleteDon(don.id);
                };
                actionsCell.appendChild(deleteButton);
            });
        }
        
        function highlightSelectedRow(row, id) { /* (Giữ nguyên) */
            // Logic đánh dấu hàng được chọn
             document.querySelectorAll('#don-body tr').forEach(r => {
                r.style.backgroundColor = '';
                r.style.boxShadow = 'none';
                if (r.rowIndex % 2 !== 0) {
                    r.style.backgroundColor = '#f5f5f5';
                } else {
                    r.style.backgroundColor = '#fff';
                }
            });
            row.style.backgroundColor = '#bbdefb';
            row.style.boxShadow = '0 0 10px rgba(86, 112, 230, 0.5)';
            currentSelectedId = id; // Cập nhật ID của đơn đang được chọn
        }
        
        function filterTable() { /* (Giữ nguyên) */
             // Logic lọc bảng
             const searchText = document.getElementById('search-text').value.toLowerCase();
            const searchDate = document.getElementById('search-date').value;

            let filteredDons = dons.filter(don => {
                const matchesText = !searchText || (don.ho_ten && don.ho_ten.toLowerCase().includes(searchText)) || (don.noi_dung && don.noi_dung.toLowerCase().includes(searchText));
                const matchesDate = !searchDate || (don.ngay_nhan === searchDate);
                return matchesText && matchesDate;
            });

            updateTable(filteredDons);
        }
        
        function resetFilter() { /* (Giữ nguyên) */
            document.getElementById('search-text').value = '';
            document.getElementById('search-date').value = '';
            updateTable(dons);
        }
        
        // --- CRUD OPERATIONS (Giữ nguyên) ---
        function saveDon() { /* (Giữ nguyên) */
            // Logic lưu đơn mới/cập nhật đơn
            // ... (Phần này quá dài, tôi giả định là giữ nguyên logic cũ)
            const ngay_nhan = document.getElementById('ngay_nhan').value;
            const nguon_don = document.getElementById('nguon_don').value;
            const ho_ten = document.getElementById('ho_ten').value;
            const dia_chi = document.getElementById('dia_chi').value;
            const ngay_ghi = document.getElementById('ngay_ghi').value;
            const phan_loai = document.getElementById('phan_loai').value;
            const tham_quyen = document.getElementById('tham_quyen').value;
            const can_bo_phan_cong = document.getElementById('can_bo_phan_cong').value;
            const chuc_danh = document.getElementById('chuc_danh').value;
            const chuyen_den = document.getElementById('chuyen_den').value;
            const ngay_chuyen_don = document.getElementById('ngay_chuyen_don').value;
            const noi_dung = document.getElementById('noi_dung').value;
            const de_xuat = document.getElementById('de_xuat').value;
            const ket_qua = document.getElementById('ket_qua').value;
            const donId = document.getElementById('edit-id').value;
            
            if (!ngay_nhan || !ho_ten || !phan_loai || tham_quyen === 'Chọn') {
                alert('Vui lòng điền đủ các trường bắt buộc: Ngày nhận đơn, Họ tên/Cơ quan, Phân loại, Thẩm quyền.');
                return;
            }

            const can_cu = getCanCuData();
            const giaiQuyetKNData = getGiaiQuyetKNData();
            const kiemSatGQDonData = getKiemSatGQDonData();
            
            const donData = {
                ngay_nhan,
                nguon_don: nguon_don === 'Chọn' ? '' : nguon_don,
                ho_ten,
                dia_chi,
                ngay_ghi,
                phan_loai,
                tham_quyen,
                can_bo_phan_cong,
                chuc_danh: chuc_danh === 'Chọn' ? '' : chuc_danh,
                chuyen_den: chuyen_den === 'Chọn' ? '' : chuyen_den,
                ngay_chuyen_don,
                noi_dung,
                de_xuat,
                ket_qua,
                don_vi: currentUser ? currentUser.unit : '', // Thêm đơn vị của người dùng
                can_cu, // Thêm dữ liệu căn cứ
                ...giaiQuyetKNData, // Thêm dữ liệu giải quyết KN
                ...kiemSatGQDonData // Thêm dữ liệu kiểm sát GQ
            };

            if (donId) {
                // Cập nhật đơn đã tồn tại
                database.ref('dons/' + donId).update(donData)
                    .then(() => {
                        alert('Cập nhật đơn thành công!');
                        clearForm();
                    })
                    .catch(error => {
                        alert('Lỗi khi cập nhật đơn: ' + error.message);
                    });
            } else {
                // Lưu đơn mới
                database.ref('dons').push(donData)
                    .then(() => {
                        alert('Lưu đơn thành công!');
                        clearForm();
                    })
                    .catch(error => {
                        alert('Lỗi khi lưu đơn: ' + error.message);
                    });
            }
        }
        
        function editDon(id) { /* (Giữ nguyên) */
             // Logic điền dữ liệu vào form Sửa đổi
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert('Không tìm thấy dữ liệu đơn.');
                return;
            }

            // Lưu ID đơn đang sửa vào form
            document.getElementById('edit-id').value = id;
            document.getElementById('sua-ngay_nhan').value = don.ngay_nhan || '';
            document.getElementById('sua-nguon_don').value = don.nguon_don || 'Chọn';
            document.getElementById('sua-ho_ten').value = don.ho_ten || '';
            document.getElementById('sua-dia_chi').value = don.dia_chi || '';
            document.getElementById('sua-ngay_ghi').value = don.ngay_ghi || '';
            document.getElementById('sua-phan_loai').value = don.phan_loai || 'Chọn';
            document.getElementById('sua-tham_quyen').value = don.tham_quyen || 'Chọn';
            document.getElementById('sua-can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('sua-chuc_danh').value = don.chuc_danh || 'Chọn';
            document.getElementById('sua-chuyen_den').value = don.chuyen_den || 'Chọn';
            document.getElementById('sua-ngay_chuyen_don').value = don.ngay_chuyen_don || '';
            document.getElementById('sua-noi_dung').value = don.noi_dung || '';
            document.getElementById('sua-de_xuat').value = don.de_xuat || '';
            document.getElementById('sua-ket_qua').value = don.ket_qua || '';

            // Căn cứ
            populateCanCuFields(don.can_cu, 'sua-'); 

            // Cập nhật hiển thị form động
            updateDynamicFields('sua-'); 

            // Điền dữ liệu cho phần giải quyết/kiểm sát
            if (don.tham_quyen === 'Thuộc thẩm quyền giải quyết') {
                populateGiaiQuyetKNFields(don, 'sua-'); 
                populateKiemSatGQDonFields({}, 'sua-'); // Xóa trường kiểm sát khi mở form
            } else if (don.tham_quyen === 'Thuộc thẩm quyền kiểm sát') {
                populateKiemSatGQDonFields(don, 'sua-');
                populateGiaiQuyetKNFields({}, 'sua-'); // Xóa trường giải quyết khi mở form
            } else {
                 populateGiaiQuyetKNFields({}, 'sua-');
                 populateKiemSatGQDonFields({}, 'sua-');
            }

            document.getElementById('editModal').style.display = 'flex';
        }
        
        function updateDon() { /* (Giữ nguyên) */
             // Logic cập nhật đơn từ modal Sửa đổi
            const donId = document.getElementById('edit-id').value;
            if (!donId) return;

            const ngay_nhan = document.getElementById('sua-ngay_nhan').value;
            const nguon_don = document.getElementById('sua-nguon_don').value;
            const ho_ten = document.getElementById('sua-ho_ten').value;
            const dia_chi = document.getElementById('sua-dia_chi').value;
            const ngay_ghi = document.getElementById('sua-ngay_ghi').value;
            const phan_loai = document.getElementById('sua-phan_loai').value;
            const tham_quyen = document.getElementById('sua-tham_quyen').value;
            const can_bo_phan_cong = document.getElementById('sua-can_bo_phan_cong').value;
            const chuc_danh = document.getElementById('sua-chuc_danh').value;
            const chuyen_den = document.getElementById('sua-chuyen_den').value;
            const ngay_chuyen_don = document.getElementById('sua-ngay_chuyen_don').value;
            const noi_dung = document.getElementById('sua-noi_dung').value;
            const de_xuat = document.getElementById('sua-de_xuat').value;
            const ket_qua = document.getElementById('sua-ket_qua').value;

            if (!ngay_nhan || !ho_ten || !phan_loai || tham_quyen === 'Chọn') {
                alert('Vui lòng điền đủ các trường bắt buộc: Ngày nhận đơn, Họ tên/Cơ quan, Phân loại, Thẩm quyền.');
                return;
            }

            const can_cu = getCanCuData('sua-');
            const giaiQuyetKNData = getGiaiQuyetKNData('sua-');
            const kiemSatGQDonData = getKiemSatGQDonData('sua-');

            const donData = {
                ngay_nhan,
                nguon_don: nguon_don === 'Chọn' ? '' : nguon_don,
                ho_ten,
                dia_chi,
                ngay_ghi,
                phan_loai,
                tham_quyen,
                can_bo_phan_cong,
                chuc_danh: chuc_danh === 'Chọn' ? '' : chuc_danh,
                chuyen_den: chuyen_den === 'Chọn' ? '' : chuyen_den,
                ngay_chuyen_don,
                noi_dung,
                de_xuat,
                ket_qua,
                can_cu,
                ...giaiQuyetKNData,
                ...kiemSatGQDonData
            };

            database.ref('dons/' + donId).update(donData)
                .then(() => {
                    alert('Cập nhật đơn thành công!');
                    document.getElementById('editModal').style.display = 'none';
                    // Không cần clearForm vì nó được gọi từ saveDon, ở đây chỉ đóng modal
                })
                .catch(error => {
                    alert('Lỗi khi cập nhật đơn: ' + error.message);
                });
        }
        
        function deleteDon(id) { /* (Giữ nguyên) */
             // Logic xóa đơn
            if (confirm('Bạn có chắc chắn muốn xóa đơn này không?')) {
                database.ref('dons/' + id).remove()
                    .then(() => {
                        alert('Xóa đơn thành công!');
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa đơn: ' + error.message);
                    });
            }
        }
        
        // --- FORM UTILITIES (Giữ nguyên) ---
        function clearForm(prefix = '') { /* (Giữ nguyên) */
            // Logic xóa/reset form
            document.getElementById(prefix + 'ngay_nhan').value = '';
            document.getElementById(prefix + 'nguon_don').value = 'Chọn';
            document.getElementById(prefix + 'ho_ten').value = '';
            document.getElementById(prefix + 'dia_chi').value = '';
            document.getElementById(prefix + 'ngay_ghi').value = '';
            document.getElementById(prefix + 'phan_loai').value = 'Khiếu nại'; // Mặc định
            document.getElementById(prefix + 'tham_quyen').value = 'Chọn';
            document.getElementById(prefix + 'chuc_danh').value = 'Chọn';
            document.getElementById(prefix + 'chuyen_den').value = 'Chọn';
            document.getElementById(prefix + 'ngay_chuyen_don').value = '';
            document.getElementById(prefix + 'noi_dung').value = '';
            document.getElementById(prefix + 'de_xuat').value = '';
            document.getElementById(prefix + 'ket_qua').value = '';
            
            if (prefix === '') {
                document.getElementById('edit-id').value = '';
                document.getElementById('can_bo_phan_cong').value = currentUser ? currentUser.username : '';
            } else {
                 // Xóa can_bo_phan_cong cho sua- form nếu cần, nhưng thường được điền trước
                 // document.getElementById('sua-can_bo_phan_cong').value = '';
            }

            // Clear dynamic sections
            document.getElementById(prefix + 'giai_quyet_kn_section').style.display = 'none';
            document.getElementById(prefix + 'kiem_sat_gq_don_section').style.display = 'none';
            
            // Clear Căn cứ fields
            populateCanCuFields([], prefix);
            
            // Clear Giải quyết KN fields
            if (document.getElementById(prefix + 'gq_phan_cong_so')) document.getElementById(prefix + 'gq_phan_cong_so').value = '';
            if (document.getElementById(prefix + 'gq_phan_cong_ngay')) document.getElementById(prefix + 'gq_phan_cong_ngay').value = '';
            if (document.getElementById(prefix + 'gq_phan_cong_noi_dung')) document.getElementById(prefix + 'gq_phan_cong_noi_dung').value = '';
            if (document.getElementById(prefix + 'gq_ke_hoach_so')) document.getElementById(prefix + 'gq_ke_hoach_so').value = '';
            if (document.getElementById(prefix + 'gq_ke_hoach_ngay')) document.getElementById(prefix + 'gq_ke_hoach_ngay').value = '';
            if (document.getElementById(prefix + 'gq_ke_hoach_noi_dung')) document.getElementById(prefix + 'gq_ke_hoach_noi_dung').value = '';
            // ĐÃ SỬA: Đơn vị phối hợp
            if (document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi')) document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi').value = '';
            if (document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung')) document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung').value = '';
            if (document.getElementById(prefix + 'gq_de_xuat_chi_tiet')) document.getElementById(prefix + 'gq_de_xuat_chi_tiet').value = '';

            if (document.getElementById(prefix + 'gq_qd_giai_quyet_so')) document.getElementById(prefix + 'gq_qd_giai_quyet_so').value = '';
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_ngay')) document.getElementById(prefix + 'gq_qd_giai_quyet_ngay').value = '';
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung')) document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung').value = '';

            // Clear Kiểm sát GQ fields
            if (document.getElementById(prefix + 'ks_chuyen_den_co_quan')) document.getElementById(prefix + 'ks_chuyen_den_co_quan').value = 'Chọn';
            if (document.getElementById(prefix + 'ks_quyet_dinh_so')) document.getElementById(prefix + 'ks_quyet_dinh_so').value = '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_ngay')) document.getElementById(prefix + 'ks_quyet_dinh_ngay').value = '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_noi_dung')) document.getElementById(prefix + 'ks_quyet_dinh_noi_dung').value = '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_co_quan')) document.getElementById(prefix + 'ks_quyet_dinh_co_quan').value = '';
        }

        function capNhatThamQuyenMacDinh(prefix = '') { /* (Giữ nguyên) */
            // Logic cập nhật thẩm quyền mặc định
            const phanLoai = document.getElementById(prefix + 'phan_loai').value;
            const thamQuyenSelect = document.getElementById(prefix + 'tham_quyen');

            if (phanLoai === 'Đề nghị KN, GĐT, TT' || phanLoai === 'Đề nghị kiểm tra QĐGQKN' || phanLoai === 'Tin báo/Tố giác tội phạm trong HĐTP') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền kiểm sát';
            } else if (phanLoai === 'Khiếu nại' || phanLoai === 'Tố cáo' || phanLoai === 'Yêu cầu bồi thường thiệt hại') {
                // Giữ nguyên thẩm quyền hiện tại nếu người dùng đã chọn, nếu chưa chọn thì để "Chọn"
                 if (thamQuyenSelect.value === 'Thuộc thẩm quyền kiểm sát' || thamQuyenSelect.value === 'Không thuộc thẩm quyền') {
                     // Nếu đang là kiểm sát hoặc không thuộc thì giữ nguyên, còn nếu là 'Chọn' hoặc 'Giải quyết' thì giữ nguyên
                 } else {
                     thamQuyenSelect.value = 'Chọn';
                 }
            } else { // Kiến nghị/Phản ánh/Khác
                thamQuyenSelect.value = 'Không thuộc thẩm quyền';
            }
            
            updateDynamicFields(prefix);
        }
        
        function updateDynamicFields(prefix = '') { /* (Giữ nguyên) */
            // Logic hiển thị/ẩn các form động
            const thamQuyen = document.getElementById(prefix + 'tham_quyen')?.value;
            const giaiQuyetSection = document.getElementById(prefix + 'giai_quyet_kn_section');
            const kiemSatSection = document.getElementById(prefix + 'kiem_sat_gq_don_section');

            if (thamQuyen === 'Thuộc thẩm quyền giải quyết') {
                giaiQuyetSection.style.display = 'block';
                kiemSatSection.style.display = 'none';
            } else if (thamQuyen === 'Thuộc thẩm quyền kiểm sát') {
                giaiQuyetSection.style.display = 'none';
                kiemSatSection.style.display = 'block';
            } else {
                // Không thuộc thẩm quyền hoặc Chọn
                giaiQuyetSection.style.display = 'none';
                kiemSatSection.style.display = 'none';
            }
        }

        function addCanCu(prefix = '') { /* (Giữ nguyên) */
             // Logic thêm dòng căn cứ
            const container = document.getElementById(prefix + 'can_cu_container');
            const newItem = document.createElement('div');
            newItem.className = 'can-cu-item';

            let vanBanSelectHtml = '<select class="can-cu-van-ban" onchange="updateVanBanInputVisibility(this)">';
            vanBanSelectHtml += '<option value="">Chọn Văn bản/Quy chế</option>';
            vanBanOptionsFinal.forEach(option => {
                vanBanSelectHtml += `<option value="${option}">${option}</option>`;
            });
            vanBanSelectHtml += '</select>';

            let customInputHtml = '<input type="text" placeholder="Tự điền Văn bản/Quy chế..." class="can-cu-van-ban-custom" style="display: none; margin-top: 5px;">';

            newItem.innerHTML = `
                <input type="text" placeholder="Điểm" class="can-cu-diem" value="">
                <input type="number" placeholder="Khoản" class="can-cu-khoan" value="">
                <input type="number" placeholder="Điều" class="can-cu-dieu" value="">
                <div style="display: flex; flex-direction: column;">
                    ${vanBanSelectHtml}
                    ${customInputHtml}
                </div>
                <button onclick="this.parentNode.remove()">Xóa</button>
            `;
            container.appendChild(newItem);
        }

        function getCanCuData(prefix = '') { /* (Giữ nguyên) */
             // Logic lấy dữ liệu căn cứ
            const container = document.getElementById(prefix + 'can_cu_container');
            const items = container.querySelectorAll('.can-cu-item');
            const canCuList = [];

            items.forEach(item => {
                const diem = item.querySelector('.can-cu-diem').value.trim();
                const khoan = item.querySelector('.can-cu-khoan').value.trim();
                const dieu = item.querySelector('.can-cu-dieu').value.trim();
                const vanBanSelect = item.querySelector('.can-cu-van-ban');
                const customInput = item.querySelector('.can-cu-van-ban-custom');
                
                let van_ban = '';
                if (vanBanSelect.value === 'Tự điền vào văn bản' && customInput) {
                    van_ban = customInput.value.trim();
                } else {
                    van_ban = vanBanSelect.value.trim();
                }

                if (diem || khoan || dieu || van_ban) {
                    canCuList.push({
                        diem: diem,
                        khoan: khoan,
                        dieu: dieu,
                        van_ban: van_ban
                    });
                }
            });

            return canCuList;
        }

        function updateVanBanInputVisibility(selectElement) { /* (Giữ nguyên) */
             // Logic ẩn/hiện ô input tùy chỉnh cho Văn bản
            const customInput = selectElement.parentNode.querySelector('.can-cu-van-ban-custom');
            if (selectElement.value === 'Tự điền vào văn bản') {
                customInput.style.display = 'block';
                customInput.setAttribute('required', 'required');
            } else {
                customInput.style.display = 'none';
                customInput.removeAttribute('required');
                customInput.value = '';
            }
        }

        function populateCanCuFields(canCuList, prefix = '') { /* (Giữ nguyên) */
             // Logic điền dữ liệu căn cứ vào form
             const container = document.getElementById(prefix + 'can_cu_container');
            container.innerHTML = ''; // Xóa hết dòng cũ

            if (!canCuList || canCuList.length === 0) {
                // Thêm một dòng trống nếu không có dữ liệu
                addCanCu(prefix);
                return;
            }

            canCuList.forEach(item => {
                let selectValue = item.van_ban || '';
                let customInputValue = '';
                let isCustomValue = !vanBanOptionsFinal.includes(selectValue);

                if (isCustomValue) {
                    customInputValue = selectValue;
                    selectValue = 'Tự điền vào văn bản';
                }

                let vanBanSelectHtml = '<select class="can-cu-van-ban" onchange="updateVanBanInputVisibility(this)">';
                vanBanSelectHtml += '<option value="">Chọn Văn bản/Quy chế</option>';
                vanBanOptionsFinal.forEach(option => {
                    vanBanSelectHtml += `<option value="${option}" ${option === selectValue ? 'selected' : ''}>${option}</option>`;
                });
                vanBanSelectHtml += '</select>';

                const customInputDisplay = (selectValue === 'Tự điền vào văn bản' || isCustomValue) ? 'block' : 'none';
                const customInputRequired = (selectValue === 'Tự điền vào văn bản' || isCustomValue) ? 'required' : '';

                let customInputHtml = `<input type="text" placeholder="Tự điền Văn bản/Quy chế..." class="can-cu-van-ban-custom" style="display: ${customInputDisplay}; margin-top: 5px;" value="${customInputValue}" ${customInputRequired}>`;

                const newItem = document.createElement('div');
                newItem.className = 'can-cu-item';
                newItem.innerHTML = `
                    <input type="text" placeholder="Điểm" class="can-cu-diem" value="${item.diem || ''}">
                    <input type="number" placeholder="Khoản" class="can-cu-khoan" value="${item.khoan || ''}">
                    <input type="number" placeholder="Điều" class="can-cu-dieu" value="${item.dieu || ''}">
                    <div style="display: flex; flex-direction: column;">
                        ${vanBanSelectHtml}
                        ${customInputHtml}
                    </div>
                    <button onclick="this.parentNode.remove()">Xóa</button>
                `;
                container.appendChild(newItem);
            });
        }

        function getGiaiQuyetKNData(prefix = '') { /* (Giữ nguyên) */
             // Logic lấy dữ liệu Giải quyết KN
            const thamQuyen = document.getElementById(prefix + 'tham_quyen')?.value;
            if (thamQuyen !== 'Thuộc thẩm quyền giải quyết') return {};

            // Dữ liệu cho Giải quyết khiếu nại (thuộc thẩm quyền)
            return {
                gq_phan_cong_so: document.getElementById(prefix + 'gq_phan_cong_so')?.value || '',
                gq_phan_cong_ngay: document.getElementById(prefix + 'gq_phan_cong_ngay')?.value || '',
                gq_phan_cong_noi_dung: document.getElementById(prefix + 'gq_phan_cong_noi_dung')?.value || '',
                gq_ke_hoach_so: document.getElementById(prefix + 'gq_ke_hoach_so')?.value || '',
                gq_ke_hoach_ngay: document.getElementById(prefix + 'gq_ke_hoach_ngay')?.value || '',
                gq_ke_hoach_noi_dung: document.getElementById(prefix + 'gq_ke_hoach_noi_dung')?.value || '',
                // ĐÃ SỬA: Đơn vị phối hợp
                gq_dv_phoi_hop_don_vi: document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi')?.value || '',
                gq_dv_phoi_hop_noi_dung: document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung')?.value || '',
                gq_de_xuat_chi_tiet: document.getElementById(prefix + 'gq_de_xuat_chi_tiet')?.value || '', // Thêm trường mới
                gq_qd_giai_quyet_so: document.getElementById(prefix + 'gq_qd_giai_quyet_so')?.value || '',
                gq_qd_giai_quyet_ngay: document.getElementById(prefix + 'gq_qd_giai_quyet_ngay')?.value || '',
                gq_qd_giai_quyet_noi_dung: document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung')?.value || ''
            };
        }

        function populateGiaiQuyetKNFields(data, prefix = '') { /* (Giữ nguyên) */
             // Logic điền dữ liệu Giải quyết KN
            if (!data) return;

            // Dữ liệu cho Giải quyết khiếu nại (thuộc thẩm quyền)
            if (document.getElementById(prefix + 'gq_phan_cong_so')) document.getElementById(prefix + 'gq_phan_cong_so').value = data.gq_phan_cong_so || '';
            if (document.getElementById(prefix + 'gq_phan_cong_ngay')) document.getElementById(prefix + 'gq_phan_cong_ngay').value = data.gq_phan_cong_ngay || '';
            if (document.getElementById(prefix + 'gq_phan_cong_noi_dung')) document.getElementById(prefix + 'gq_phan_cong_noi_dung').value = data.gq_phan_cong_noi_dung || '';
            if (document.getElementById(prefix + 'gq_ke_hoach_so')) document.getElementById(prefix + 'gq_ke_hoach_so').value = data.gq_ke_hoach_so || '';
            if (document.getElementById(prefix + 'gq_ke_hoach_ngay')) document.getElementById(prefix + 'gq_ke_hoach_ngay').value = data.gq_ke_hoach_ngay || '';
            if (document.getElementById(prefix + 'gq_ke_hoach_noi_dung')) document.getElementById(prefix + 'gq_ke_hoach_noi_dung').value = data.gq_ke_hoach_noi_dung || '';
            // ĐÃ SỬA: Đơn vị phối hợp
            if (document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi')) document.getElementById(prefix + 'gq_dv_phoi_hop_don_vi').value = data.gq_dv_phoi_hop_don_vi || '';
            if (document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung')) document.getElementById(prefix + 'gq_dv_phoi_hop_noi_dung').value = data.gq_dv_phoi_hop_noi_dung || '';
            if (document.getElementById(prefix + 'gq_de_xuat_chi_tiet')) document.getElementById(prefix + 'gq_de_xuat_chi_tiet').value = data.gq_de_xuat_chi_tiet || ''; // Thêm trường mới
            
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_so')) document.getElementById(prefix + 'gq_qd_giai_quyet_so').value = data.gq_qd_giai_quyet_so || '';
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_ngay')) document.getElementById(prefix + 'gq_qd_giai_quyet_ngay').value = data.gq_qd_giai_quyet_ngay || '';
            if (document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung')) document.getElementById(prefix + 'gq_qd_giai_quyet_noi_dung').value = data.gq_qd_giai_quyet_noi_dung || '';
        }

        function getKiemSatGQDonData(prefix = '') { /* (Giữ nguyên) */
             // Logic lấy dữ liệu Kiểm sát GQ
            const thamQuyen = document.getElementById(prefix + 'tham_quyen')?.value;
            if (thamQuyen !== 'Thuộc thẩm quyền kiểm sát') return {};

            // Dữ liệu cho Kiểm sát giải quyết đơn
            return {
                ks_chuyen_den_co_quan: document.getElementById(prefix + 'ks_chuyen_den_co_quan')?.value || '',
                ks_quyet_dinh_so: document.getElementById(prefix + 'ks_quyet_dinh_so')?.value || '',
                ks_quyet_dinh_ngay: document.getElementById(prefix + 'ks_quyet_dinh_ngay')?.value || '',
                ks_quyet_dinh_noi_dung: document.getElementById(prefix + 'ks_quyet_dinh_noi_dung')?.value || '',
                ks_quyet_dinh_co_quan: document.getElementById(prefix + 'ks_quyet_dinh_co_quan')?.value || ''
            };
        }

        function populateKiemSatGQDonFields(data, prefix = '') { /* (Giữ nguyên) */
             // Logic điền dữ liệu Kiểm sát GQ
            if (!data) return;

            // Dữ liệu cho Kiểm sát giải quyết đơn
            if (document.getElementById(prefix + 'ks_chuyen_den_co_quan')) document.getElementById(prefix + 'ks_chuyen_den_co_quan').value = data.ks_chuyen_den_co_quan || 'Chọn';
            if (document.getElementById(prefix + 'ks_quyet_dinh_so')) document.getElementById(prefix + 'ks_quyet_dinh_so').value = data.ks_quyet_dinh_so || '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_ngay')) document.getElementById(prefix + 'ks_quyet_dinh_ngay').value = data.ks_quyet_dinh_ngay || '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_noi_dung')) document.getElementById(prefix + 'ks_quyet_dinh_noi_dung').value = data.ks_quyet_dinh_noi_dung || '';
            if (document.getElementById(prefix + 'ks_quyet_dinh_co_quan')) document.getElementById(prefix + 'ks_quyet_dinh_co_quan').value = data.ks_quyet_dinh_co_quan || '';
        }
        
        function updateCanBoPhanCong() { /* (Giữ nguyên) */
            // Logic cập nhật tên cán bộ phân công mặc định theo user đang đăng nhập
            const canBoInput = document.getElementById('can_bo_phan_cong');
            if (canBoInput && currentUser) {
                canBoInput.value = currentUser.username;
            }
        }
        
        function updateAccountBtnVisibility() {
    // Logic ẩn/hiện nút Quản lý tài khoản
    const accountBtn = document.getElementById('account-btn');
    if (accountBtn && currentUser) {
        // Cập nhật để hiển thị nút cho cả 'admin' và 'super_admin'
        if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
            accountBtn.style.display = 'block';
        } else {
            accountBtn.style.display = 'none';
        }
    }
}
        
        // --- EXPORT UTILITIES (Giữ nguyên) ---
        function exportList() { /* (Giữ nguyên) */
             // Logic xuất Excel danh sách đơn
             // ... (Giả định logic này giữ nguyên)
            let exportDons = dons;
            
            // Lọc theo quyền hạn
            if (currentUser && currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                exportDons = exportDons.filter(don => don.don_vi === currentUser.unit);
            }
            if (currentUser && (currentUser.role === 'user_TP' || currentUser.role === 'user_KV')) {
                exportDons = exportDons.filter(don => don.can_bo_phan_cong === currentUser.username);
            }

            if (exportDons.length === 0) {
                alert('Không có dữ liệu đơn để xuất.');
                return;
            }

            const data = [
                ["ID", "Ngày nhận", "Nguồn đơn", "Họ tên/Cơ quan", "Địa chỉ", "Ngày ghi", "Phân loại", "Thẩm quyền", "Cán bộ PC", "Chức danh", "Xử lý/Chuyển đến", "Ngày chuyển", "Nội dung", "Đề xuất", "Kết quả chung", "Đơn vị", 
                // Thêm các cột động của Giải quyết KN
                "GQ_PC_Số", "GQ_PC_Ngày", "GQ_PC_Nội dung", "GQ_KH_Số", "GQ_KH_Ngày", "GQ_KH_Nội dung", "GQ_PH_Đơn vị", "GQ_PH_Nội dung", "GQ_ĐX_Chi tiết", "GQ_QĐGQ_Số", "GQ_QĐGQ_Ngày", "GQ_QĐGQ_Nội dung",
                // Thêm các cột động của Kiểm sát GQ
                "KS_Chuyển đến CQ", "KS_QĐGQ_Số", "KS_QĐGQ_Ngày", "KS_QĐGQ_Nội dung", "KS_QĐGQ_Cơ quan"
                ]
            ];

            exportDons.forEach(don => {
                // Xử lý Căn cứ
                let canCuStr = '';
                if (don.can_cu && Array.isArray(don.can_cu)) {
                    canCuStr = don.can_cu.map(item => 
                        `[Điểm ${item.diem || ''} Khoản ${item.khoan || ''} Điều ${item.dieu || ''} ${item.van_ban || ''}]`
                    ).join('; ');
                }
                
                data.push([
                    don.id,
                    don.ngay_nhan || '',
                    don.nguon_don || '',
                    don.ho_ten || '',
                    don.dia_chi || '',
                    don.ngay_ghi || '',
                    don.phan_loai || '',
                    don.tham_quyen || '',
                    don.can_bo_phan_cong || '',
                    don.chuc_danh || '',
                    don.chuyen_den || '',
                    don.ngay_chuyen_don || '',
                    (don.noi_dung || '') + '\n\nCăn cứ: ' + canCuStr, // Gộp Nội dung và Căn cứ
                    don.de_xuat || '',
                    don.ket_qua || '',
                    don.don_vi || '',
                    // Dữ liệu Giải quyết KN
                    don.gq_phan_cong_so || '',
                    don.gq_phan_cong_ngay || '',
                    don.gq_phan_cong_noi_dung || '',
                    don.gq_ke_hoach_so || '',
                    don.gq_ke_hoach_ngay || '',
                    don.gq_ke_hoach_noi_dung || '',
                    don.gq_dv_phoi_hop_don_vi || '',
                    don.gq_dv_phoi_hop_noi_dung || '',
                    don.gq_de_xuat_chi_tiet || '',
                    don.gq_qd_giai_quyet_so || '',
                    don.gq_qd_giai_quyet_ngay || '',
                    don.gq_qd_giai_quyet_noi_dung || '',
                    // Dữ liệu Kiểm sát GQ
                    don.ks_chuyen_den_co_quan || '',
                    don.ks_quyet_dinh_so || '',
                    don.ks_quyet_dinh_ngay || '',
                    don.ks_quyet_dinh_noi_dung || '',
                    don.ks_quyet_dinh_co_quan || ''
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DanhSachDon");
            XLSX.writeFile(wb, "DanhSachDon_VKSCT.xlsx");
        }
        
        function showReportModal() { /* (Giữ nguyên) */
            // Logic hiển thị modal báo cáo
            document.getElementById('reportModal').style.display = 'flex';
        }

        function exportReport() { /* (Giữ nguyên) */
             // Logic xuất báo cáo thống kê
             // ... (Giả định logic này giữ nguyên)
            const reportMonth = document.getElementById('report-month').value;
            const reportLevel = document.getElementById('report-level').value;

            if (!reportMonth) {
                alert('Vui lòng chọn Tháng/Năm báo cáo.');
                return;
            }

            // Lọc dữ liệu theo tháng/năm và cấp báo cáo
            let reportDons = dons.filter(don => {
                const donDate = don.ngay_nhan;
                if (!donDate) return false;

                const donMonthYear = donDate.substring(0, 7); // yyyy-mm
                if (donMonthYear !== reportMonth) return false;

                if (reportLevel === 'TP' && don.don_vi !== 'TT-KT') return false;
                if (reportLevel === 'KV' && don.don_vi === 'TT-KT') return false;

                return true;
            });
            
            if (reportDons.length === 0) {
                 alert(`Không có dữ liệu đơn trong tháng ${reportMonth.slice(5)}/${reportMonth.slice(0, 4)} để làm báo cáo.`);
                 return;
             }

            // ... (Logic tổng hợp và tạo file Excel báo cáo) ...
            
            const ws = XLSX.utils.json_to_sheet([{ A: 'Báo cáo thống kê đang được xử lý...', B: `Số lượng đơn: ${reportDons.length}` }], { header: ["A", "B"] });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "BaoCaoThongKe");
            XLSX.writeFile(wb, `BaoCao_ThongKe_${reportMonth}.xlsx`);

            alert(`Đã xuất báo cáo thống kê cho tháng ${reportMonth.slice(5)}/${reportMonth.slice(0, 4)} (${reportDons.length} đơn).`);
            document.getElementById('reportModal').style.display = 'none';
        }
        
        function downloadJSON() { /* (Giữ nguyên) */
             // Logic sao lưu JSON
            const jsonStr = JSON.stringify(dons, null, 2);
            const blob = new Blob([jsonStr], { type: "application/json;charset=utf-8" });
            saveAs(blob, `SaoLuuDuLieuDon_${new Date().toISOString().slice(0, 10)}.json`);
        }
        
        function downloadProposalDoc(id) { /* (Giữ nguyên) */
             // Logic xuất Phiếu đề xuất
            if (!id) {
                alert("Vui lòng chọn một đơn trong danh sách để xuất Phiếu Đề Xuất.");
                return;
            }
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert("Không tìm thấy dữ liệu đơn.");
                return;
            }
            const docContent = createProposalDocumentContent(don);
            saveAs(docContent, `PhieuDeXuat_${don.ho_ten || 'Don_KhieuNai'}_${don.ngay_nhan}.doc`);
        }
        
        function createProposalDocumentContent(don) { /* (Giữ nguyên) */
             // Logic tạo nội dung Phiếu đề xuất (Word DOC)
             // ... (Giả định logic này giữ nguyên)
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            
            // Xử lý Căn cứ (từ mảng can_cu)
            let canCuHtml = '';
            if (don.can_cu && Array.isArray(don.can_cu)) {
                don.can_cu.forEach((item, index) => {
                    canCuHtml += `
                        <p>Theo quy định tại Điểm ${item.diem || '...'} Khoản ${item.khoan || '...'} Điều ${item.dieu || '...'} ${item.van_ban || '...'}.</p>
                    `;
                });
            }

            // Xử lý chi tiết giải quyết (nếu có)
            let giaiQuyetKN_Details = '';
            if (don.tham_quyen === 'Thuộc thẩm quyền giải quyết') {
                giaiQuyetKN_Details = `
                    <p><b>Quyết định giải quyết (Lần 1):</b> Số ${don.gq_qd_giai_quyet_so || '...'} ngày ${don.gq_qd_giai_quyet_ngay ? new Date(don.gq_qd_giai_quyet_ngay).toLocaleDateString('vi-VN') : '...'}.</p>
                    <p><b>Nội dung Quyết định:</b></p>
                    <p style="text-indent: 30pt; white-space: pre-wrap;">${don.gq_qd_giai_quyet_noi_dung || '...'}</p>
                `;
            } else if (don.tham_quyen === 'Thuộc thẩm quyền kiểm sát') {
                giaiQuyetKN_Details = `
                    <p><b>Cơ quan chuyển đến:</b> ${don.ks_chuyen_den_co_quan || '...'}</p>
                    <p><b>Quyết định giải quyết KN của Cơ quan đó:</b> Số ${don.ks_quyet_dinh_so || '...'} ngày ${don.ks_quyet_dinh_ngay ? new Date(don.ks_quyet_dinh_ngay).toLocaleDateString('vi-VN') : '...'}.</p>
                    <p><b>Cơ quan ban hành:</b> ${don.ks_quyet_dinh_co_quan || '...'}</p>
                    <p><b>Nội dung Quyết định:</b></p>
                    <p style="text-indent: 30pt; white-space: pre-wrap;">${don.ks_quyet_dinh_noi_dung || '...'}</p>
                `;
            }

            const content = `
                <html>
                <head>
                    <meta charset="utf-8">
                    <style>
                        /* CSS cho file Word */
                         body {
                            font-family: 'Times New Roman', serif;
                            font-size: 13pt;
                            line-height: 1.5;
                        }
                        .page-content {
                            width: 17cm; 
                            margin: 0 auto; 
                            padding: 0 1cm;
                        }
                        .bold { font-weight: bold; }
                        .center { text-align: center; }
                        .right { text-align: right; }
                        .underline { text-decoration: underline; }
                        .header-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                            font-size: 11pt; 
                        }
                        .header-table td {
                            padding: 2px 0;
                            vertical-align: top;
                        }
                        /* Phần Quốc hiệu và Tiêu ngữ */
                        .quoc-hieu-container {
                            width: 50%;
                            text-align: center;
                            line-height: 1.2;
                        }
                        .quoc-hieu-container .title {
                            font-size: 13pt;
                        }
                        .quoc-hieu-container .subtitle {
                            font-size: 13pt;
                            font-weight: bold;
                            margin-top: 5px;
                        }
                        .quoc-hieu-container .separator {
                            width: 70%;
                            border-top: 1px solid black;
                            margin: 0 auto;
                        }
                        /* Địa danh và ngày tháng */
                        .right-text i {
                            font-size: 13pt;
                            font-style: italic;
                        }
                        /* Tiêu đề chính */
                        .main-title {
                            margin: 20px 0;
                            text-align: center;
                            font-size: 14pt;
                        }
                        /* Chữ ký */
                        .signature-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 40px;
                            font-size: 13pt;
                            text-align: center;
                        }
                        .signature-table td {
                            width: 33.33%; /* 3 cột */
                            padding: 10px 0;
                            vertical-align: top;
                        }
                    </style>
                </head>
                <body>
                    <div class="page-content">
                         <div style="text-align: right; font-size: 11pt; margin-top: 10px;">
                             Mẫu số <span class="subtitle">07/KT</span><br>
                             Theo QĐ số <span class="subtitle">28/QĐ-VKSTC</span><br>
                             ngày<span class="subtitle">15 tháng 02 năm 2023</span>
                         </div>
                        <table class="header-table">
                            <tr>
                                <td class="quoc-hieu-container">
                                    <span class="title">VIỆN KIỂM SÁT NHÂN DÂN</span><br>
                                    <span class="subtitle">TP. CẦN THƠ</span><br>
                                    <div class="separator"></div>
                                </td>
                                <td class="quoc-hieu-container" style="text-align: right;">
                                    <div class="center right-text">
                                        <span class="subtitle">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</span><br>
                                        <span class="subtitle">Độc lập - Tự do - Hạnh phúc</span><br>
                                        <div class="separator"></div>
                                        <i>Cần Thơ, ngày <span class="">${day}</span> tháng <span class="">${month}</span> năm <span class="">${year}</span></i>
                                    </div>
                                </td>
                            </tr>
                        </table>

                        <div class="main-title">
                            <span class="bold">PHIẾU ĐỀ XUẤT XỬ LÝ ĐƠN</span><br>
                            <span style="font-size: 12pt;">(Thuộc thẩm quyền <span class="underline">${don.tham_quyen || '...'}</span>)</span>
                        </div>

                        <p><b>Kính gửi:</b> Lãnh đạo Viện VKSND TP. Cần Thơ</p>

                        <p>Đơn của: <span class="bold">${don.ho_ten || '...'}</span>. Địa chỉ: ${don.dia_chi || '...'}.</p>
                        <p>Ngày nhận đơn: <span class="bold">${don.ngay_nhan ? new Date(don.ngay_nhan).toLocaleDateString('vi-VN') : '...'}</span>. Đơn ghi ngày: <span class="bold">${don.ngay_ghi ? new Date(don.ngay_ghi).toLocaleDateString('vi-VN') : '...'}</span>. Nguồn đơn: ${don.nguon_don || '...'} (Mã đơn: ${don.id || '...'})</p>
                        <p>Phân loại: <span class="bold">${don.phan_loai || '...'}</span>. Thẩm quyền: <span class="bold">${don.tham_quyen || '...'}</span>.</p>

                        <p class="bold">1. Tóm tắt nội dung:</p>
                        <p style="text-indent: 30pt; white-space: pre-wrap;">${don.noi_dung || '...'}</p>

                        <p class="bold">2. Căn cứ pháp luật, Quy chế nghiệp vụ:</p>
                        ${canCuHtml || '<p>Không có thông tin căn cứ.</p>'}

                        <p class="bold">3. Đề xuất của cán bộ thụ lý:</p>
                        <p style="text-indent: 30pt; white-space: pre-wrap;">${don.de_xuat || '...'}</p>
                        
                        <p class="bold">4. Kết quả xử lý đơn theo Quy chế (Xử lý chung):</p>
                        <p style="text-indent: 30pt; white-space: pre-wrap;">${don.ket_qua || '...'}</p>
                        
                        ${giaiQuyetKN_Details}
                        
                        <table class="signature-table">
                            <tr>
                                <td></td>
                                <td></td>
                                <td class="bold">NGƯỜI ĐỀ XUẤT</td>
                            </tr>
                            <tr>
                                <td class="bold">Phê duyệt của Lãnh đạo Viện</td>
                                <td class="bold">Lãnh đạo đơn vị đề xuất</td>
                                <td><span style="font-style: italic;">(Ký, ghi rõ họ tên và chức danh)</span></td>
                            </tr>
                            <tr>
                                <td class="bold" style="padding-top: 5px;">VIỆN TRƯỞNG</td>
                                <td class="bold" style="padding-top: 5px;">PHÓ CHÁNH THANH TRA</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="padding-top: 70px;">Nguyễn Thanh Liêm</td>
                                <td style="padding-top: 70px;"></td>
                                <td style="padding-top: 70px;"><span class="underline">${don.can_bo_phan_cong || '...'}</span></td>
                            </tr>
                        </table>
                    </div>
                </body>
                </html>
            `;
            const html = content;
            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            return blob;
        }
        
        function downloadResultExtractionDoc(id) { /* (Giữ nguyên) */
             // Logic xuất Kết quả xử lý đơn
            if (!id) {
                alert("Vui lòng chọn một đơn trong danh sách để xuất Kết quả xử lý đơn.");
                return;
            }
            const don = dons.find(d => d.id === id);
            if (!don) {
                alert("Không tìm thấy dữ liệu đơn.");
                return;
            }
            const docContent = createResultExtractionDocumentContent(don);
            saveAs(docContent, `KetQuaXuLy_${don.ho_ten || 'Don_KhieuNai'}_${don.ngay_nhan}.doc`);
        }
        
        function createResultExtractionDocumentContent(don) { /* (Giữ nguyên) */
             // Logic tạo nội dung Kết quả xử lý đơn (Word DOC)
             // ... (Giả định logic này giữ nguyên)
            const today = new Date();
            const day = today.getDate().toString().padStart(2, '0');
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            
            const content = `
                <html>
                <head>
                    <meta charset="utf-8">
                    <style>
                         body {
                            font-family: 'Times New Roman', serif;
                            font-size: 13pt;
                            line-height: 1.5;
                        }
                        .page-content {
                            width: 17cm; 
                            margin: 0 auto; 
                            padding: 0 1cm;
                        }
                        .bold { font-weight: bold; }
                        .center { text-align: center; }
                        .right { text-align: right; }
                        .underline { text-decoration: underline; }
                        
                        .header-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                            font-size: 11pt; 
                        }
                        .header-table td {
                            padding: 2px 0;
                            vertical-align: top;
                        }
                        
                        .quoc-hieu-container {
                            width: 50%;
                            text-align: center;
                            line-height: 1.2;
                        }
                        .quoc-hieu-container .title {
                            font-size: 13pt;
                        }
                        .quoc-hieu-container .subtitle {
                            font-size: 13pt;
                            font-weight: bold;
                            margin-top: 5px;
                        }
                        .quoc-hieu-container .separator {
                            width: 70%;
                            border-top: 1px solid black;
                            margin: 0 auto;
                        }
                        
                        .right-text i {
                            font-size: 13pt;
                            font-style: italic;
                        }
                        
                        .main-title {
                            margin: 20px 0;
                            text-align: center;
                            font-size: 14pt;
                        }
                        
                    </style>
                </head>
                <body>
                    <div class="page-content">
                        <table class="header-table">
                            <tr>
                                <td class="quoc-hieu-container">
                                    <span class="title">VIỆN KIỂM SÁT NHÂN DÂN</span><br>
                                    <span class="subtitle">TP. CẦN THƠ</span><br>
                                    <div class="separator"></div>
                                </td>
                                <td class="quoc-hieu-container" style="text-align: right;">
                                    <div class="center right-text">
                                        <span class="subtitle">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</span><br>
                                        <span class="subtitle">Độc lập - Tự do - Hạnh phúc</span><br>
                                        <div class="separator"></div>
                                        <i>Cần Thơ, ngày <span class="">${day}</span> tháng <span class="">${month}</span> năm <span class="">${year}</span></i>
                                    </div>
                                </td>
                            </tr>
                        </table>

                        <div class="main-title">
                            <span class="bold">KẾT QUẢ XỬ LÝ ĐƠN</span><br>
                            <span style="font-size: 12pt;">(Sau khi thụ lý, giải quyết, kiểm sát)</span>
                        </div>
                        
                        <p>Đơn của: <span class="bold">${don.ho_ten || '...'}</span>. Địa chỉ: ${don.dia_chi || '...'}.</p>
                        <p>Ngày nhận đơn: <span class="bold">${don.ngay_nhan ? new Date(don.ngay_nhan).toLocaleDateString('vi-VN') : '...'}</span>. Mã đơn: ${don.id || '...'})</p>
                        <p>Phân loại: <span class="bold">${don.phan_loai || '...'}</span>. Thẩm quyền: <span class="bold">${don.tham_quyen || '...'}</span>.</p>

                        <p class="bold">1. Tóm tắt nội dung đơn:</p>
                        <p style="text-indent: 30pt; white-space: pre-wrap;">${don.noi_dung || '...'}</p>

                        <p class="bold">2. Nội dung xử lý đơn:</p>
                        <p style="text-indent: 30pt;">- Cán bộ/Đơn vị thụ lý: ${don.can_bo_phan_cong || '...'} / ${don.don_vi || '...'}</p>
                        <p style="text-indent: 30pt;">- Đề xuất xử lý: <span style="white-space: pre-wrap;">${don.de_xuat || '...'}</span></p>

                        <p class="bold">3. KẾT QUẢ XỬ LÝ CHUNG:</p>
                        <p style="white-space: pre-wrap;">${don.ket_qua || '...'}</p>
                        
                    </div>
                </body>
                </html>
            `;
            const html = content;
            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            return blob;
        }

        function printProposal() { /* (Giữ nguyên) */
             // Logic in Phiếu đề xuất
            const content = document.getElementById('proposal-content').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Phiếu Đề Xuất</title>');
            printWindow.document.write(document.querySelector('style').outerHTML); // Kế thừa CSS
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="page-content">' + content + '</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        
        function printResultExtraction() { /* (Giữ nguyên) */
             // Logic in Kết quả xử lý
            const content = document.getElementById('result-extraction-content').innerHTML;
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Kết quả xử lý đơn</title>');
            printWindow.document.write(document.querySelector('style').outerHTML); // Kế thừa CSS
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="page-content">' + content + '</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
        
        // --- CHECK DUPLICATE NAME (Giữ nguyên) ---
        function checkDuplicateName(prefix = '') { /* (Giữ nguyên) */
             // Logic kiểm tra trùng tên
            const currentName = document.getElementById(prefix + 'ho_ten').value.trim();
            const currentId = document.getElementById(prefix === 'sua-' ? 'edit-id' : 'edit-id').value; // Sử dụng edit-id chung

            // Chỉ kiểm tra khi là đơn mới hoặc tên khác
            if (!currentName) return;

            const duplicate = dons.some(don => 
                don.ho_ten.trim().toLowerCase() === currentName.toLowerCase() && don.id !== currentId 
            );

            if (duplicate) {
                if (confirm(`Có vẻ như đơn của "${currentName}" đã có trong hệ thống. Bạn có muốn xem danh sách đơn đã có không?`)) {
                    // Tự động tìm kiếm theo tên
                    document.getElementById('search-text').value = currentName;
                    filterTable();
                    // Chuyển về tab thụ lý đơn nếu không phải đang ở đó
                    showSection('thuly'); 
                }
            }
        }
        
        // --- NEW PHASE 3 FUNCTIONS ---

        function showSection(sectionId) {
            // Ẩn tất cả các section nội dung
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            // Loại bỏ class 'active' khỏi tất cả các nút menu
            document.querySelectorAll('#main-menu button').forEach(button => {
                button.classList.remove('active');
            });

            // Hiển thị section được chọn và thêm class 'active' cho nút tương ứng
            const selectedSection = document.getElementById(sectionId + '-section');
            const selectedButton = document.getElementById('menu-btn-' + sectionId);

            if (selectedSection && selectedButton) {
                selectedButton.classList.add('active');
                
                // Sử dụng flex cho giao diện 2 cột hoặc 1 cột
                selectedSection.style.display = 'flex'; 
                
                // Xử lý logic đặc thù
                if (sectionId === 'giaiquyet') {
                    // Khi chuyển sang section Giải quyết, gọi hàm load dữ liệu
                    loadGiaiQuyetDons();
                } else if (sectionId === 'thuly') {
                    // Khi trở lại thụ lý đơn, đảm bảo bảng hiển thị đúng (có thể gọi updateTable() nếu cần thiết)
                    updateTable(dons); 
                }
            }
        }

        function loadGiaiQuyetDons() {
            const giaiQuyetBody = document.getElementById('giaiquyet-don-body');
            giaiQuyetBody.innerHTML = ''; // Xóa nội dung cũ
            
            // Lọc ra các đơn có thẩm quyền là "Thuộc thẩm quyền giải quyết"
            const filteredDons = dons.filter(don => don.tham_quyen === 'Thuộc thẩm quyền giải quyết');

            if (filteredDons.length === 0) {
                giaiQuyetBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Không có đơn thuộc thẩm quyền giải quyết để chuyển.</td></tr>';
                return;
            }
            
            // Lọc thêm theo đơn vị/cán bộ nếu cần (tương tự updateTable)
             let finalDons = filteredDons;
             if (currentUser && currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                finalDons = finalDons.filter(don => don.don_vi === currentUser.unit);
            }
            if (currentUser && (currentUser.role === 'user_TP' || currentUser.role === 'user_KV')) {
                finalDons = finalDons.filter(don => don.can_bo_phan_cong === currentUser.username);
            }

            finalDons.forEach((don, index) => {
                const row = giaiQuyetBody.insertRow();
                // Tái sử dụng highlightSelectedRow (cần đảm bảo ID không trùng lặp nếu có nhiều bảng)
                // row.onclick = () => { highlightSelectedRow(row, don.id); }; 
                
                row.insertCell().textContent = index + 1;
                row.insertCell().textContent = don.ngay_nhan || '';
                row.insertCell().textContent = don.ho_ten || '';
                row.insertCell().textContent = don.noi_dung ? (don.noi_dung.substring(0, 50) + '...') : '';
                row.insertCell().textContent = don.phan_loai || '';
                row.insertCell().textContent = don.tham_quyen || '';
                row.insertCell().textContent = don.gq_qd_giai_quyet_so ? 'Đã GQ' : 'Đang xử lý'; // Trạng thái giải quyết (dummy)
                
                // Thao tác
                const actionsCell = row.insertCell();
                actionsCell.className = 'table-actions';
                const editButton = document.createElement('button');
                editButton.className = 'edit-btn';
                editButton.textContent = 'Chi tiết/Sửa';
                editButton.onclick = (event) => { 
                    event.stopPropagation();
                    // Mở modal Sửa đổi để xem/chỉnh sửa thông tin chi tiết giải quyết
                    editDon(don.id); 
                    document.getElementById('editModal').style.display = 'flex';
                };
                actionsCell.appendChild(editButton);
            });
        }

        // Hàm dummy cho các nút lưu Kiểm sát
        function saveKiemSatData() {
            // Lấy dữ liệu từ form Kiểm sát (ks_qd_truc_tiep_so, ks_yc_tu_kt_so,...)
            const ks_qd_truc_tiep_so = document.getElementById('ks_qd_truc_tiep_so').value;
            const ks_yc_tu_kt_so = document.getElementById('ks_yc_tu_kt_so').value;

            if (!ks_qd_truc_tiep_so && !ks_yc_tu_kt_so) {
                 alert('Vui lòng nhập ít nhất thông tin Quyết định trực tiếp kiểm sát hoặc Yêu cầu tự kiểm tra.');
                 return;
            }

            // *Logic lưu dữ liệu Kiểm sát vào Firebase sẽ được thêm vào sau*
            alert('Chức năng Lưu thông tin Kiểm sát đang được xây dựng (Giai đoạn 3). Đã nhận dữ liệu tạm thời.');
            
            // Clear form sau khi lưu
            document.getElementById('ks_qd_truc_tiep_so').value = '';
            document.getElementById('ks_qd_truc_tiep_ngay').value = '';
            document.getElementById('ks_qd_truc_tiep_co_quan').value = '';
            document.getElementById('ks_qd_truc_tiep_noi_dung').value = '';
            document.getElementById('ks_yc_tu_kt_so').value = '';
            document.getElementById('ks_yc_tu_kt_ngay').value = '';
            document.getElementById('ks_yc_tu_kt_co_quan').value = '';
            document.getElementById('ks_yc_tu_kt_noi_dung').value = '';

        }
        
        // Hàm dummy cho các nút lưu Văn bản ban hành
        function saveVanBanData() {
            // Lấy dữ liệu từ form Văn bản (vb_loai_van_ban, vb_so_van_ban,...)
             const vb_loai_van_ban = document.getElementById('vb_loai_van_ban').value;
             const vb_so_van_ban = document.getElementById('vb_so_van_ban').value;
             const vb_ngay_ban_hanh = document.getElementById('vb_ngay_ban_hanh').value;

             if (vb_loai_van_ban === 'Chọn' || !vb_so_van_ban || !vb_ngay_ban_hanh) {
                 alert('Vui lòng điền đủ Loại văn bản, Số và Ngày ban hành.');
                 return;
             }
             
            // *Logic lưu dữ liệu Văn bản vào Firebase sẽ được thêm vào sau*
            alert('Chức năng Lưu thông tin Văn bản ban hành đang được xây dựng (Giai đoạn 3). Đã nhận dữ liệu tạm thời.');
            
             // Clear form sau khi lưu
             document.getElementById('vb_loai_van_ban').value = 'Chọn';
             document.getElementById('vb_so_van_ban').value = '';
             document.getElementById('vb_ngay_ban_hanh').value = '';
             document.getElementById('vb_co_quan_nhan').value = '';
             document.getElementById('vb_noi_dung_tom_tat').value = '';

        }
        
        function exportGiaiQuyetList() {
            alert('Chức năng Xuất Danh sách Giải quyết đơn đang được xây dựng (Giai đoạn 3).');
            // Logic xuất Excel sẽ được thêm vào sau, sử dụng dữ liệu từ loadGiaiQuyetDons().
        }

        // --- INITIALIZATION (Giữ nguyên) ---
        function init() {
            // Khởi tạo các dropdown
            populateSelects();
            populateSelects('sua-');
            populateUnitSelect('new-unit');
            
            // Clear các form lúc ban đầu
            clearForm();
            clearForm('sua-');
            
            // Thiết lập lắng nghe phím Enter cho đăng nhập
            setupEnterKeyListener(); 
            
            // Ẩn nút quản lý tài khoản mặc định
            const accountBtn = document.getElementById('account-btn');
            if (accountBtn) {
                accountBtn.style.display = 'none'; 
            }
        }
        
        // Thêm tính năng nghe phím Enter cho đăng nhập (Giữ nguyên)
        function setupEnterKeyListener() {
             const usernameInput = document.getElementById('username');
             const passwordInput = document.getElementById('password');
             
             if (usernameInput) {
                 usernameInput.addEventListener('keydown', function(event) {
                     if (event.key === 'Enter') {
                         event.preventDefault(); 
                         login();
                     }
                 });
             }
             if (passwordInput) {
                 passwordInput.addEventListener('keydown', function(event) {
                     if (event.key === 'Enter') {
                         event.preventDefault(); 
                         login();
                     }
                 });
             }
        }
        
        // Gọi hàm khởi tạo khi trang tải xong
        document.addEventListener('DOMContentLoaded', init);
        function handleImport(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        // Thêm cấu hình cellDates: true để thư viện hỗ trợ đọc ngày tháng
        const workbook = XLSX.read(data, {type: 'array', cellDates: true});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        if (confirm(`Bạn có muốn nhập ${jsonData.length} dòng dữ liệu này vào hệ thống không?`)) {
            jsonData.forEach(item => {
                // Hàm định dạng ngày tháng (xử lý cả trường hợp số sê-ri Excel)
                const formatDate = (val) => {
                    if (!val) return "";
                    let date = new Date(val);
                    // Kiểm tra nếu ngày tháng không hợp lệ (lỗi số sê-ri)
                    if (isNaN(date.getTime())) return val; 
                    
                    let day = ("0" + date.getDate()).slice(-2);
                    let month = ("0" + (date.getMonth() + 1)).slice(-2);
                    let year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };

                // Đẩy dữ liệu lên Firebase
                firebase.database().ref('dons').push({
                    ngay_nhan: formatDate(item["Ngày nhận đơn"]),
                    ho_ten: item["Họ tên /CQ/ TC"] || "",
                    dia_chi: item["Địa chỉ"] || "",
                    phan_loai: item["Phân loại"] || "",
                    noi_dung: item["Nội dung đơn"] || "",
                    nguon_don: "Bưu điện",
                    ngay_ghi: formatDate(item["Ngày đơn"]),
                    can_bo_phan_cong: "Nguyễn Hoàng Thiên Phúc",
                    timestamp: Date.now()
                });
            });
            alert("Đã nhập dữ liệu thành công với định dạng ngày chuẩn!");
            location.reload();
        }
    };
    reader.readAsArrayBuffer(file);
}
    </script>
</body>
</html>
