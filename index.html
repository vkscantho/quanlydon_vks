<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app https://*.jsdelivr.net; 
                 connect-src 'self' https://www.gstatic.com https://*.googleapis.com https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com wss://*.firebasedatabase.app https://*.jsdelivr.net;
                 img-src 'self' data: https://vienkiemsat.cantho.gov.vn https://upload.wikimedia.org blob:;">

    <title>Phần Mềm Quản Lý Đơn Khiếu nại - Tố Cáo</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    
    <style>
        
        body {
            font-family: 'Segoe UI', 'Times New Roman', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
        }

        header {
            width: 100%;
            padding: 20px;
            background-color: #0408c5;
            color: white;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        
        #login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #E6F7FF; /* Xanh dương nhạt */
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            margin: auto;
            position: absolute;
            top: 55%; /* Tăng từ 50% lên 55% */
            left: 50%;
            transform: translate(-50%, -50%);
        }

        #login-container h2 {
            margin-bottom: 20px;
            color: #D32F2F; /* Đỏ */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #login-container input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background-color: #5670e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        #login-container button:hover {
            background-color: #5670e6;
        }

        #main-container {
            display: none;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            margin-top: 20px;
        }
        
        .main-content {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: calc(100% - 60px);
            gap: 20px;
            padding: 0 20px;
        }
        
        .sidebar {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .main-panel {
            flex: 2;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow-y: auto;
        }
        
        .sidebar button, .main-panel button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            color: white;
            background-color: #5670e6;
            transition: background-color 0.3s;
        }

        .sidebar button:hover, .main-panel button:hover {
            background-color: #5670e6;
        }
        
        .form-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-section.full-width {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            background-color: #f9f9f9;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* NEW CAN CU STYLING */
        .can-cu-row {
            margin-bottom: 10px; 
            padding: 5px;
            border: 1px dashed #ccc;
            border-radius: 5px;
        }
        .can-cu-item {
            display: grid;
            grid-template-columns: 0.5fr 0.5fr 1fr 2fr auto; /* Diem, Khoan, Dieu, Van Ban, Button */
            gap: 10px;
        }
        .can-cu-sub-item {
            display: none; 
            grid-column: 1 / -1; 
            margin-top: 5px;
        }
        .can-cu-sub-item.form-group {
            display: flex; 
            flex-direction: column;
        }
        /* END NEW CAN CU STYLING */

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #e0f2f1;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f5f5f5;
        }
        
        tr:hover {
            background-color: #e8f5e9;
        }
        
        .table-actions button {
            padding: 5px 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .table-actions td {
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

         .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 600px; 
            width: 90%;
            position: relative;
            max-height: 90vh; 
            overflow-y: auto; 
        }

      
        .modal-content.large-modal {
            max-width: 90%; 
            max-width: 1200px; 
        }
        
        
        #accountsModal .modal-content {
            max-width: 700px; 
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }
        
        .close-btn:hover, .close-btn:focus {
            color: #000;
        }
        
        .btn-container {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .delete-btn {
            background-color: #d32f2f !important;
        }
        
        .delete-btn:hover {
            background-color: #b71c1c !important;
        }
        
        .edit-btn {
            background-color: #1976d2 !important;
        }
        
        .edit-btn:hover {
            background-color: #1565c0 !important;
        }
        
        .proposal-print-btn {
            background-color: #388e3c !important; /* Green color for new print button */
            margin-top: 5px; 
        }
        
        .proposal-print-btn:hover {
            background-color: #2e7d32 !important;
        }
        
        .export-proposal-btn {
            background-color: #3f51b5 !important;
        }
        
        .export-proposal-btn:hover {
            background-color: #303f9f !important;
        }
        
      
        #proposal-content {
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
            font-size: 14pt; 
            line-height: 1.5;
        }
        
        #top-right-buttons {
            position: absolute;
            top: 10px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        #account-list li {
            list-style: none;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #account-list li button {
             margin-left: 10px;
             padding: 5px 10px;
             font-size: 12px;
             width: auto;
        }
        .reset-btn {
             background-color: #ff9800 !important;
        }
        .reset-btn:hover {
             background-color: #fb8c00 !important;
        }
    </style>
</head>
<body>
    <header>
        <h1>VIỆN KIỂM SÁT NHÂN DÂN THÀNH PHỐ CẦN THƠ</h1>
        <H2>QUẢN LÝ ĐƠN KHIẾU NẠI - TỐ CÁO</H2>
        <div id="top-right-buttons">
            <button id="account-btn" onclick="showAccountsModal()">Quản lý tài khoản</button>
            <button onclick="showChangePassModal()">Đổi mật khẩu</button> 
            <button onclick="logout()">Đăng xuất</button>
        </div>
    </header>

    <div id="login-container">
        <img src="https://vienkiemsat.cantho.gov.vn/files/images/logo-vks.png" 
             alt="Logo Viện Kiểm Sát" style="width: 100px; margin-bottom: 20px;">
        <h2>Đăng Nhập</h2>
        <input type="text" id="username" placeholder="Tên đăng nhập">
        <input type="password" id="password" placeholder="Mật khẩu">
        <button onclick="login()">Đăng Nhập</button>
        <p><a href="#" onclick="handleForgotPassword()">Quên mật khẩu?</a></p>
    </div>
            
    <div id="main-container">
        <div class="main-content">
            <div class="sidebar">
                <h2>Lưu đơn mới</h2>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_nhan">Ngày nhận đơn:</label>
                        <input type="date" id="ngay_nhan">
                    </div>
                    <div class="form-group">
                        <label for="nguon_don">Nguồn đơn:</label>
                        <select id="nguon_don"></select>
                    </div>
                </div>
                <div class="form-section full-width">
                    <div class="form-group">
                        <label for="ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                        <input type="text" id="ho_ten">
                    </div>
                    <div class="form-group">
                        <label for="dia_chi">Địa chỉ:</label>
                        <input type="text" id="dia_chi">
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="ngay_ghi">Đơn ghi ngày:</label>
                        <input type="date" id="ngay_ghi">
                    </div>
                    <div class="form-group">
                        <label for="phan_loai">Phân loại:</label>
                        <select id="phan_loai" onchange="capNhatThamQuyenMacDinh()">
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                        </select>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="tham_quyen">Thẩm quyền:</label>
                        <select id="tham_quyen">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                            <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                            <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="can_bo_phan_cong">Cán bộ phân công:</label>
                        <input type="text" id="can_bo_phan_cong" readonly>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <label for="chuc_danh">Chức danh:</label>
                        <select id="chuc_danh">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                            <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                            <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                            <option value="Kiểm tra viên">Kiểm tra viên</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chuyen_den">Chuyển đến:</label>
                        <select id="chuyen_den"></select>
                    </div>
                </div>
                <div class="form-section">
                     <div class="form-group">
                        <label for="ngay_chuyen_don">Ngày chuyển đơn:</label>
                        <input type="date" id="ngay_chuyen_don">
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Căn cứ:</label>
                    <div id="can_cu_container"></div>
                    <button onclick="addCanCu()">Thêm căn cứ</button>
                </div>
                <div class="form-group full-width">
                    <label for="noi_dung">Nội dung đơn:</label>
                    <textarea id="noi_dung"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="de_xuat">Đề xuất:</label>
                    <textarea id="de_xuat"></textarea>
                </div>
                <div class="form-group full-width">
                    <label for="ket_qua">Kết quả:</label>
                    <textarea id="ket_qua"></textarea>
                </div>
                <input type="hidden" id="edit-id">
                <button onclick="saveDon()">Lưu đơn</button>
            </div>

            <div class="main-panel">
                <h2>Danh sách theo dõi đơn</h2>
                <div class="btn-container" style="justify-content: flex-start; margin-bottom: 20px;">
                    <button onclick="exportList()">Xuất Danh sách đơn</button>
                    <button onclick="exportReport()">Xuất báo cáo</button>
                    <button onclick="downloadJSON()">Sao lưu JSON</button>
                    <button class="export-btn proposal-print-btn" onclick="showProposalModal(currentSelectedId)">Trích xuất Đề xuất/Xử lý (Đơn đã chọn)</button> 
                </div>
            <div class="search-bar" style="margin-bottom: 20px;">
                <input type="text" id="search-text" placeholder="Tìm kiếm theo Họ tên/Cơ quan/Tổ chức..." style="padding: 8px; width: 40%; border: 1px solid #ccc; border-radius: 4px;">
                <input type="date" id="search-date" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                <button class="search-btn" onclick="filterTable()">Tìm Kiếm</button>
                <button class="reset-btn" onclick="resetFilter()">Xóa Bộ Lọc</button>
            </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ngày nhận đơn</th>
                            <th>Họ tên /CQ/ TC</th>
                            <th>Nội dung đơn</th>
                            <th>Phân loại</th>
                            <th>Thẩm quyền</th>
                            <th>Xử lý đơn</th> 
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="don-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="accountsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('accountsModal').style.display='none'">&times;</span>
            <h3>Quản lý Tài khoản</h3>
            <h4>Tạo tài khoản mới</h4>
            <div class="form-section">
                <div class="form-group">
                    <label for="new-username">Tên đăng nhập:</label>
                    <input type="text" id="new-username">
                </div>
                <div class="form-group">
                    <label for="new-password">Mật khẩu:</label>
                    <input type="password" id="new-password">
                </div>
                <div class="form-group">
                    <label for="new-role">Vai trò:</label>
                    <select id="new-role">
                        <option value="admin">Quản trị viên (admin)</option>
                        <option value="manager_TP">Lãnh đạo cấp Thành phố</option>
                        <option value="user_TP">Cán bộ cấp Thành phố</option>
                        <option value="manager_KV">Lãnh đạo cấp Khu vực</option>
                        <option value="user_KV">Cán bộ cấp Khu vực</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="new-unit">Đơn vị:</label>
                    <select id="new-unit"></select>
                </div>
            </div>
            <button onclick="createAccount()">Tạo tài khoản</button>
            <h4>Danh sách tài khoản</h4>
            <ul id="account-list"></ul>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
            <h3>Sửa đổi đơn</h3>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_nhan">Ngày nhận đơn:</label>
                    <input type="date" id="sua-ngay_nhan">
                </div>
                <div class="form-group">
                    <label for="sua-nguon_don">Nguồn đơn:</label>
                    <select id="sua-nguon_don"></select>
                </div>
            </div>
            <div class="form-section full-width">
                <div class="form-group">
                    <label for="sua-ho_ten">Họ tên/Cơ quan/Tổ chức:</label>
                    <input type="text" id="sua-ho_ten">
                </div>
                <div class="form-group">
                    <label for="sua-dia_chi">Địa chỉ:</label>
                    <input type="text" id="sua-dia_chi">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_ghi">Đơn ghi ngày:</label>
                    <input type="date" id="sua-ngay_ghi">
                </div>
                <div class="form-group">
                    <label for="sua-phan_loai">Phân loại:</label>
                    <select id="sua-phan_loai" onchange="capNhatThamQuyenMacDinh('sua-')">
                            <option value="Chọn">--Chọn--</option>
                            <option value="Khiếu nại">Khiếu nại</option>
                            <option value="Tố cáo">Tố cáo</option>
                            <option value="Kiến nghị/Phản ánh/Khác">Kiến nghị/Phản ánh/Khác</option>
                            <option value="Yêu cầu bồi thường thiệt hại">Yêu cầu bồi thường thiệt hại</option> 
                            <option value="Đề nghị KN, GĐT, TT">Đề nghị KN, GĐT, TT</option>
                            <option value="Đề nghị kiểm tra QĐGQKN">Đề nghị kiểm tra QĐGQKN</option>
                            <option value="Tin báo/Tố giác tội phạm trong HĐTP">Tin báo/Tố giác tội phạm trong HĐTP</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-tham_quyen">Thẩm quyền:</label>
                    <select id="sua-tham_quyen">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Thuộc thẩm quyền giải quyết">Thuộc thẩm quyền giải quyết</option>
                        <option value="Thuộc thẩm quyền kiểm sát">Thuộc thẩm quyền kiểm sát</option>
                        <option value="Không thuộc thẩm quyền">Không thuộc thẩm quyền</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-can_bo_phan_cong">Cán bộ phân công:</label>
                    <input type="text" id="sua-can_bo_phan_cong">
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-chuc_danh">Chức danh:</label>
                    <select id="sua-chuc_danh">
                        <option value="Chọn">--Chọn--</option>
                        <option value="Kiểm sát viên trung cấp">Kiểm sát viên trung cấp</option>
                        <option value="Kiểm sát viên sơ cấp">Kiểm sát viên sơ cấp</option>
                        <option value="Kiểm tra viên chính">Kiểm tra viên chính</option>
                        <option value="Kiểm tra viên">Kiểm tra viên</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sua-chuyen_den">Chuyển đến:</label>
                    <select id="sua-chuyen_den"></select>
                </div>
            </div>
            <div class="form-section">
                <div class="form-group">
                    <label for="sua-ngay_chuyen_don">Ngày chuyển đơn:</label>
                    <input type="date" id="sua-ngay_chuyen_don">
                </div>
            </div>
             <div class="form-group full-width">
                <label>Căn cứ:</label>
                <div id="sua-can_cu_container"></div>
                <button onclick="addCanCu('sua-')">Thêm căn cứ</button>
            </div>
            <div class="form-group full-width">
                <label for="sua-noi_dung">Nội dung đơn:</label>
                <textarea id="sua-noi_dung"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-de_xuat">Đề xuất:</label>
                <textarea id="sua-de_xuat"></textarea>
            </div>
            <div class="form-group full-width">
                <label for="sua-ket_qua">Kết quả:</label>
                <textarea id="sua-ket_qua"></textarea>
            </div>
            <input type="hidden" id="edit-id-modal"> 
            <div class="btn-container">
                <button onclick="updateDon()">Cập nhật</button>
            </div>
        </div>
    </div>
    
    <div id="changePassModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('changePassModal').style.display='none'">&times;</span>
            <h3>Đổi mật khẩu</h3>
            <div class="form-group">
                <label for="old-password">Mật khẩu cũ:</label>
                <input type="password" id="old-password">
            </div>
            <div class="form-group">
                <label for="new-password-change">Mật khẩu mới:</label>
                <input type="password" id="new-password-change">
            </div>
            <div class="form-group">
                <label for="confirm-password-change">Xác nhận mật khẩu mới:</label>
                <input type="password" id="confirm-password-change">
            </div>
            <div class="btn-container">
                <button onclick="changePassword()">Xác nhận</button>
            </div>
        </div>
    </div>
    
     <div id="proposalModal" class="modal">
        <div class="modal-content large-modal">
            <span class="close-btn" onclick="document.getElementById('proposalModal').style.display='none'">&times;</span>
            <h3>Xem trước Đề xuất/Xử lý đơn</h3>
            <div style="border: 1px solid #ccc; padding: 15px; background-color: #f9f9f9; max-height: 70vh; overflow-y: auto;">
                <pre id="proposal-content"></pre>
            </div>
            <div class="btn-container">
                <button class="export-proposal-btn" onclick="downloadResolutionResultDoc(currentSelectedId)">Xuất File Word (.doc)</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. FIREBASE CONFIGURATION & INITIALIZATION (PHẢI THAY THẾ) ---
        // THAY THẾ CHỖ NÀY BẰNG CẤU HÌNH CỦA BẠN
        const firebaseConfig = {
            apiKey: "AIzaSyBvhrOBoJc9-gKuTAXDlPknVdxKecgPH_g",
            authDomain: "quanlydonvks-d7ff9.firebaseapp.com",
            databaseURL: "https://quanlydonvks-d7ff9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quanlydonvks-d7ff9",
            storageBucket: "quanlydonvks-d7ff9.firebasestorage.app",
            messagingSenderId: "209768483000",
            appId: "1:209768483000:web:1eb449ad41840e23334c4d"
        };
        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- GLOBAL DATA & INITIALIZATION ---
        let accounts = {}; // Dữ liệu tài khoản (tải từ Firebase)
        let dons = []; // Dữ liệu đơn (tải từ Firebase dưới dạng mảng để dễ xử lý)
        let currentUser = null; 
        let currentSelectedId = null; // Thêm biến theo dõi đơn đang chọn để dùng cho export

        // Dữ liệu danh mục
        const lookupData = {
            'Nguồn đơn': [
               'Bưu điện', 'Tiếp công dân', 'Các cơ quan Đảng, Nhà nước', 'UBND TPCT',
                'Cục Điều tra, VKSTC', 'V11, VKSTC', 'V12, VKSTC', 'Các Sở, Ban, Ngành', 'Thành ủy'
            ],
            'Chuyển đến': [
                'Lưu đơn', 'Trả đơn', 'Thông báo chỉ dẫn',
                'THADS TP.CT', 'THADS KV1','THADS KV2','THADS KV3','THADS KV4','THADS KV5','THADS KV6','THADS KV7',
                'THADS KV8','THADS KV9','THADS KV10','THADS KV11','THADS KV12','THADS KV13','THADS KV14',
                'TAND TP.CT', 'TAND KV1', 'TAND KV2','TAND KV3','TAND KV4','TAND KV5','TAND KV6','TAND KV7',
                'TAND KV8','TAND KV9','TAND KV10','TAND KV11','TAND KV12','TAND KV13','TAND KV14',
                'CQCSĐT TP.CT', 'Công an phường', 
                'VKSND KV1',  'VKSND KV2', 'VKSND KV3', 'VKSND KV4', 'VKSND KV5', 'VKSND KV6', 'VKSND KV7',
                'VKSND KV8', 'VKSND KV9', 'VKSND KV10', 'VKSND KV11', 'VKSND KV12', 'VKSND KV13', 'VKSND KV14',
                'Phòng 1', 'Phòng 2', 'Phòng 7', 'Phòng 8', 'Phòng 9', 'Phòng 10', 'Phòng 11', 'Phòng 15'
            ],
            'Đơn vị': [
                'Thành phố', 'VKSND KV1',  'VKSND KV2', 'VKSND KV3', 'VKSND KV4', 'VKSND KV5', 'VKSND KV6', 'VKSND KV7',
                'VKSND KV8', 'VKSND KV9', 'VKSND KV10', 'VKSND KV11', 'VKSND KV12', 'VKSND KV13', 'VKSND KV14'
            ]
        };
        
        // DANH SÁCH VĂN BẢN (Căn cứ) MỚI
        const vanBanList = [
            'Quy chế số: 222/QĐ-VKSTC ngày 22/6/2023 của VKSNDTC',
            'Bộ Luật Tố tụng Hình sự',
            'Bộ Luật Tố tụng dân sự',
            'Bộ luật Tố tụng hành chính',
            'Luật THADS',
            'Tự điền vào văn bản' // Tùy chọn cuối cùng
        ];
        
        // --- AUTHENTICATION FUNCTIONS ---
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            database.ref('accounts').once('value')
                .then(snapshot => {
                    const accounts = snapshot.val() || {};
                    if (accounts[username] && accounts[username].password === password) {
                        currentUser = { username: username, role: accounts[username].role, unit: accounts[username].unit };
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('main-container').style.display = 'flex';
                        document.getElementById('can_bo_phan_cong').value = currentUser.username;
                        
                        if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                            document.getElementById('account-btn').style.display = 'block';
                        } else {
                            document.getElementById('account-btn').style.display = 'none';
                        }
                        
                        updateTable();
                    } else {
                        alert('Tên đăng nhập hoặc mật khẩu không đúng!');
                    }
                })
                .catch(error => {
                    alert('Lỗi khi đăng nhập: ' + error.message);
                });
        }
        function logout() {
            currentUser = null;
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('account-btn').style.display = 'none';
            currentSelectedId = null;
        }
        
        function showChangePassModal() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập trước.');
                return;
            }
            document.getElementById('old-password').value = '';
            document.getElementById('new-password-change').value = '';
            document.getElementById('confirm-password-change').value = '';
            document.getElementById('changePassModal').style.display = 'flex';
        }

        function changePassword() {
            const oldPass = document.getElementById('old-password').value;
            const newPass = document.getElementById('new-password-change').value;
            const confirmPass = document.getElementById('confirm-password-change').value;

            if (!currentUser) return alert('Vui lòng đăng nhập trước.');
            
            database.ref('accounts/' + currentUser.username).once('value').then(snap => {
                const currentAccount = snap.val();
                
                if (!currentAccount) return alert('Lỗi: Không tìm thấy thông tin tài khoản.');

                if (oldPass === currentAccount.password) {
                    if (newPass === confirmPass) {
                        if (newPass.length < 3) {
                            alert('Mật khẩu mới phải có ít nhất 3 ký tự.');
                            return;
                        }
                        database.ref('accounts/' + currentUser.username + '/password').set(newPass)
                            .then(() => {
                                alert('Mật khẩu đã được thay đổi thành công!');
                                document.getElementById('changePassModal').style.display = 'none';
                                accounts[currentUser.username].password = newPass; 
                            }).catch(error => {
                                alert('Lỗi khi đổi mật khẩu: ' + error.message);
                            });
                    } else {
                        alert('Mật khẩu mới không khớp.');
                    }
                } else {
                    alert('Mật khẩu cũ không đúng.');
                }
            }).catch(error => {
                alert('Lỗi khi kiểm tra mật khẩu: ' + error.message);
            });
        }
        
        function handleForgotPassword() {
             const username = prompt('Vui lòng nhập tên đăng nhập của bạn:');
             if (!username) return;

             database.ref('accounts/' + username).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                         if (confirm('Hệ thống sẽ đặt lại mật khẩu của bạn về "123". Vui lòng đăng nhập và đổi lại mật khẩu.')) {
                            database.ref('accounts/' + username + '/password').set('123')
                                .then(() => {
                                     alert('Đã đặt lại mật khẩu thành công!');
                                }).catch(error => {
                                     alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                                });
                        }
                    } else {
                        alert('Tên đăng nhập không tồn tại.');
                    }
                })
                .catch(error => {
                     alert('Lỗi khi kiểm tra tài khoản: ' + error.message);
                });
        }
        
        function initializeDefaultAccounts() {
            database.ref('accounts').once('value').then(snapshot => {
                if (!snapshot.exists()) {
                    const defaultAccounts = {
                        "adminct": { "password": "123", "role": "admin", "unit": "Thành phố" },
                        "quanlyTP": { "password": "123", "role": "manager_TP", "unit": "Thành phố" },
                        "userTP": { "password": "123", "role": "user_TP", "unit": "Thành phố" }
                    };
                    database.ref('accounts').set(defaultAccounts)
                        .catch(error => console.error("Lỗi khi tạo tài khoản mặc định:", error));
                }
            });
            
            database.ref('accounts').on('value', snap => {
                accounts = snap.val() || {};
            });
        }

        // --- ACCOUNT MANAGEMENT FUNCTIONS ---
        function showAccountsModal() {
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'super_admin')) {
                document.getElementById('accountsModal').style.display = 'flex';
                renderAccounts();
            } else {
                alert('Bạn không có quyền quản lý tài khoản.');
            }
        }
        
        function createAccount() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            const unit = document.getElementById('new-unit').value;

            if (!username || !password || !role || !unit) {
                alert('Vui lòng nhập đầy đủ thông tin.');
                return;
            }
             if (password.length < 3) {
                alert('Mật khẩu phải có ít nhất 3 ký tự.');
                return;
            }
            if (accounts[username]) {
                alert('Tên đăng nhập đã tồn tại.');
                return;
            }

            const newAccount = {
                password: password,
                role: role,
                unit: unit
            };

            database.ref('accounts/' + username).set(newAccount)
                .then(() => {
                    alert('Tài khoản đã được tạo thành công!');
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('new-role').value = 'user_TP';
                    capNhatDonViTheoVaiTro(); 
                })
                .catch(error => {
                    alert('Lỗi khi tạo tài khoản: ' + error.message);
                });
        }
        
        function renderAccounts() {
            const list = document.getElementById('account-list');
            list.innerHTML = '';

            for (const username in accounts) {
                const account = accounts[username];
                if (username === currentUser.username) continue;

                const li = document.createElement('li');
                li.innerHTML = `
                    <div>
                        <strong>${username}</strong> (${account.role} - ${account.unit})
                    </div>
                    <div>
                        <button class="reset-btn" onclick="resetPasswordForAccount('${username}')">Reset Mật khẩu</button>
                        <button class="delete-btn" onclick="deleteAccount('${username}')">Xóa</button>
                    </div>
                `;
                list.appendChild(li);
            }
        }
        
        // Function to reset password for a sub-account
        function resetPasswordForAccount(username) {
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Bạn không có quyền thực hiện chức năng này.');
                return;
            }
            if (confirm(`Bạn có chắc chắn muốn đặt lại mật khẩu tài khoản ${username} về "123"?`)) {
                 database.ref('accounts/' + username + '/password').set('123')
                    .then(() => {
                        alert(`Đã đặt lại mật khẩu cho tài khoản ${username} về "123" thành công!`);
                        // Cập nhật lại biến accounts cục bộ
                        if (accounts[username]) {
                             accounts[username].password = '123';
                        }
                    }).catch(error => {
                        alert('Lỗi khi đặt lại mật khẩu: ' + error.message);
                    });
            }
        }

        function deleteAccount(username) {
            if (confirm(`Bạn có chắc chắn muốn xóa tài khoản ${username}?`)) {
                database.ref('accounts/' + username).remove()
                    .then(() => {
                        alert('Tài khoản đã được xóa thành công.');
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa tài khoản: ' + error.message);
                    });
            }
        }
        
        function capNhatDonViTheoVaiTro() {
            const roleSelect = document.getElementById('new-role');
            const unitSelect = document.getElementById('new-unit');
            const role = roleSelect.value;
            
            unitSelect.innerHTML = '';
            unitSelect.disabled = false;
            
            // Lấy danh sách Đơn vị từ lookupData, bỏ 'Thành phố' nếu là cấp Khu vực
            let units = [...lookupData['Đơn vị']];
            if (role.endsWith('_KV')) {
                units = units.filter(u => u !== 'Thành phố');
            } else if (role.endsWith('_TP') || role === 'admin' || role === 'super_admin') {
                 units = units.filter(u => u === 'Thành phố');
            }
            
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                unitSelect.appendChild(option);
            });
        }

        // --- FORM & DATA FUNCTIONS ---
        function clearForm() {
            document.getElementById('ngay_nhan').value = new Date().toISOString().slice(0, 10);
            document.getElementById('nguon_don').value = '';
            document.getElementById('ho_ten').value = '';
            document.getElementById('dia_chi').value = '';
            document.getElementById('ngay_ghi').value = '';
            document.getElementById('phan_loai').value = 'Khiếu nại';
            document.getElementById('tham_quyen').value = 'Thuộc thẩm quyền giải quyết';
            document.getElementById('can_bo_phan_cong').value = currentUser ? currentUser.username : '';
            document.getElementById('chuc_danh').value = 'Kiểm sát viên trung cấp';
            document.getElementById('chuyen_den').value = '';
            document.getElementById('ngay_chuyen_don').value = '';
            document.getElementById('noi_dung').value = '';
            document.getElementById('de_xuat').value = '';
            document.getElementById('ket_qua').value = '';
            document.getElementById('edit-id').value = '';
            document.getElementById('can_cu_container').innerHTML = '';
            addCanCu();
            currentSelectedId = null; // Clear selected ID
        }

        function saveDon() {
            if (!currentUser) {
                alert('Vui lòng đăng nhập để lưu đơn.');
                return;
            }
            if (!document.getElementById('ho_ten').value || !document.getElementById('noi_dung').value) {
                 alert('Vui lòng nhập Họ tên và Nội dung đơn.');
                 return;
            }

            const id = document.getElementById('edit-id').value;
            const don = {
                ngay_nhan: document.getElementById('ngay_nhan').value,
                nguon_don: document.getElementById('nguon_don').value,
                ho_ten: document.getElementById('ho_ten').value,
                dia_chi: document.getElementById('dia_chi').value,
                ngay_ghi: document.getElementById('ngay_ghi').value,
                phan_loai: document.getElementById('phan_loai').value,
                tham_quyen: document.getElementById('tham_quyen').value,
                can_bo_phan_cong: document.getElementById('can_bo_phan_cong').value,
                chuc_danh: document.getElementById('chuc_danh').value,
                chuyen_den: document.getElementById('chuyen_den').value,
                ngay_chuyen_don: document.getElementById('ngay_chuyen_don').value,
                can_cu: getCanCuData(),
                noi_dung: document.getElementById('noi_dung').value,
                de_xuat: document.getElementById('de_xuat').value,
                ket_qua: document.getElementById('ket_qua').value,
                lastUpdatedBy: currentUser.username,
                lastUpdated: new Date().toISOString(),
                // Lưu thêm đơn vị và vai trò người tạo để tiện cho việc lọc sau này
                createdByUnit: currentUser.unit, 
                createdByRole: currentUser.role
            };

            const ref = id ? database.ref('dons/' + id) : database.ref('dons').push();

            ref.set(don)
                .then(() => {
                    alert(id ? 'Cập nhật đơn thành công!' : 'Lưu đơn thành công!');
                    clearForm();
                    updateTable();
                })
                .catch(error => {
                    alert('Lỗi khi lưu đơn: ' + error.message);
                });
        }
        
        function populateForm(don) {
            document.getElementById('ngay_nhan').value = don.ngay_nhan || '';
            document.getElementById('nguon_don').value = don.nguon_don || '';
            document.getElementById('ho_ten').value = don.ho_ten || '';
            document.getElementById('dia_chi').value = don.dia_chi || '';
            document.getElementById('ngay_ghi').value = don.ngay_ghi || '';
            document.getElementById('phan_loai').value = don.phan_loai || '';
            document.getElementById('tham_quyen').value = don.tham_quyen || '';
            document.getElementById('can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('chuc_danh').value = don.chuc_danh || '';
            document.getElementById('chuyen_den').value = don.chuyen_den || '';
            document.getElementById('ngay_chuyen_don').value = don.ngay_chuyen_don || '';
            document.getElementById('noi_dung').value = don.noi_dung || '';
            document.getElementById('de_xuat').value = don.de_xuat || '';
            document.getElementById('ket_qua').value = don.ket_qua || '';
            document.getElementById('edit-id').value = don.id;
            
            // Cập nhật căn cứ
            populateCanCuFields(don.can_cu, '');
            
            // Cuộn lên đầu sidebar
            document.querySelector('.sidebar').scrollTop = 0;
        }

        function populateEditModal(don) {
            document.getElementById('sua-ngay_nhan').value = don.ngay_nhan || '';
            document.getElementById('sua-nguon_don').value = don.nguon_don || '';
            document.getElementById('sua-ho_ten').value = don.ho_ten || '';
            document.getElementById('sua-dia_chi').value = don.dia_chi || '';
            document.getElementById('sua-ngay_ghi').value = don.ngay_ghi || '';
            document.getElementById('sua-phan_loai').value = don.phan_loai || '';
            document.getElementById('sua-tham_quyen').value = don.tham_quyen || '';
            document.getElementById('sua-can_bo_phan_cong').value = don.can_bo_phan_cong || '';
            document.getElementById('sua-chuc_danh').value = don.chuc_danh || '';
            document.getElementById('sua-chuyen_den').value = don.chuyen_den || '';
            document.getElementById('sua-ngay_chuyen_don').value = don.ngay_chuyen_don || '';
            document.getElementById('sua-noi_dung').value = don.noi_dung || '';
            document.getElementById('sua-de_xuat').value = don.de_xuat || '';
            document.getElementById('sua-ket_qua').value = don.ket_qua || '';
            document.getElementById('edit-id-modal').value = don.id; 
            
            // Cập nhật căn cứ
            populateCanCuFields(don.can_cu, 'sua-');

            document.getElementById('editModal').style.display = 'flex';
        }
        
        function updateDon() {
             const id = document.getElementById('edit-id-modal').value;
             if (!id) return alert('Không tìm thấy ID đơn để cập nhật.');
             
             if (!document.getElementById('sua-ho_ten').value || !document.getElementById('sua-noi_dung').value) {
                 alert('Vui lòng nhập Họ tên và Nội dung đơn.');
                 return;
            }

            const don = {
                ngay_nhan: document.getElementById('sua-ngay_nhan').value,
                nguon_don: document.getElementById('sua-nguon_don').value,
                ho_ten: document.getElementById('sua-ho_ten').value,
                dia_chi: document.getElementById('sua-dia_chi').value,
                ngay_ghi: document.getElementById('sua-ngay_ghi').value,
                phan_loai: document.getElementById('sua-phan_loai').value,
                tham_quyen: document.getElementById('sua-tham_quyen').value,
                can_bo_phan_cong: document.getElementById('sua-can_bo_phan_cong').value,
                chuc_danh: document.getElementById('sua-chuc_danh').value,
                chuyen_den: document.getElementById('sua-chuyen_den').value,
                ngay_chuyen_don: document.getElementById('sua-ngay_chuyen_don').value,
                can_cu: getCanCuData('sua-'),
                noi_dung: document.getElementById('sua-noi_dung').value,
                de_xuat: document.getElementById('sua-de_xuat').value,
                ket_qua: document.getElementById('sua-ket_qua').value,
                lastUpdatedBy: currentUser.username,
                lastUpdated: new Date().toISOString()
                // Giữ nguyên createdByUnit và createdByRole
            };
            
            database.ref('dons/' + id).update(don)
                .then(() => {
                    alert('Cập nhật đơn thành công!');
                    document.getElementById('editModal').style.display = 'none';
                    updateTable();
                })
                .catch(error => {
                    alert('Lỗi khi cập nhật đơn: ' + error.message);
                });
        }
        
        function editDon(id) {
            const don = dons.find(d => d.id === id);
            if (don) {
                // Kiểm tra quyền chỉnh sửa
                if (canEditDelete(don)) {
                     // Nếu có quyền, mở modal sửa
                     populateEditModal(don);
                } else {
                     alert('Bạn không có quyền chỉnh sửa đơn này.');
                }
            } else {
                alert('Không tìm thấy đơn.');
            }
        }

        function deleteDon(id) {
            const don = dons.find(d => d.id === id);
             if (!don) return;
             
            if (!canEditDelete(don)) {
                 alert('Bạn không có quyền xóa đơn này.');
                 return;
            }
             
            if (confirm('Bạn có chắc chắn muốn xóa đơn này?')) {
                database.ref('dons/' + id).remove()
                    .then(() => {
                        alert('Đơn đã được xóa.');
                        updateTable();
                    })
                    .catch(error => {
                        alert('Lỗi khi xóa đơn: ' + error.message);
                    });
            }
        }
        
        /**
         * CHỈNH SỬA: Hàm kiểm tra quyền chỉnh sửa/xóa đơn
         * Chỉ cho phép sửa/xóa nếu:
         * 1. Là Admin (admin/super_admin).
         * 2. Là người tạo/cập nhật cuối cùng của đơn đó.
         */
        function canEditDelete(don) {
             if (!currentUser) return false;
             
             // 1. Admin/Super_admin có quyền tuyệt đối
             if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                 return true;
             }
             
             // 2. Các tài khoản khác chỉ được sửa đơn của chính mình đã tạo/cập nhật gần nhất
             return don.lastUpdatedBy === currentUser.username;
        }
        
        function capNhatThamQuyenMacDinh(prefix = '') {
            const phanLoai = document.getElementById(prefix + 'phan_loai').value;
            const thamQuyenSelect = document.getElementById(prefix + 'tham_quyen');
            
            if (phanLoai === 'Đề nghị KN, GĐT, TT' || phanLoai === 'Đề nghị kiểm tra QĐGQKN' || phanLoai === 'Tin báo/Tố giác tội phạm trong HĐTP') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền kiểm sát';
            } else if (phanLoai === 'Khiếu nại' || phanLoai === 'Tố cáo' || phanLoai === 'Yêu cầu bồi thường thiệt hại') {
                thamQuyenSelect.value = 'Thuộc thẩm quyền giải quyết';
            } else {
                thamQuyenSelect.value = 'Chọn';
            }
        }
        
        // --- CĂN CỨ FUNCTIONS (ĐÃ SỬA ĐỔI) ---

        function getVanBanOptions(selectedValue = '') {
            let options = '';
            vanBanList.forEach(item => {
                const selected = item === selectedValue ? 'selected' : '';
                options += `<option value="${item}" ${selected}>${item}</option>`;
            });
            return options;
        }
        
        function toggleCustomVanBan(selectId, containerId) {
            const select = document.getElementById(selectId);
            const container = document.getElementById(containerId);
            if (select.value === 'Tự điền vào văn bản') {
                container.style.display = 'flex'; // Hiện input khi chọn Tự điền
            } else {
                container.style.display = 'none';
            }
        }
        
        function addCanCu(prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            
            // Tìm index lớn nhất để đảm bảo ID là duy nhất
            let maxIndex = -1;
            const rowElements = Array.from(container.querySelectorAll('.can-cu-row'));
            rowElements.forEach(row => {
                 const match = row.id.match(/_(\d+)$/);
                 if (match) {
                     const index = parseInt(match[1]);
                     if (index > maxIndex) {
                         maxIndex = index;
                     }
                 }
            });
            const newIndex = maxIndex + 1;
            
            // 1. Tạo container cho toàn bộ hàng (bao gồm input tùy chọn)
            const rowDiv = document.createElement('div');
            rowDiv.className = 'can-cu-row';
            rowDiv.id = prefix + 'can_cu_row_' + newIndex; 
            
            // 2. Main line (Điểm, Khoản, Điều, Văn bản, Button)
            const mainDiv = document.createElement('div');
            mainDiv.className = 'can-cu-item';
            mainDiv.id = prefix + 'can_cu_item_' + newIndex;
            mainDiv.innerHTML = `
                <input type="text" id="${prefix}diem_${newIndex}" placeholder="Điểm">
                <input type="text" id="${prefix}khoan_${newIndex}" placeholder="Khoản">
                <input type="text" id="${prefix}dieu_${newIndex}" placeholder="Điều">
                <select id="${prefix}van_ban_${newIndex}" onchange="toggleCustomVanBan('${prefix}van_ban_${newIndex}', '${prefix}van_ban_khac_container_${newIndex}')">
                    ${getVanBanOptions()}
                </select>
                <button class="delete-btn" onclick="removeCanCu('${prefix}can_cu_row_${newIndex}')">Xóa</button>
            `;
            
            // 3. Custom text line (Tự điền Văn bản khác)
            const customDiv = document.createElement('div');
            customDiv.id = prefix + 'van_ban_khac_container_' + newIndex;
            customDiv.className = 'can-cu-sub-item form-group'; 
            customDiv.innerHTML = `
                 <label for="${prefix}van_ban_khac_${newIndex}" style="font-weight: normal; margin-top: 5px;">Tên Văn bản khác:</label>
                 <input type="text" id="${prefix}van_ban_khac_${newIndex}" placeholder="Nhập tên Văn bản khác (Tự điền)">
            `;
            
            rowDiv.appendChild(mainDiv);
            rowDiv.appendChild(customDiv);
            container.appendChild(rowDiv);
        }

        function removeCanCu(id) {
            // Xóa toàn bộ row container
            const element = document.getElementById(id);
            if (element) {
                element.remove();
            }
        }
        
        function getCanCuData(prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            const canCuList = [];
            
            // Lấy tất cả các 'can-cu-row' elements
            const rowElements = Array.from(container.querySelectorAll('.can-cu-row'));

            rowElements.forEach(row => {
                // Lấy index từ ID của row
                const match = row.id.match(/_(\d+)$/);
                if (!match) return;
                const index = match[1];
                
                // Lấy giá trị các trường
                const diem = document.getElementById(`${prefix}diem_${index}`)?.value.trim() || '';
                const khoan = document.getElementById(`${prefix}khoan_${index}`)?.value.trim() || '';
                const dieu = document.getElementById(`${prefix}dieu_${index}`)?.value.trim() || '';
                const van_ban_select = document.getElementById(`${prefix}van_ban_${index}`)?.value || '';
                const van_ban_khac = document.getElementById(`${prefix}van_ban_khac_${index}`)?.value.trim() || '';
                
                // Xác định Văn bản cuối cùng
                let van_ban = van_ban_select;
                if (van_ban_select === 'Tự điền vào văn bản') {
                    van_ban = van_ban_khac;
                }
                
                // Chỉ lưu nếu có ít nhất một trường dữ liệu quan trọng
                if (diem || khoan || dieu || van_ban) {
                    canCuList.push({ 
                        diem: diem, 
                        khoan: khoan, 
                        dieu: dieu, 
                        van_ban: van_ban 
                    });
                }
            });

            return canCuList;
        }


        function populateCanCuFields(canCuData, prefix = '') {
            const container = document.getElementById(prefix + 'can_cu_container');
            container.innerHTML = '';
            
            if (canCuData && canCuData.length > 0) {
                canCuData.forEach((item, index) => {
                    // Xác định giá trị Văn bản hiển thị trên select và input tùy chọn
                    let selectedVanBan = item.van_ban;
                    let customVanBanValue = '';
                    let isCustom = false;
                    
                    if (!vanBanList.includes(item.van_ban)) {
                        selectedVanBan = 'Tự điền vào văn bản'; // Chọn option Tự điền
                        customVanBanValue = item.van_ban; // Đưa giá trị thực vào input tùy chọn
                        isCustom = true;
                    }
                    
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'can-cu-row';
                    rowDiv.id = prefix + 'can_cu_row_' + index;
                    
                    // 1. Main line
                    const mainDiv = document.createElement('div');
                    mainDiv.className = 'can-cu-item';
                    mainDiv.id = prefix + 'can_cu_item_' + index;
                    mainDiv.innerHTML = `
                        <input type="text" id="${prefix}diem_${index}" placeholder="Điểm" value="${item.diem || ''}">
                        <input type="text" id="${prefix}khoan_${index}" placeholder="Khoản" value="${item.khoan || ''}">
                        <input type="text" id="${prefix}dieu_${index}" placeholder="Điều" value="${item.dieu || ''}">
                        <select id="${prefix}van_ban_${index}" onchange="toggleCustomVanBan('${prefix}van_ban_${index}', '${prefix}van_ban_khac_container_${index}')">
                            ${getVanBanOptions(selectedVanBan)}
                        </select>
                        <button class="delete-btn" onclick="removeCanCu('${prefix}can_cu_row_${index}')">Xóa</button>
                    `;
                    
                    // 2. Custom text line
                    const customDiv = document.createElement('div');
                    customDiv.id = prefix + 'van_ban_khac_container_' + index;
                    customDiv.className = 'can-cu-sub-item form-group';
                    customDiv.style.display = isCustom ? 'flex' : 'none'; // Set display
                    customDiv.innerHTML = `
                         <label for="${prefix}van_ban_khac_${index}" style="font-weight: normal; margin-top: 5px;">Tên Văn bản khác:</label>
                         <input type="text" id="${prefix}van_ban_khac_${index}" placeholder="Nhập tên Văn bản khác (Tự điền)" value="${customVanBanValue}">
                    `;

                    rowDiv.appendChild(mainDiv);
                    rowDiv.appendChild(customDiv);
                    container.appendChild(rowDiv);
                });
            } 
            addCanCu(prefix); // Luôn thêm một dòng trống
        }


        // --- FIREBASE LISTENERS ---
        database.ref('dons').on('value', (snapshot) => {
            const donObj = snapshot.val();
            dons = [];
            for (let key in donObj) {
                // Gán id trực tiếp vào object để dễ thao tác
                dons.push({ id: key, ...donObj[key] });
            }
            // Chỉ cập nhật bảng nếu người dùng đã đăng nhập
            if (currentUser) {
                updateTable();
            }
        });
        
        // --- DATA DISPLAY AND FILTERING ---
        
        /**
         * Hàm kích hoạt tìm kiếm
         */
        function filterTable() {
            updateTable();
        }

        /**
         * Hàm xóa bộ lọc tìm kiếm
         */
        function resetFilter() {
            document.getElementById('search-text').value = '';
            document.getElementById('search-date').value = '';
            updateTable();
        }

        /**
         * CHỈNH SỬA: Hàm cập nhật bảng, bao gồm cả logic lọc theo quyền hạn VÀ logic lọc theo ô tìm kiếm
         */
        function updateTable() {
            if (!currentUser) return;

            // 1. Lấy giá trị từ ô tìm kiếm
            const searchText = document.getElementById('search-text').value.toLowerCase().trim();
            const searchDate = document.getElementById('search-date').value;
            
            // 2. Lọc dữ liệu theo Đơn vị và Quyền hạn của người dùng (Logic bảo mật)
            let currentFilteredDons = dons.filter(don => {
                const donUnit = don.createdByUnit; // Đơn vị tạo đơn
                const donCreator = don.lastUpdatedBy; // Người tạo/cập nhật cuối cùng

                switch (currentUser.role) {
                    case 'admin':
                    case 'super_admin':
                    case 'manager_TP':
                        // Admin và Lãnh đạo TP thấy tất cả
                        return true;
                    
                    case 'user_TP':
                        // Cán bộ TP chỉ thấy đơn mình tạo
                        return donCreator === currentUser.username;
                        
                    case 'manager_KV':
                        // Lãnh đạo KV chỉ thấy đơn của đơn vị mình
                        return donUnit === currentUser.unit;

                    case 'user_KV':
                        // Cán bộ KV chỉ thấy đơn mình tạo
                        return donCreator === currentUser.username;

                    default:
                        return false;
                }
            });


            // 3. Áp dụng bộ lọc tìm kiếm (Họ tên/Cơ quan/Tổ chức và Ngày nhận đơn)
            const finalFilteredDons = currentFilteredDons.filter(don => {
                let textMatch = true;
                let dateMatch = true;

                // Lọc theo Họ tên/Cơ quan/Tổ chức (ho_ten)
                if (searchText) {
                    textMatch = don.ho_ten && don.ho_ten.toLowerCase().includes(searchText);
                }

                // Lọc theo Ngày nhận đơn (ngay_nhan)
                if (searchDate) {
                    dateMatch = don.ngay_nhan === searchDate;
                }

                return textMatch && dateMatch;
            });

            // 4. Render table
            const body = document.getElementById('don-body');
            body.innerHTML = '';

            finalFilteredDons.sort((a, b) => new Date(b.ngay_nhan) - new Date(a.ngay_nhan));

            finalFilteredDons.forEach((don, index) => {
                const row = body.insertRow();
                // Đảm bảo số thứ tự được tính trên danh sách đã lọc
                row.insertCell().textContent = index + 1;
                // Ngày nhận đơn
                row.insertCell().textContent = don.ngay_nhan || '';
                // Họ tên /CQ/ TC
                row.insertCell().textContent = don.ho_ten || '';
                // Nội dung đơn (hiển thị tóm tắt)
                const noiDungCell = row.insertCell();
                noiDungCell.textContent = (don.noi_dung || '').substring(0, 50) + '...';
                // Phân loại
                row.insertCell().textContent = don.phan_loai || '';
                // Thẩm quyền
                row.insertCell().textContent = don.tham_quyen || '';
                // Xử lý đơn (Kết quả)
                const ketQuaCell = row.insertCell();
                ketQuaCell.textContent = (don.ket_qua || '').substring(0, 50) + '...';

                // Thao tác
                const actionsCell = row.insertCell();
                actionsCell.classList.add('table-actions');
                
                // Quyền sửa/xóa - Giao diện không disable, chỉ kiểm tra khi click
                const canModify = canEditDelete(don); 
                
                actionsCell.innerHTML = `
                    <button class="edit-btn" onclick="editDon('${don.id}')">Sửa</button>
                    <button class="delete-btn" onclick="deleteDon('${don.id}')">Xóa</button>
                    <button class="proposal-print-btn" onclick="showProposalModal('${don.id}')">Đề xuất/Xử lý</button>
                `;

                // Lưu ID cho thao tác trích xuất và highlight hàng (nếu muốn)
                row.onclick = () => {
                    // Xóa highlight của các hàng khác
                    Array.from(body.children).forEach(r => r.style.backgroundColor = '');
                    // Highlight hàng hiện tại
                    row.style.backgroundColor = '#d1e7dd'; 
                    currentSelectedId = don.id;
                };
            });
            
             // Xóa currentSelectedId nếu bảng rỗng
            if (finalFilteredDons.length === 0) {
                 currentSelectedId = null;
            }
        }
        
        function showProposalModal(id) {
            if (!id) {
                alert('Vui lòng chọn một đơn trong danh sách (click vào hàng) để xem đề xuất/xử lý.');
                return;
            }
            currentSelectedId = id; // Đảm bảo ID được cập nhật cho nút export
            const don = dons.find(d => d.id === id);
            if (!don) return alert('Không tìm thấy đơn.');

            const proposalContent = generateProposalContent(don);
            document.getElementById('proposal-content').textContent = proposalContent;
            document.getElementById('proposalModal').style.display = 'flex';
        }

        // --- EXPORT/REPORTING FUNCTIONS ---

        function exportList() {
             // Lọc dữ liệu theo Đơn vị và Quyền hạn của người dùng (sử dụng logic lọc của updateTable)
             
            // 1. Lấy giá trị từ ô tìm kiếm
            const searchText = document.getElementById('search-text').value.toLowerCase().trim();
            const searchDate = document.getElementById('search-date').value;
             
             // 2. Lọc dữ liệu theo Quyền hạn của người dùng (Logic bảo mật)
            let currentFilteredDons = dons.filter(don => {
                const donUnit = don.createdByUnit;
                const donCreator = don.lastUpdatedBy;

                switch (currentUser.role) {
                    case 'admin':
                    case 'super_admin':
                    case 'manager_TP':
                        return true;
                    
                    case 'user_TP':
                    case 'user_KV':
                        return donCreator === currentUser.username;
                        
                    case 'manager_KV':
                        return donUnit === currentUser.unit;

                    default:
                        return false;
                }
            });
            
            // 3. Áp dụng bộ lọc tìm kiếm
            const finalFilteredDons = currentFilteredDons.filter(don => {
                let textMatch = true;
                let dateMatch = true;

                if (searchText) {
                    textMatch = don.ho_ten && don.ho_ten.toLowerCase().includes(searchText);
                }
                if (searchDate) {
                    dateMatch = don.ngay_nhan === searchDate;
                }
                return textMatch && dateMatch;
            });
            
            finalFilteredDons.sort((a, b) => new Date(b.ngay_nhan) - new Date(a.ngay_nhan));
            
            if (finalFilteredDons.length === 0) {
                 alert('Không có đơn nào trong danh sách hiện tại để xuất.');
                 return;
            }

            const dataToExport = finalFilteredDons.map((don, index) => {
                 // Format căn cứ mới cho Excel
                 const canCuText = don.can_cu ? don.can_cu.map(c => {
                     const parts = [
                         c.diem ? `Điểm ${c.diem}` : '',
                         c.khoan ? `Khoản ${c.khoan}` : '',
                         c.dieu ? `Điều ${c.dieu}` : ''
                     ].filter(Boolean).join(', ');
                     return `${parts} (${c.van_ban || 'Không rõ VB'})`;
                 }).join('; ') : '';
                 
                return {
                    'STT': index + 1,
                    'Ngày nhận đơn': don.ngay_nhan || '',
                    'Nguồn đơn': don.nguon_don || '',
                    'Họ tên/CQ/TC': don.ho_ten || '',
                    'Địa chỉ': don.dia_chi || '',
                    'Đơn ghi ngày': don.ngay_ghi || '',
                    'Phân loại': don.phan_loai || '',
                    'Thẩm quyền': don.tham_quyen || '',
                    'Cán bộ phân công': don.can_bo_phan_cong || '',
                    'Chức danh': don.chuc_danh || '',
                    'Chuyển đến': don.chuyen_den || '',
                    'Ngày chuyển đơn': don.ngay_chuyen_don || '',
                    'Nội dung đơn': don.noi_dung || '',
                    'Căn cứ': canCuText, // Cập nhật Căn cứ
                    'Đề xuất': don.de_xuat || '',
                    'Kết quả': don.ket_qua || '',
                    'Người cập nhật cuối': don.lastUpdatedBy || '',
                    'Đơn vị tạo đơn': don.createdByUnit || '', 
                    'Thời gian cập nhật': don.lastUpdated ? new Date(don.lastUpdated).toLocaleString('vi-VN') : ''
                };
            });

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "DanhSachDon");

            // Xuất file
            XLSX.writeFile(workbook, "Danh_sach_don_to_cao_khieu_nai.xlsx");
        }

        function exportReport() {
            // ... (Original logic for exporting report - GIỮ NGUYÊN) ...
            alert('Chức năng xuất báo cáo đang được phát triển.');
        }
        
        function downloadJSON() {
            // ... (Original logic for backing up JSON - GIỮ NGUYÊN) ...
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dons, null, 4));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "quanlydon_backup_" + new Date().toISOString().slice(0, 10) + ".json");
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        /**
         * Hàm tạo nội dung đề xuất (chỉ dùng cho mục đích xem trước)
         */
        function generateProposalContent(don) {
            let content = `VIỆN KIỂM SÁT NHÂN DÂN THÀNH PHỐ CẦN THƠ\n\n`;
            content += `ĐƠN VỊ XỬ LÝ: ${don.createdByUnit || 'Không rõ'}\n`;
            content += `NGƯỜI LẬP: ${don.can_bo_phan_cong || don.lastUpdatedBy || 'Không rõ'}\n`;
            content += `CHỨC DANH: ${don.chuc_danh || 'Không rõ'}\n`;
            content += `-----------------------------------------------------------\n\n`;
            
            content += `V/v: Xử lý đơn ${don.phan_loai || 'Không rõ loại'} của ${don.ho_ten || 'Không rõ tên'}\n`;
            content += `Địa chỉ: ${don.dia_chi || 'Không rõ'}\n`;
            content += `Ngày nhận đơn: ${don.ngay_nhan || 'Không rõ'}\n`;
            content += `Nguồn đơn: ${don.nguon_don || 'Không rõ'}\n\n`;
            
            content += `NỘI DUNG TÓM TẮT:\n${don.noi_dung || 'Chưa có nội dung'}\n\n`;

            if (don.can_cu && don.can_cu.length > 0) {
                 content += `CĂN CỨ:\n`;
                 don.can_cu.forEach((cc, idx) => {
                     const parts = [
                         cc.diem ? `Điểm ${cc.diem}` : '',
                         cc.khoan ? `Khoản ${cc.khoan}` : '',
                         cc.dieu ? `Điều ${cc.dieu}` : ''
                     ].filter(Boolean).join(', ');
                     
                     const partText = parts ? `Căn cứ ${parts}` : 'Căn cứ';
                     
                     content += `${idx + 1}. ${partText} ${cc.van_ban ? `của ${cc.van_ban}` : ''}\n`;
                 });
                 content += '\n';
            }
            
            content += `ĐỀ XUẤT XỬ LÝ:\n${don.de_xuat || 'Chưa có đề xuất'}\n\n`;
            content += `KẾT QUẢ XỬ LÝ (Nếu đã có):\n${don.ket_qua || 'Chưa có kết quả'}\n\n`;
            
            content += `CHUYỂN ĐẾN: ${don.chuyen_den || 'Không rõ'}\n`;
            content += `Ngày chuyển đơn: ${don.ngay_chuyen_don || 'Không rõ'}\n`;
            
            return content;
        }
        
        /**
         * HÀM CHÍNH: Tạo file Word (.doc) theo Mẫu số 07/KT với định dạng chuẩn (ĐÃ SỬA PHẦN CĂN CỨ)
         */
        function downloadResolutionResultDoc(id) {
             if (!id) {
                alert('Vui lòng chọn một đơn trong danh sách (click vào hàng) để trích xuất.');
                return;
            }
            
            const don = dons.find(d => d.id === id);
            if (!don) return alert('Không tìm thấy đơn.');
            
            // --- XỬ LÝ DỮ LIỆU ĐƠN ---
            const now = new Date();
            const year = now.getFullYear();
            
            // Format ngày nhận đơn
            let ngayNhanText = don.ngay_nhan || '...';
            if (ngayNhanText !== '...') {
                 const [y, m, d] = ngayNhanText.split('-');
                 ngayNhanText = `${d}/${m}/${y}`;
            }
            
            // Format ngày ghi đơn
            let ngayGhiText = don.ngay_ghi || '...';
            if (ngayGhiText !== '...') {
                 const [y, m, d] = ngayGhiText.split('-');
                 ngayGhiText = `${d}/${m}/${y}`;
            }
            
            // Format căn cứ (NEW STRUCTURE)
            let canCuText = '';
            if (don.can_cu && don.can_cu.length > 0) {
                don.can_cu.forEach((cc) => {
                    const parts = [
                        cc.diem ? `Điểm ${cc.diem}` : '',
                        cc.khoan ? `Khoản ${cc.khoan}` : '',
                        cc.dieu ? `Điều ${cc.dieu}` : ''
                    ].filter(Boolean).join(', ');
                    
                    const partText = parts ? `${parts}` : 'Quy định';
                    const vanBanText = cc.van_ban || 'Văn bản...';
                    
                    // Thêm khoảng cách đầu dòng và dấu chấm
                    canCuText += `&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;- ${partText} của ${vanBanText}.<br>`;
                });
            }
            
            // Định dạng ngày/tháng/năm
            function formatDate(isoDate) {
                if (!isoDate) return '...';
                const [y, m, d] = isoDate.split('-');
                return `${d} tháng ${m} năm ${y}`;
            }

            // --- CẤU TRÚC HTML CHO FILE WORD ---
            const htmlContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset="utf-8">
                        <title>Phiếu Đề Xuất Xử Lý Đơn</title>
                        <style>
                            /* --- ĐỊNH DẠNG CHUNG (Áp dụng cho A4, Times New Roman 14) --- */
                            @page
                            {
                                size: A4; 
                                margin: 2.0cm 1.5cm 2.0cm 3.0cm; /* Trên, Phải, Dưới, Trái */
                                mso-header-margin: 1.0cm; 
                                mso-footer-margin: 1.0cm;
                                mso-page-orientation: portrait;
                            }
                            
                            body
                            {
                                font-family: 'Times New Roman', serif; 
                                font-size: 14pt; 
                                margin: 0; 
                                padding: 0;
                            }
                            
                            p
                            {
                                font-family: 'Times New Roman', serif;
                                font-size: 14pt;
                                margin: 0;
                                padding: 0;
                                line-height: 1.3; /* Giãn dòng 1.3pt */
                                text-align: justify;
                            }

                            /* --- ĐỊNH DẠNG ĐẶC BIỆT --- */
                            .center { text-align: center; }
                            .right { text-align: right; }
                            .bold { font-weight: bold; }
                            .uppercase { text-transform: uppercase; }
                            .indent { text-indent: 1cm; } /* Đầu dòng cách lề 1cm */
                            .no-indent { text-indent: 0; }
                            .single-line { line-height: 1.0; }
                            .margin-top { margin-top: 10pt; }
                        </style>
                    </head>
                    <body>
                    
                        <p class="right single-line bold">
                            Mẫu số 07/KT <br>
                            <span style="font-style: italic;">(Theo QĐ số 28/QĐ-VKSTC ngày 15/02/2023)</span>
                        </p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15pt;">
                            <tr>
                                <td style="width: 50%; text-align: center; border: none;">
                                    <p class="bold uppercase single-line">VIỆN KIỂM SÁT NHÂN DÂN</p>
                                    <p class="bold uppercase single-line">THÀNH PHỐ CẦN THƠ</p>
                                    <p class="bold uppercase single-line"><u>THANH TRA - KHIẾU TỐ</u></p>
                                </td>
                                <td style="width: 50%; text-align: center; border: none;">
                                    <p class="bold uppercase single-line">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</p>
                                    <p class="bold single-line"><u>Độc lập - Tự do - Hạnh phúc</u></p>
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 50%; border: none;"></td>
                                <td style="width: 50%; text-align: center; border: none; font-style: italic; padding-top: 10pt;">
                                    <p>Cần Thơ, ngày ... tháng ... năm ${year}</p>
                                </td>
                            </tr>
                        </table>
                        
                        <p class="no-indent bold center uppercase margin-top">PHIẾU ĐỀ XUẤT XỬ LÝ ĐƠN</p>
                        <p class="no-indent bold margin-top">Kính gửi:</p>
                        <p class="no-indent">
                            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;- Lãnh đạo Viện;<br>
                            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;- Lãnh đạo Thanh tra - Khiếu tố.
                        </p>

                        <p class="indent margin-top">
                            Tôi tên: <span class="bold">${don.can_bo_phan_cong || '..................'}</span>, chức danh: <span class="bold">${don.chuc_danh || '..................'}</span>;
                        </p>
                        <p class="indent">
                            Được phân công nghiên cứu, đề xuất xử lý đối với đơn của <span class="bold">${don.ho_ten || '..................'}</span>, địa chỉ: <span class="bold">${don.dia_chi || '..................'}</span>, ghi ngày ${ngayGhiText} (Viện kiểm sát nhân dân thành phố Cần Thơ nhận đơn ngày ${ngayNhanText} do ${don.nguon_don || '..................'} chuyển đến).
                        </p>
                        <p class="indent">
                            Nội dung đơn: <span class="bold">${don.noi_dung || '..................'}</span>.
                        </p>
                        
                        <p class="indent">
                            Theo quy định tại điểm ... Khoản ... Điều ... Quy chế tiếp công dân, giải quyết khiếu nại, tố cáo và kiểm sát việc giải quyết khiếu nại, tố cáo trong hoạt động tư pháp (ban hành kèm theo Quyết định số: 222/QĐ-VKSTC ngày 22/6/2023), Đơn nêu trên thuộc <span class="bold">${don.tham_quyen || '..................'}</span>.
                        </p>
                        
                        <p class="no-indent margin-top">
                           <span class="indent">Căn cứ:</span><br>
                           ${canCuText || '&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;..................................................................'}
                        </p>
                        
                        <p class="indent margin-top">
                            Tôi xin đề xuất: <span class="bold">${don.de_xuat || '..................'}</span>./.
                        </p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 30pt;">
                            <tr>
                                <td style="width: 40%; text-align: center; border: none;">
                                    <p class="bold center single-line">Phê duyệt của Lãnh đạo Viện</p>
                                    <p class="bold center uppercase single-line">VIỆN TRƯỞNG</p>
                                    <p class="bold center" style="margin-top: 50pt;">Nguyễn Thanh Liêm</p>
                                </td>
                                <td style="width: 30%; text-align: center; border: none;">
                                    <p class="bold center single-line">Lãnh đạo đơn vị đề xuất</p>
                                    <p class="bold center uppercase single-line">PHÓ CHÁNH THANH TRA</p>
                                    <p class="bold center" style="margin-top: 50pt;">..................</p>
                                </td>
                                <td style="width: 30%; text-align: center; border: none;">
                                     <p class="bold center single-line">Ngày ... tháng ... năm ${year}</p>
                                     <p class="bold center single-line">Người đề xuất</p>
                                     <p class="bold center" style="margin-top: 50pt;">${don.can_bo_phan_cong || '..................'}</p>
                                </td>
                            </tr>
                        </table>
                        
                    </body>
                </html>
            `;
            
            const filename = `Trích_xuất_xử_lý_đơn_${(don.ho_ten || 'don_thu').replace(/\s/g, '_')}_${don.ngay_nhan}.doc`;
            
            // Dùng Blob và saveAs để lưu file
            const blob = new Blob(['\ufeff', htmlContent], {
                type: 'application/msword'
            });

            saveAs(blob, filename);
        }

        
        // --- INITIALIZATION ---
        
        function init() {
            initializeDefaultAccounts(); 
            initSelectOptions();
            document.getElementById("ngay_nhan").value = new Date().toISOString().slice(0, 10);
            document.getElementById('new-role').onchange = capNhatDonViTheoVaiTro;
            capNhatDonViTheoVaiTro();
            // Khởi tạo Căn cứ với cấu trúc mới
            document.getElementById('can_cu_container').innerHTML = '';
            document.getElementById('sua-can_cu_container').innerHTML = '';
            populateCanCuFields([], '');
            populateCanCuFields([], 'sua-');
            
            setupEnterKeyListener(); 
            
            const accountBtn = document.getElementById('account-btn');
            if (accountBtn) {
                accountBtn.style.display = 'none'; // Ẩn nút quản lý TK khi chưa đăng nhập
            }
        }
        
        function setupEnterKeyListener() {
             // 1. Thêm sự kiện nhấn Enter cho ô Đăng nhập
             const passwordInput = document.getElementById('password');
             if (passwordInput) {
                passwordInput.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        // Ngăn chặn hành vi mặc định (như gửi form nếu là form)
                        event.preventDefault(); 
                        login();
                    }
                });
             }
             
             // 2. Thêm sự kiện nhấn Enter cho ô Tìm kiếm
             const searchText = document.getElementById('search-text');
             if (searchText) {
                 searchText.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        filterTable();
                    }
                 });
             }
             
             // 3. Thêm sự kiện thay đổi cho ô ngày tìm kiếm (Giữ nguyên)
             const searchDate = document.getElementById('search-date');
             if (searchDate) {
                 searchDate.addEventListener('change', function(event) {
                    filterTable();
                 });
             }
        }
        
        function initSelectOptions() {
            // Hàm khởi tạo các dropdown list
            function populateSelect(id, data) {
                const select = document.getElementById(id);
                if (!select) return;
                select.innerHTML = '';
                 // Thêm tùy chọn mặc định (nếu cần)
                if (id === 'phan_loai' || id === 'sua-phan_loai') {
                    // Phân loại đã được thêm sẵn trong HTML
                } else if (id === 'tham_quyen' || id === 'sua-tham_quyen') {
                    // Thẩm quyền đã được thêm sẵn trong HTML
                } else if (id === 'chuc_danh' || id === 'sua-chuc_danh') {
                    // Chức danh đã được thêm sẵn trong HTML
                } else {
                     let defaultOption = document.createElement('option');
                     defaultOption.value = '';
                     defaultOption.textContent = '--Chọn--';
                     select.appendChild(defaultOption);
                }

                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    select.appendChild(option);
                });
            }

            populateSelect('nguon_don', lookupData['Nguồn đơn']);
            populateSelect('chuyen_den', lookupData['Chuyển đến']);
            populateSelect('sua-nguon_don', lookupData['Nguồn đơn']);
            populateSelect('sua-chuyen_den', lookupData['Chuyển đến']);
            // Đơn vị chỉ dùng cho tạo tài khoản mới, được populate trong capNhatDonViTheoVaiTro()
        }
        
        // Tạo Modal Proposal (Đề xuất/Xử lý)
        function createProposalModal() {
            const modal = document.createElement('div');
            modal.id = 'proposalModal';
            modal.className = 'modal';
             // Lấy nội dung từ HTML bên ngoài để tránh bị mất
             const contentHtml = `
                <div class="modal-content large-modal">
                    <span class="close-btn" onclick="document.getElementById('proposalModal').style.display='none'">&times;</span>
                    <h3>Trích xuất Đề xuất/Xử lý đơn</h3>
                    <div style="border: 1px solid #ccc; padding: 15px; background-color: #f9f9f9; max-height: 70vh; overflow-y: auto;">
                        <pre id="proposal-content"></pre>
                    </div>
                    <div class="btn-container">
                        <button class="export-proposal-btn" onclick="downloadResolutionResultDoc(currentSelectedId)">Xuất File Word (.doc)</button>
                    </div>
                </div>
            `;
            modal.innerHTML = contentHtml;
            document.body.appendChild(modal);
        }
        
        // Gọi hàm khởi tạo khi trang tải xong
        document.addEventListener('DOMContentLoaded', () => {
             createProposalModal();
             init();
        });

    </script>
</body>
</html>
